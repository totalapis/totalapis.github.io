// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../geometry/Extent ../../geometry/Point ../../geometry/SpatialReference ../../geometry/support/WKIDUnitConversion ./TileInfo".split(" "),function(J,q,A,u,B,r,C){function l(a,d){return(a=d.getElementsByTagName(a))&&0<a.length?a[0]:null}function n(a,d){return Array.prototype.slice.call(d.getElementsByTagName(a)).map(function(a){return a.textContent})}function h(a,d){a.split("\x3e").forEach(function(a){d=l(a,d)});return d&&d.textContent}function p(a,d,b,f){var c;Array.prototype.slice.call(f.childNodes).some(function(f){if(-1<
f.nodeName.indexOf(a)){var e=l(d,f),e=e&&e.textContent;return e===b||b.split(":")&&b.split(":")[1]===e?(c=f,!0):!1}});return c}function v(a){var d=[],b=w[a],f=Array.prototype.slice.call(b.getElementsByTagName("ResourceURL")),b=b.getElementsByTagName("Dimension"),c,g,e,k;b.length&&(c=h("Identifier",b[0]),g=n("Default",b[0])||n("Value",b[0]));1<b.length&&(e=h("Identifier",b[1]),k=n("Default",b[1])||n("Value",b[1]));m[a]={dimensions:g,dimensions2:k};f.forEach(function(a){var b=a.getAttribute("template");
if(c&&g.length)if(-1<b.indexOf("{"+c+"}"))b=b.replace("{"+c+"}","{dimensionValue}");else{var f=b.toLowerCase().indexOf("{"+c.toLowerCase()+"}");-1<f&&(b=b.substring(0,f)+"{dimensionValue}"+b.substring(f+c.length+2))}e&&k.length&&(-1<b.indexOf("{"+e+"}")?b=b.replace("{"+e+"}","{dimensionValue2}"):(f=b.toLowerCase().indexOf("{"+e.toLowerCase()+"}"),-1<f&&(b=b.substring(0,f)+"{dimensionValue2}"+b.substring(f+e.length+2))));d.push({template:b,format:a.getAttribute("fomrat"),resourceType:a.getAttribute("resourceType")})});
return d}function E(a){return Array.prototype.slice.call(a.getElementsByTagName("Style")).map(function(a){var b=l("LegendURL",a),d=l("Keywords",a),d=d&&n("Keyword",d);return{abstract:h("Abstract",a),id:h("Identifier",a),isDefault:"true"===a.getAttribute("isDefault"),keywords:d,legendUrl:b&&b.getAttribute("xlink:href"),title:h("Title",a)}})}function F(a,d){return n("TileMatrixSet",a).map(function(b){return G(b,a,d)})}function G(a,d,b){d=p("TileMatrixSetLink","TileMatrixSet",a,d);d=n("TileMatrix",d);
var f=p("TileMatrixSet","Identifier",a,b);b=H(f);var c=b.spatialReference,g=c.wkid,e=l("TileMatrix",f),e=[parseInt(h("TileWidth",e),10),parseInt(h("TileHeight",e),10)],k=[];d.length?d.forEach(function(b,c){b=p("TileMatrix","Identifier",b,f);k.push(x(b,g,c,a))}):Array.prototype.slice.call(f.getElementsByTagName("TileMatrix")).forEach(function(b,c){k.push(x(b,g,c,a))});d=I(f,b,e,k[0]);return{id:a,fullExtent:d,tileInfo:new C({dpi:96,spatialReference:c,size:e,origin:b,lods:k})}}function H(a){var d=h("SupportedCRS",
a);d&&(d=d.toLowerCase());var b=parseInt(d.split(":").pop(),10);if(900913===b||3857===b)b=102100;var f=!1;if(-1<d.indexOf("crs84")||-1<d.indexOf("crs:84"))b=4326,f=!0;else if(-1<d.indexOf("crs83")||-1<d.indexOf("crs:83"))b=4269,f=!0;else if(-1<d.indexOf("crs27")||-1<d.indexOf("crs:27"))b=4267,f=!0;var c=new B({wkid:b});a=l("TileMatrix",a);var g=h("TopLeftCorner",a).split(" ");a=g[0].split("E").map(function(a){return Number(a)});var g=g[1].split("E").map(function(a){return Number(a)}),e=a[0],k=g[0],
t;1<a.length&&(e=a[0]*Math.pow(10,a[1]));1<g.length&&(k=g[0]*Math.pow(10,g[1]));var D=f&&4326===b&&90===e&&-180===k;y.some(function(a,g){var h=Number(d.split(":").pop());if(h>=a[0]&&h<=a[1]||4326===b&&(!f||D))return t=new u(k,e,c),!0;g===y.length-1&&(t=new u(e,k,c));return!1});return t}function I(a,d,b,f){var c=l("BoundingBox",a),g,e;c&&(g=h("LowerCorner",c).split(" "),e=h("UpperCorner",c).split(" "));g&&1<g.length&&e&&1<e.length?(a=parseFloat(g[0]),b=parseFloat(g[1]),g=parseFloat(e[0]),e=parseFloat(e[1])):
(a=l("TileMatrix",a),g=parseFloat(h("MatrixWidth",a)),c=parseFloat(h("MatrixHeight",a)),a=d.x,e=d.y,g=a+g*b[0]*f.resolution,b=e-c*b[1]*f.resolution);return new A(a,b,g,e,d.spatialReference)}function x(a,d,b,f){var c=h("Identifier",a);a=h("ScaleDenominator",a).split("E").map(function(a){return Number(a)});a=1<a.length?a[0]*Math.pow(10,a[1]):a[0];d=z(d,a,f);return{level:b,levelValue:c,scale:1.058267716535433*a,resolution:d}}function z(a,d,b){a=r.hasOwnProperty(String(a))?r.values[r[a]]:"default028mm"===
b?6370997*Math.PI/180:6378137*Math.PI/180;return 7*d/25E3/a}Object.defineProperty(q,"__esModule",{value:!0});var y=[[3819,3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,4558],[4600,4646],[4657,4765],[4801,4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,
5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],[5354,5354],[5360,5360],[5365,5365],[5370,5373],[5381,5381],[5393,5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,
3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3389,3390],[3416,3417],[3833,3841],[3844,3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,
28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],m=new Map,w=new Map;q.parseCapabilities=function(a,d){a=a.replace(/ows:/gi,"");a=(new DOMParser).parseFromString(a,"text/xml").documentElement;var b=l("Contents",a);if(b){var f=l("OperationsMetadata",a).querySelector("[name\x3d'GetTile']").getElementsByTagName("Get"),f=Array.prototype.slice.call(f),c=d.serviceMode,g,e,k;f.some(function(a){var b=l("Constraint",a);if(!b||p("AllowedValues","Value",
c,b))return e=a.attributes[0].nodeValue,!0;if(!b||p("AllowedValues","Value","RESTful",b))k=a.attributes[0].nodeValue;else if(!b||p("AllowedValues","Value","KVP",b))g=a.attributes[0].nodeValue;return!1});e||("KVP"===c&&k?(e=k,c="RESTful"):"RESTful"===c&&g&&(e=g,c="KVP"));-1===e.indexOf("/1.0.0/")&&"RESTful"===c&&(e+="/");"KVP"===c&&(e+=-1<e.indexOf("?")?"":"?");d=h("ServiceIdentification\x3eAccessConstraints",a);a=Array.prototype.slice.call(b.getElementsByTagName("Layer")).map(function(a){var c=h("Identifier",
a);w[c]=a;var d=h("Abstract",a),e=n("Format",a),f,g=l("WGS84BoundingBox",a);f=g?h("LowerCorner",g).split(" "):["-180","-90"];g=g?h("UpperCorner",g).split(" "):["180","90"];f={xmin:parseFloat(f[0]),ymin:parseFloat(f[1]),xmax:parseFloat(g[0]),ymax:parseFloat(g[1]),spatialReference:{wkid:4326}};var g=E(a),k=h("Title",a);a=F(a,b);return{id:c,fullExtent:f,description:d,formats:e,styles:g,title:k,tileMatrixSets:a}});return{copyright:d,layers:a,tileUrl:e,serviceMode:c}}console.error("The WMTS capabilities XML is not valid")};
q.parseResourceInfo=function(a){a.layers.forEach(function(a){a.tileMatrixSets.forEach(function(a){var b=a.tileInfo;96!==b.dpi&&(b.lods.forEach(function(c){c.scale=96*c.scale/b.dpi;c.resolution=z(b.spatialReference.wkid,90.71428571428571*c.scale/96,a.id)}),b.dpi=96)})});return a};q.getTileUrlFromResourceUrls=function(a,d,b,f,c,g){var e=v(a),h=m[a].dimensions&&m[a].dimensions[0];a=m[a].dimensions2&&m[a].dimensions2[0];var l="";e&&0<e.length&&(l=e[c%e.length].template.replace(/\{Style\}/gi,b).replace(/\{TileMatrixSet\}/gi,
d).replace(/\{TileMatrix\}/gi,f).replace(/\{TileRow\}/gi,c).replace(/\{TileCol\}/gi,g).replace(/\{dimensionValue\}/gi,h).replace(/\{dimensionValue2\}/gi,a));return l};q.getTileUrlTemplateFromResourceUrls=function(a,d,b,f){b=v(a);var c="";if(b&&0<b.length){var g=m[a].dimensions&&m[a].dimensions[0];a=m[a].dimensions2&&m[a].dimensions2[0];c=b[0].template;c.indexOf(".xxx")===c.length-4&&(c=c.slice(0,c.length-4));c=c.replace(/\{Style\}/gi,f);c=c.replace(/\{TileMatrixSet\}/gi,d);c=c.replace(/\{TileMatrix\}/gi,
"{level}");c=c.replace(/\{TileRow\}/gi,"{row}");c=c.replace(/\{TileCol\}/gi,"{col}");c=c.replace(/\{dimensionValue\}/gi,g);c=c.replace(/\{dimensionValue2\}/gi,a)}return c}});