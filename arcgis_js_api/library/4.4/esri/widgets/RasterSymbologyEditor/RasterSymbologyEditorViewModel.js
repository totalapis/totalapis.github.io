// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/accessorSupport/decorators ../../core/Accessor dojo/_base/lang ../../layers/support/RasterFunction ../../core/colorUtils ../../core/promiseUtils dojo/i18n!./nls/RasterSymbologyEditor".split(" "),function(f,A,v,q,r,w,x,l,t,y,z){f=g=function(f){function e(){var a=null!==f&&f.apply(this,arguments)||this;a.renderParameters={};a.stretchTypes=[{name:"none",filterType:0},{name:"minMax",filterType:5},
{name:"percentClip",filterType:6},{name:"standardDeviation",filterType:3}];a._cachedKeyProperties={};a._defaultRenderParameters={minPercent:2,maxPercent:2,discreteNColors:256,uniqueValuesColorRampId:"uniqueValueColorRamp_default",uniqueValueColorRampType:"multipart",colorRamp:"blackToWhite_predefined",numberOfStandardDeviations:2,gamma:1.1,dra:!0,uniqueValueField:"Value",selectedBand:0};return a}v(e,f);e.prototype.getSymbologyTypes=function(){var a=[g.SymbologyTypes.none,g.SymbologyTypes.stretch],
b=this.layer,c=b.bandCount,d=b.hasRasterAttributeTable,b=b.pixelType;3<=c&&a.push(g.SymbologyTypes.rgb);d&&1===c&&a.push(g.SymbologyTypes.uniqueValue);1===c&&b&&"u8"===b.toLowerCase()&&a.push(g.SymbologyTypes.discrete);return a};e.prototype.isStretchColorRampApplicable=function(a){return a!==this.getStretchFilterType(g.StretchTypeNames.none)||this.layer.pixelType&&"u8"===this.layer.pixelType.toLowerCase()};e.prototype.getStretchFilterType=function(a){var b=0;this.stretchTypes.some(function(c){if(c.name===
a)return b=c.filterType,!0});return b};e.prototype.getDefaultRenderParameters=function(){var a={},b=this.layer;if(this.layer){var c=this._getRenderingRuleArguments("stretch")||{},d=this._getRenderingRuleArguments("colormap")||{},k={},e=this.layer.pixelType&&"u8"!==this.layer.pixelType.toLowerCase()?g.StretchTypeNames.minMax:g.StretchTypeNames.none,n,m;this.stretchTypes.some(function(a){if(a.name===e)return m=a.filterType,!0});a.symbologyType=this._getDefaultSymbologyType();a.selectedBand=this._defaultRenderParameters.selectedBand;
a.stretchType=c.stretchType||m;a.minPercent=c.MinPercent||this._defaultRenderParameters.minPercent;a.maxPercent=c.MaxPercent||this._defaultRenderParameters.maxPercent;a.numberOfStandardDeviations=c.NumberOfStandardDeviations||this._defaultRenderParameters.numberOfStandardDeviations;a.gamma=c.Gamma||this._defaultRenderParameters.gamma;a.dra=c.DRA||this._defaultRenderParameters.dra;a.colorRamp=d.colorRamp||this._defaultRenderParameters.colorRamp;b.bandIds&&(a.bandIds=b.bandIds);b.hasRasterAttributeTable&&
b.rasterAttributeTable&&b.rasterAttributeTable.features&&b.rasterAttributeTable.features.length&&b.rasterAttributeTable.features[0].attributes.Red&&b.rasterAttributeTable.features[0].attributes.Green&&b.rasterAttributeTable.features[0].attributes.Blue&&(k.id=this._defaultRenderParameters.uniqueValuesColorRampId,k.type=this._defaultRenderParameters.uniqueValueColorRampType,k.colorRamps=[],b.rasterAttributeTable.features.forEach(function(a){n=a.attributes;k.colorRamps.push({fromColor:[n.Red,n.Green,
n.Blue],toColor:[n.Red,n.Green,n.Blue]})}),a.uniqueValuesColorRamp=k,a.uniqueValuesField=b.rasterAttributeTable.features[0].attributes.Value?this._defaultRenderParameters.uniqueValueField:null);b.bandCount&&1===b.bandCount&&b.pixelType&&"u8"===b.pixelType.toLowerCase()&&(a.discreteNColors=this._defaultRenderParameters.discreteNColors,a.discreteColorRamp=this._defaultRenderParameters.colorRamp);return a}};e.prototype.getUniqueValueFields=function(){if(this.layer.hasRasterAttributeTable&&this.layer.rasterAttributeTable&&
this.layer.rasterAttributeTable.fields&&this.layer.rasterAttributeTable.fields.length)return this.layer.rasterAttributeTable.fields.filter(function(a){if("esriFieldTypeOID"!==a.type)return!0})};e.prototype.getBandData=function(){var a=this;if(this.layer){var b=this.layer.bandCount,c,d,k=this.layer.id;if(!this._cachedKeyProperties[k]&&1<b)return this.layer.fetchKeyProperties().then(function(b){a._cachedKeyProperties[k]=b;c=a._createBandLists();d=a._getBandCombinationPresets();return{presets:d,lists:c}});
c=this._createBandLists();d=this._getBandCombinationPresets();return y.resolve({lists:c,presets:d})}};e.prototype.getUniqueValueGridData=function(a,b){var c=this;if(this.layer.hasRasterAttributeTable&&this.layer.rasterAttributeTable&&a&&b){for(var d=this.layer.rasterAttributeTable.features,k=a.colorRamps?a.colorRamps.length:1,e=[],g=[],d=this._sortFeatures(d,b),m,f,u,p,l,h=b=0,h=0;h<k;h++)e[h]={},e[h].start=b,e[h].end=b+1/k,b=e[h].end;d.forEach(function(b,k){p=(k+.5)/d.length;e.forEach(function(d,
k){p>=d.start&&p<d.end&&(l=(p-d.start)/(d.end-d.start),1<e.length?(m=c._getColorRGB(a.colorRamps[k].fromColor),f=c._getColorRGB(a.colorRamps[k].toColor)):(m=c._getColorRGB(a.fromColor),f=c._getColorRGB(a.toColor)),u=c._interpolateLab(m,f,l),g.push({esriRasterSymbologyEditorUniqueValueSymbol:c._correctRgbLimits(u),esriRasterSymbologyEditorUniqueValueValue:b.value,pixelValues:b.pixelValues,id:k+1}))})});return g}};e.prototype.updateRendering=function(a){a.symbologyType&&(a.symbologyType===g.SymbologyTypes.none?
this._clearRendering():a.symbologyType===g.SymbologyTypes.stretch?this._applyStretchSingleBand(a):a.symbologyType===g.SymbologyTypes.rgb?this._applyStretchRgb(a):a.symbologyType!==g.SymbologyTypes.uniqueValue&&a.symbologyType!==g.SymbologyTypes.discrete||this._applyColormap(a))};e.prototype._sortFeatures=function(a,b){if(a&&b){a=x.clone(a);var c=[];a.sort(function(a,c){return"string"===typeof a.attributes[b]?a.attributes[b]<c.attributes[b]?-1:1:a.attributes[b]-c.attributes[b]});a.forEach(function(d,
e){0<e&&d.attributes[b]===a[e-1].attributes[b]?c[c.length-1].pixelValues.push(d.attributes.Value):c.push({value:d.attributes[b],pixelValues:[d.attributes.Value]})});return c}};e.prototype._getDefaultSymbologyType=function(){if(this.layer&&this.layer.renderingRule&&this.layer.renderingRule.functionName){var a=this.layer.renderingRule,b=a.functionName,a=a.functionArguments;return b.toLowerCase()===g.RenderingRuleTypeNames.extractband||b.toLowerCase()===g.RenderingRuleTypeNames.stretch&&this.layer.bandCount&&
1===this.layer.bandCount||b.toLowerCase()===g.RenderingRuleTypeNames.colormap&&a&&a.colorRamp&&this.layer.bandCount&&1===this.layer.bandCount?g.SymbologyTypes.stretch:3<=this.layer.bandCount&&b.toLowerCase()===g.RenderingRuleTypeNames.stretch?g.SymbologyTypes.rgb:g.SymbologyTypes.none}return g.SymbologyTypes.none};e.prototype._getRenderingRuleArguments=function(a){if(this.layer&&this.layer.renderingRule&&a){var b=this.layer.renderingRule;return b.functionName&&b.functionName.toLowerCase()===a?b.functionArguments:
b.functionArguments&&b.functionArguments.Raster&&b.functionArguments.Raster.functionName&&b.functionArguments.Raster.functionName===a?b.functionArguments.Raster.functionArguments:null}};e.prototype._getBandCombinationPresets=function(){var a=this._cachedKeyProperties[this.layer.id];if(a){var b;g.bandCombinationPresets.forEach(function(c){if(c.bandDefinitionKeyword===a.BandDefinitionKeyword)return b=c.presets,!0});if(b)return b}};e.prototype._validateProps=function(a){if(null===a.stretchType||void 0===
a.stretchType||6===a.stretchType&&(isNaN(a.minPercent)||isNaN(a.maxPercent))||3===a.stretchType&&isNaN(a.numberOfStandardDeviations))return!1;if(!a.noData||isNaN(a.noData))a.noData=0;this.renderParameters=a;return!0};e.prototype._clearRendering=function(){this.layer.bandIds=null;this.layer.noData=null;this.layer.renderingRule=null};e.prototype._applyStretchSingleBand=function(a){if(this._validateProps(a)){this.layer.noData=a.noData;this.layer.bandIds=null;var b=this._getStretchRasterFunctionArguments(a,
1);if(1<this.layer.bandCount){var c={BandIDs:[a.selectedBand]},d=new l;d.functionArguments=c;d.functionName="ExtractBand";b.Raster=d}c=new l;c.functionName="Stretch";c.functionArguments=b;a.colorRampName&&"none"!==a.colorRampName?(b=new l,b.functionName="Colormap",b.functionArguments={colorRamp:a.colorRampName,Raster:c},this.layer.renderingRule=b):this.layer.renderingRule=c}};e.prototype._applyStretchRgb=function(a){if(this._validateProps(a)){this.layer.noData=a.noData;this.layer.bandIds=a.bandIds;
a=this._getStretchRasterFunctionArguments(a,3);var b=new l;b.functionName="Stretch";b.functionArguments=a;this.layer.renderingRule=b}};e.prototype._getStretchRasterFunctionArguments=function(a,b){var c={DRA:a.dra,StretchType:a.stretchType,useGamma:!0};0!==a.stretchType&&(c.MinPercent=a.minPercent,c.MaxPercent=a.maxPercent,1===b?c.Gamma=[a.gamma]:3===b&&(c.Gamma=[a.gamma,a.gamma,a.gamma]),c.NumberOfStandardDeviations=a.numberOfStandardDeviations);return c};e.prototype._getDiscreteColormap=function(a,
b){var c=this;if(a&&b){for(var d=a.colorRamps?a.colorRamps.length:1,e=[],g=[],n=[],m,f,l,p,r,h=0,q=0,h=0;h<d;h++)e[h]={},e[h].start=q,e[h].end=q+1/d,q=e[h].end;for(h=0;h<b;h++)p=(h+.5)/b,e.forEach(function(b,d){p>=b.start&&p<b.end&&(r=(p-b.start)/(b.end-b.start),1<e.length?(m=c._getColorRGB(a.colorRamps[d].fromColor),f=c._getColorRGB(a.colorRamps[d].toColor)):(m=c._getColorRGB(a.fromColor),f=c._getColorRGB(a.toColor)),l=c._interpolateLab(m,f,r),n.push(l))});for(h=0;256>h;h++)d=n[h%b],g.push([h,d.r,
d.g,d.b]);return g}};e.prototype._getColorRGB=function(a){return{r:a[0],g:a[1],b:a[2]}};e.prototype._applyColormap=function(a){var b=new l;b.functionName="Colormap";b.functionArguments={};a.symbologyType===g.SymbologyTypes.uniqueValue?b.functionArguments.Colormap=this._getUniqueValuesColormap(a.uniqueValuesSymbolData):a.symbologyType===g.SymbologyTypes.discrete&&(b.functionArguments.Colormap=this._getDiscreteColormap(a.discreteColorRamp,a.discreteNColors));b.variableName="Raster";this.layer.noData=
a.noData;this.layer.renderingRule=b};e.prototype._getUniqueValuesColormap=function(a){var b=[];a.forEach(function(a){a.pixelValues.forEach(function(c){b.push([c,a.esriRasterSymbologyEditorUniqueValueSymbol.r,a.esriRasterSymbologyEditorUniqueValueSymbol.g,a.esriRasterSymbologyEditorUniqueValueSymbol.b])})});return b};e.prototype._createBandLists=function(){var a=this;if(this.layer){var b=this.layer.id,c=this.layer.bandCount,d=this._cachedKeyProperties[b],e=this.layer.bandIds||[0,1,2],g=[],n=["red",
"green","blue"],f;d&&d.BandProperties&&0<d.BandProperties.length&&(f=d.BandProperties);e.forEach(function(b,d){f&&f[0].hasOwnProperty("BandName")?g.push(a._getBandIdList(c,f,a._getBandIndex(f,n[d]))):g.push(a._getBandIdList(c,f,b))});this._cachedKeyProperties[b]=d;return g}};e.prototype._getBandIndex=function(a,b){if(!this.layer||!a)return 0;var c;for(c=0;c<a.length;c++)if(a[c]&&a[c].hasOwnProperty("BandName")&&a[c].BandName.toLowerCase()===b)return c;return 0};e.prototype._getBandIdList=function(a,
b,c){if(this.layer){var d=[],e={},g=!1;b&&a===b.length&&(g=!0);var f;for(f=0;f<a;f++){var m=f.toString(),l=f.toString(),m=g&&b[f]&&b[f].BandName?b[f].BandName:z.bandPrefix+"_"+(f+1),e={};c===f&&(e.selected=!0);e.name=m;e.index=l;d.push(e)}return d}};e.prototype._interpolateLab=function(a,b,c){a=t.toLAB(a);b=t.toLAB(b);return t.toRGB({l:a.l*(1-c)+c*b.l,a:a.a*(1-c)+c*b.a,b:a.b*(1-c)+c*b.b})};e.prototype._correctRgbLimits=function(a){var b=[a.r,a.g,a.b];b.forEach(function(a,d){0>b[d]?b[d]=0:255<b[d]&&
(b[d]=255);b[d]=Math.floor(b[d])});return{r:b[0],g:b[1],b:b[2]}};return e}(r.declared(w));f.bandCombinationPresets=[{bandDefinitionKeyword:"LandsatTM",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]},{LandWater:[7,5,4]},{Vegetation:[5,4,3]}]},{bandDefinitionKeyword:"Landsat 8",presets:[{NaturalColor:[4,3,2]},{ColorInfrared:[5,4,3]},{Landuse:[5,4,2]},{LandWater:[7,6,5]},{Vegetation:[6,5,4]},{ShallowBathymetric:[3,2,1]}]},{bandDefinitionKeyword:"IKONOS",presets:[{NaturalColor:[3,
2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"QuickBird",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"Pleiades",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"GeoEye",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"OrbView",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"LandsatMSS",
presets:[{ColorInfrared:[4,3,2]}]},{bandDefinitionKeyword:"SPOT6",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"FORMOSTAT",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"SPOT1",presets:[{ColorInfrared:[1,2,3]},{Vegetation:[2,3,4]}]},{bandDefinitionKeyword:"WorldView",presets:[{NaturalColor:[5,3,2]},{ColorInfrared:[7,5,3]},{Landuse:[7,5,2]},{LandWater:[8,7,6]},{Vegetation:[7,6,5]},{ShallowBathymetric:[3,
2,1]}]},{bandDefinitionKeyword:"RapidEye",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[5,3,2]},{Landuse:[5,3,1]},{Vegetation:[5,4,3]}]},{bandDefinitionKeyword:"DMCii",presets:[{ColorInfrared:[1,2,3]}]}];f.StretchTypeNames={none:"none",minMax:"minMax",percentClip:"percentClip",standardDeviation:"standardDeviation"};f.RenderingRuleTypeNames={extractband:"extractband",colormap:"colormap",stretch:"stretch"};f.SymbologyTypes={none:"none",stretch:"stretch",rgb:"rgb",uniqueValue:"uniqueValue",discrete:"discrete"};
q([r.property()],f.prototype,"layer",void 0);q([r.property()],f.prototype,"renderParameters",void 0);f=g=q([r.subclass("esri.widgets.RasterSymbologyEditor.RasterSymbologyEditorViewModel")],f);var g;return f});