// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/accessorSupport/decorators ../support/widget ../Widget ./PopupRendererViewModel ../../core/requireUtils dojo/i18n!./nls/PopupRenderer".split(" "),function(u,f,v,m,n,b,r,t,w,l){function e(b,c){return void 0===c?"esri-popup-renderer__"+b:"esri-popup-renderer__"+b+"-"+c}var x=/^\s*(https?:\/\/[^\s]+)\s*$/i;f=function(f){function c(a){a=f.call(this)||this;a._chartMap=new Map;a._activeMediaMap=
new Map;a._chartRequirePromise=null;a._chartResizeTimer=null;a.graphic=null;a.title=null;a.viewModel=new t;return a}v(c,f);c.prototype.destroy=function(){clearTimeout(this._chartResizeTimer);this._chartResizeTimer=null;this._activeMediaMap.clear();this._activeMediaMap=null;this._cancelChartModules();this._destroyCharts()};c.prototype.resize=function(){this._resizeCharts();this.emit("resize")};c.prototype.render=function(){var a=b.tsx("div",{key:e("loading-container"),class:"esri-popup-renderer__loading-container"},
b.tsx("span",{class:b.join("esri-icon-loading-indicator esri-rotating","esri-popup-renderer__loading-spinner")})),a=this.viewModel.waitingForContent?a:this._renderContent();return b.tsx("div",{class:"esri-popup-renderer"},b.tsx("div",{class:"esri-popup-renderer__size-container"},b.tsx("div",{class:"esri-popup-renderer__main-container"},a)))};c.prototype.goToMedia=function(a,d){this._activeMediaMap.set(a,d);this.scheduleRender()};c.prototype.nextMedia=function(a){this._pageContentElementMedia(a,"next")};
c.prototype.previousMedia=function(a){this._pageContentElementMedia(a,"previous")};c.prototype._cancelChartModules=function(){this._chartRequirePromise&&this._chartRequirePromise.cancel()};c.prototype._destroyChart=function(a){var d=this._chartMap.get(a);d&&(d.chart.destroy(),d.tooltip.destroy());this._chartMap.delete(a)};c.prototype._destroyCharts=function(){this._chartMap.forEach(function(a){a.chart.destroy();a.tooltip.destroy()});this._chartMap.clear()};c.prototype._resizeCharts=function(){this._chartMap.forEach(function(a){a=
a.chart;var d=a.node;d&&d.offsetWidth&&d.offsetHeight&&a.resize()})};c.prototype._renderContent=function(){this._destroyCharts();var a=this.viewModel.content;if("string"===typeof a){var d=document.createElement("div");d.innerHTML=a;return b.tsx("div",{key:e("content"),bind:d,afterCreate:this._attachToNode})}if(a&&a.isInstanceOf&&a.isInstanceOf(r))return b.tsx("div",{key:e("content")},a.render());if(a instanceof HTMLElement)return b.tsx("div",{key:e("content"),bind:a,afterCreate:this._attachToNode});
if(a&&"function"===typeof a.postMixInProperties&&"function"===typeof a.buildRendering&&"function"===typeof a.postCreate&&"function"===typeof a.startup)return b.tsx("div",{key:e("content"),bind:a.domNode,afterCreate:this._attachToNode});if(Array.isArray(a))return a.length?b.tsx("div",{key:e("content")},a.map(this._renderContentElement,this)):null};c.prototype._renderContentElement=function(a,d){var b=this.viewModel.contentTypes;switch(a.type){case b.attachments:return this._renderAttachments(a,d);
case b.fields:return this._renderFields(a,d);case b.media:return this._renderMedia(a,d);case b.text:return this._renderText(a,d);default:return null}};c.prototype._renderAttachmentInfo=function(a,d){return b.tsx("li",{class:"esri-popup-renderer__attachments-item",key:e("attachment",d)},b.tsx("a",{class:"esri-popup-renderer__attachments-item-link",href:a.url,target:"_blank"},b.tsx("span",{class:b.join("esri-icon-download","esri-popup-renderer__attachments-item-icon")}),b.tsx("span",{class:"esri-popup-renderer__attachments-item-title"},
a.name||l.noTitle)))};c.prototype._renderAttachments=function(a,d){return(a=a.attachmentInfos)&&a.length?b.tsx("div",{key:e("attachments-element"),class:b.join("esri-popup-renderer__attachments","esri-popup-renderer__content-element")},b.tsx("div",{class:"esri-popup-renderer__attachments-title"},l.attach),b.tsx("ul",{class:"esri-popup-renderer__attachments-items"},a.map(this._renderAttachmentInfo))):null};c.prototype._renderFieldInfo=function(a,d){var h=this.viewModel,k=h.formattedAttributes.content[d]||
h.formattedAttributes.global,c=a.fieldName,h=a.label||c,k=null==k[c]?"":k[c];a=!(!a.format||!a.format.dateFormat);c='\x3ca target\x3d"_blank" href\x3d"$1" title\x3d"'+h+'"\x3e'+l.view+"\x3c/a\x3e";k=k&&"string"===typeof k?k.replace(x,c):k;a=(g={},g["esri-popup-renderer__field-data--date"]=a,g);return b.tsx("tr",{key:e("fields-element-info-row",d)},b.tsx("th",{key:e("fields-element-info-row-header",d),class:"esri-popup-renderer__field-header"},h),b.tsx("td",{key:e("fields-element-info-row-data",d),
class:"esri-popup-renderer__field-data",classes:a,innerHTML:k}));var g};c.prototype._renderFields=function(a,d){var h=this;return(a=a.fieldInfos)?b.tsx("div",{key:e("fields-element",d),class:b.join("esri-popup-renderer__fields","esri-popup-renderer__content-element")},b.tsx("table",{summary:l.fieldsSummary,key:e("fields-element-table",d)},b.tsx("tbody",{key:e("fields-element-table-body",d)},a.map(function(a){return h._renderFieldInfo(a,d)})))):null};c.prototype._shouldOpenInNewTab=function(a){void 0===
a&&(a="");return!/^(?:mailto:|tel:)/.test(a.trim().toLowerCase())};c.prototype._renderMediaInfoType=function(a,d){var h=a.value,c=a.title,c=void 0===c?"":c,f=a.type,g=h.sourceURL,h=h.linkURL,y=this._shouldOpenInNewTab(h)?"_self":"_blank";if("image"===f)return a=b.tsx("img",{alt:c,src:g}),(d=h?b.tsx("a",{title:c,href:h,target:y},a):null)?d:a;if(-1!==f.indexOf("chart"))return b.tsx("div",{key:e("chart",d),bind:this,"data-media-info":a,"data-content-element-index":d,class:"esri-popup-renderer__media-chart",
afterCreate:this._getChartDependencies,afterUpdate:this._getChartDependencies})};c.prototype._getChartDependencies=function(a){var d=this,b=a["data-media-info"],c=a["data-content-element-index"],e=b.value,g=e.theme||"Claro",f=b.type,b=["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip"],p=g;"string"===typeof g&&(p=g.replace(/\./g,"/"),-1===p.indexOf("/")&&(p="dojox/charting/themes/"+p));b.push(p);this._cancelChartModules();this._chartRequirePromise=w.when(u,b).then(function(b){d._renderChart(a,
c,f,e,b[0],b[1],b[2]);clearTimeout(d._chartResizeTimer);d._chartResizeTimer=setTimeout(function(){return d.resize()},0);d._chartRequirePromise=null})};c.prototype._renderChart=function(a,b,c,e,f,g,l){a=new f(a,{margins:{l:4,t:4,r:4,b:4}});l&&a.setTheme(l);switch(c){case "pie-chart":a.addPlot("default",{type:"Pie",labels:!1});a.addSeries("Series A",e.fields);break;case "line-chart":a.addPlot("default",{type:"Markers"});a.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1});
a.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});e.fields.forEach(function(a,b){a.x=b+1});a.addSeries("Series A",e.fields);break;case "column-chart":a.addPlot("default",{type:"Columns",gap:3});a.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});a.addSeries("Series A",e.fields);break;case "bar-chart":a.addPlot("default",{type:"Bars",gap:3}),a.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),a.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),
a.addSeries("Series A",e.fields)}c=new g(a);a.render();this._chartMap.set(b,{chart:a,tooltip:c})};c.prototype._renderMediaInfo=function(a,d){this._destroyChart(d);var c=this._renderMediaInfoType(a,d),k=a.title?b.tsx("div",{key:e("media-title",d),class:"esri-popup-renderer__media-item-title",innerHTML:a.title}):null;a=a.caption?b.tsx("div",{key:e("media-caption",d),class:"esri-popup-renderer__media-item-caption",innerHTML:a.caption}):null;return b.tsx("div",{key:e("media-container",d),class:"esri-popup-renderer__media-item-container",
bind:this,afterCreate:this.resize,afterUpdate:this.resize},b.tsx("div",{key:e("media-itme-container",d),class:"esri-popup-renderer__media-item"},c),k,a)};c.prototype._renderMediaStatsItem=function(a,d,c){c="chart"===c?b.join("esri-popup-renderer__media-chart-icon","esri-icon-chart"):b.join("esri-popup-renderer__media-image-icon","esri-icon-media");return b.tsx("li",{class:"esri-popup-renderer__media-image-summary"},b.tsx("span",{class:"esri-popup-renderer__media-count","aria-label":a},"("+d+")"),
b.tsx("span",{"aria-hidden":"true",class:c}))};c.prototype._renderMediaPageButton=function(a,d){var c=(a="previous"===a)?l.previous:l.next,k=a?b.join("esri-popup-renderer__button","esri-popup-renderer__media-previous"):b.join("esri-popup-renderer__button","esri-popup-renderer__media-next"),f=a?b.join("esri-popup-renderer__icon","esri-popup-renderer__media-previous-icon","esri-icon-left-triangle-arrow"):b.join("esri-popup-renderer__icon","esri-popup-renderer__media-next-icon","esri-icon-right-triangle-arrow"),
g=a?b.join("esri-popup-renderer__icon","esri-popup-renderer__media-previous-icon--rtl","esri-icon-right-triangle-arrow"):b.join("esri-popup-renderer__icon","esri-popup-renderer__media-next-icon--rtl","esri-icon-left-triangle-arrow"),m=a?this._previousClick:this._nextClick;return b.tsx("div",{key:e(a?"previous":"next",d),title:c,tabIndex:0,role:"button",class:k,"data-content-element-index":d,bind:this,onclick:m},b.tsx("span",{"aria-hidden":"true",class:f}),b.tsx("span",{"aria-hidden":"true",class:g}),
b.tsx("span",{class:"esri-icon-font-fallback-text"},c))};c.prototype._renderMedia=function(a,d){a=a.mediaInfos;var c=this._getMediaStats(a),f=c.total,m=(g={},g["esri-popup-renderer--media-pagination-visible"]=1<c.total,g),g=this._renderMediaStatsItem(l.numImages,c.images,"image"),c=this._renderMediaStatsItem(l.numCharts,c.charts,"chart"),n=this._renderMediaPageButton("previous",d),p=this._renderMediaPageButton("next",d),q=this._activeMediaMap.get(d);isNaN(q)&&(this._activeMediaMap.set(d,0),q=0);return f?
b.tsx("div",{key:e("media-element",d),class:b.join("esri-popup-renderer__media","esri-popup-renderer__content-element"),classes:m},b.tsx("ul",{class:"esri-popup-renderer__media-summary"},g,c),b.tsx("div",{key:e("media-element-container",d),class:"esri-popup-renderer__media-container"},n,this._renderMediaInfo(a[q],d),p)):null;var g};c.prototype._renderText=function(a,d){return a.text?b.tsx("div",{key:e("text-element",d),innerHTML:a.text,class:b.join("esri-popup-renderer__text","esri-popup-renderer__content-element")}):
null};c.prototype._attachToNode=function(a){a.appendChild(this)};c.prototype._getMediaStats=function(a){var b=0,c=0;a.forEach(function(a){a=a.type;"image"===a?b++:-1!==a.indexOf("chart")&&c++});return{total:c+b,images:b,charts:c}};c.prototype._pageContentElementMedia=function(a,b){var c=this.viewModel.content;(c=(c=c&&c[a])&&c.mediaInfos)&&c.length&&(b="previous"===b?-1:1,b=(this._activeMediaMap.get(a)+b+c.length)%c.length,this._activeMediaMap.set(a,b),this.scheduleRender())};c.prototype._previousClick=
function(a){this.previousMedia(a.currentTarget["data-content-element-index"])};c.prototype._nextClick=function(a){this.nextMedia(a.currentTarget["data-content-element-index"])};return c}(n.declared(r));m([n.aliasOf("viewModel.graphic")],f.prototype,"graphic",void 0);m([n.aliasOf("viewModel.title")],f.prototype,"title",void 0);m([n.property({type:t}),b.renderable(["viewModel.waitingForContent","viewModel.content"])],f.prototype,"viewModel",void 0);m([b.accessibleHandler()],f.prototype,"_previousClick",
null);m([b.accessibleHandler()],f.prototype,"_nextClick",null);return f=m([n.subclass("esri.widgets.Popup.PopupRenderer")],f)});