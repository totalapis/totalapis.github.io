// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper dojo/_base/lang dojo/io-query ../../../core/Accessor ../../../core/Collection ../../../core/HandleRegistry ../../../core/Logger ../../../core/promiseUtils ../../../core/watchUtils ../../../layers/WMSLayer ../../../layers/WMTSLayer ../../../layers/MapImageLayer ../../../layers/support/ExportImageParameters ../../../renderers/SimpleRenderer ../../../renderers/ClassBreaksRenderer ../../../renderers/UniqueValueRenderer ../../../Color ../../../request ./colorRampUtils ./sizeRampUtils ../../../core/arrayUtils ../../../core/accessorSupport/decorators ../../../renderers/support/jsonUtils ../../../symbols/support/symbolPreview".split(" "),
function(f,P,z,m,n,A,B,C,D,E,p,u,F,G,H,I,r,t,w,J,K,v,L,M,k,N,O){function x(f){return f.isInstanceOf(r)||f.isInstanceOf(t)||f.isInstanceOf(w)}var q=E.getLogger("esri.widgets.Legend.support.ActiveLayerInfo");f=function(f){function e(a){a=f.call(this,a)||this;a._handles=new D;a._hasColorRamp=!1;a._hasOpacityRamp=!1;a._hasSizeRamp=!1;a._legendResponse={};a.children=new C;a.layer=null;a.legendElements=[];a.parent=null;a.scale=null;a.title=null;return a}z(e,f);e.prototype.initialize=function(){var a=this,
b=function(){return a.notifyChange("ready")};this._handles.add([u.on(this,"children","change",function(c){var d=c.removed,g=a._handles;c.added.map(function(a){var c="activeLayerInfo-ready-watcher-"+a.layer.uid;g.add(u.init(a,"ready",b),c)});d.forEach(function(a){return g.remove(a.layer.uid)});b()})])};e.prototype.destroy=function(){this._handles.destroy();this._legendResponse=this._handles=null};Object.defineProperty(e.prototype,"ready",{get:function(){return null===this.layer?!0:0<this.children.length?
this._isGroupActive():0<this.legendElements.length},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"version",{get:function(){return this._get("version")+1},enumerable:!0,configurable:!0});e.prototype.buildLegendElementsForFeatureCollections=function(a){var b=this;this.legendElements=[];a.forEach(function(a){if(a.featureSet.features.length){var c=a.layerDefinition;(c=(c=c&&c.drawingInfo)&&N.fromJSON(c.renderer))?b._getRendererLegendElements(c,a.name).then(function(a){a&&a.length&&
Array.prototype.push.apply(b.legendElements,a);b.notifyChange("ready")}).otherwise(function(a){q.warn("error while building legend for layer!",a)}):q.warn("drawingInfo not available!")}})};e.prototype.buildLegendElementsForRenderer=function(){var a=this;this._getRendererLegendElements(this.layer.renderer).then(function(b){a.legendElements=b;a.notifyChange("ready")}).otherwise(function(a){q.warn("error while building legend for layer!",a)})};e.prototype.buildLegendElementsForTools=function(){var a=
this,b=this.layer;b.isInstanceOf(G)?this._constructLegendElementsForWMTSlayer():b.isInstanceOf(F)?this._constructLegendElementsForWMSSublayers():b.isInstanceOf(H)?this._constructLegendElementsForSublayers():(this._handles.remove("imageryLayers-watcher"),this._getLegendLayers().then(function(c){a.legendElements=[];c.forEach(function(c){if("esri.layers.ImageryLayer"===a.layer.declaredClass){var d=b.watch("renderingRule, bandIds",function(){a._legendResponse["default"]=null;a.buildLegendElementsForTools()});
a._handles.add(d,"imageryLayers-watcher")}(c=a._generateSymbolTableElementForLegendLayer(c))&&c.infos.length&&a.legendElements.push(c);a.notifyChange("ready")});a.notifyChange("ready")}).otherwise(function(a){q.warn("Request to server for legend has failed!",a)}))};e.prototype._isGroupActive=function(){var a=this.children;return a.length?a.some(function(a){return a.ready}):!1};e.prototype._constructLegendElementsForWMTSlayer=function(){this.legendElements=[];this._handles.remove("wmts-activeLayer-watcher");
var a=this.layer,b=a.activeLayer;this._handles.add(u.watch(this.layer,"activeLayer",this._constructLegendElementsForWMTSlayer.bind(this)),"wmts-activeLayer-watcher");if(b.styleId&&b.styles){var c=null;b.styles.some(function(a){if(b.styleId===a.id)return c=a.legendUrl,!0});c&&(this.legendElements=[{type:"symbol-table",title:b.title,infos:[{src:c,opacity:a.opacity}]}])}this.notifyChange("ready")};e.prototype._constructLegendElementsForWMSSublayers=function(){this.legendElements=[];this._handles.remove("wms-sublayers-watcher");
var a=this.layer,b=null;if(a.customParameters||a.customLayerParameters)b=n.clone(a.customParameters||{}),n.mixin(b,a.customLayerParameters||{});this._handles.add(u.watch(this.layer,"sublayers",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher");this.legendElements=this._generateLegendElementsForWMSSublayers(a.sublayers,b);this.notifyChange("ready")};e.prototype._generateLegendElementsForWMSSublayers=function(a,b){var c=this,d=[];this._handles.add(a.on("change",this._constructLegendElementsForWMSSublayers.bind(this)),
"wms-sublayers-watcher");a.forEach(function(a){var g=a.watch("title, visible, legendEnabled",function(){return c._constructLegendElementsForWMSSublayers()});c._handles.add(g,"wms-sublayers-watcher");a.visible&&a.legendEnabled&&(a=c._generateSymbolTableElementForWMSSublayer(a,b))&&a.infos.length&&d.unshift(a)});return d};e.prototype._generateSymbolTableElementForWMSSublayer=function(a,b){return!a.legendUrl&&a.sublayers?(b=this._generateLegendElementsForWMSSublayers(a.sublayers,b).filter(function(a){return a}),
{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendUrl(a,b)};e.prototype._generateSymbolTableElementForLegendUrl=function(a,b){var c=a.legendUrl;if(c){var d={type:"symbol-table",title:a.title||a.name||a.id&&a.id+"",infos:[]};b&&(c+="?"+A.objectToQuery(b));d.infos.push({src:c,opacity:a.layer&&a.layer.opacity});return d}};e.prototype._getLegendLayers=function(a){var b=this,c=(a=a&&a.hasDynamicLayers?a.dynamicLayers:null)||"default",d=this._legendResponse&&this._legendResponse[c];
return d?p.resolve(d):this._legendRequest(a).then(function(a){a=a.layers;return b._legendResponse[c]=a})};e.prototype._legendRequest=function(a){var b=this.layer;a={f:"json",dynamicLayers:a};"esri.layers.ImageryLayer"===b.declaredClass&&(b.renderingRule&&(a.renderingRule=JSON.stringify(b.renderingRule.toJSON())),b.bandIds&&(a.bandIds=b.bandIds.join()));var c=b.url.replace(/(\/)+$/,"");if(10.01<=b.version){var d=c.indexOf("?"),c=-1<d?c.substring(0,d)+"/legend"+c.substring(d):c+"/legend";b.token&&(c+=
"?token\x3d"+b.token)}else b=c.toLowerCase().indexOf("/rest/"),b=c.substring(0,b)+c.substring(b+5,c.length),c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(b)+"\x26returnbytes\x3dtrue";return K(c,{query:a,callbackParamName:"callback"}).then(function(a){return a.data})};e.prototype._constructLegendElementsForSublayers=function(){var a=this;this.legendElements=[];this._handles.remove("sublayers-watcher");var b=this.layer,c=new I({layer:b});this._getLegendLayers(c).then(function(c){var d=
{};c.forEach(function(a){d[a.layerId]=a});a._handles.add(u.watch(b,"sublayers",a._constructLegendElementsForSublayers.bind(a)),"sublayers-watcher");a.legendElements=a._generateLegendElementsForSublayers(b.sublayers,d,b.opacity);a.notifyChange("ready")}).otherwise(function(a){q.warn("Request to server for legend has failed!",a)}).then(function(){return c.destroy()});this.notifyChange("ready")};e.prototype._generateLegendElementsForSublayers=function(a,b,c){var d=this,g=[];this._handles.add(a.on("change",
this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher");a.forEach(function(a){var e=a.watch("renderer, opacity, title, visible",function(){return d._constructLegendElementsForSublayers()});d._handles.add(e,"sublayers-watcher");a.visible&&a.legendEnabled&&(e=a&&null!=a.opacity?a.opacity:null,(a=d._generateSymbolTableElementForSublayer(a,b,null!=e?e*c:c))&&a.infos.length&&g.unshift(a))});return g};e.prototype._generateSymbolTableElementForSublayer=function(a,b,c){var d=b[a.id];return!d&&
a.sublayers?(b=this._generateLegendElementsForSublayers(a.sublayers,b,c).filter(function(a){return a}),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendLayer(d,a,c)};e.prototype._generateSymbolTableElementForLegendLayer=function(a,b,c){var d=this;if(a){var g=b&&b.renderer,e=a.layerName;g&&(g=b&&b.title?b.title:this._getRendererTitle(g,b))&&(e&&(g.title=e),e=g);e={type:"symbol-table",title:e,infos:[]};a.legendType&&(e.legendType=a.legendType);a.legend&&this._isLegendLayerInScale(a,
b)&&(b=b?this._sanitizeLegendForSublayer(a.legend.slice(),b):a.legend,e.infos=b.map(function(b){var g=b.url;if(b.imageData&&0<b.imageData.length)g="data:image/png;base64,"+b.imageData;else if(0!==g.indexOf("http")){var g=d.layer.url+"/"+a.layerId+"/images/"+g,e=d.layer.token;e&&(g+="?token\x3d"+e)}else return null;return{label:b.label,src:g,opacity:c,width:b.width,height:b.height}}).filter(function(a){return!!a}));return e.infos.length?e:null}};e.prototype._isLegendLayerInScale=function(a,b){b=b||
this.layer;var c=null,d=null,g=!0;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&(d=b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,d=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||d>this.scale)g=!1;return g};e.prototype._sanitizeLegendForSublayer=function(a,b){if(10.1>this.layer.version||0===a.length)return a;b=b.renderer;var c=null,
d=null;a.some(function(a){return a.values})&&a.some(function(a,b){a.values||(c=b,d=a,d.label||(d.label="others"));return null!=d});b?"uniqueValue"===b.type?d&&(a.splice(c,1),a.push(d)):"classBreaks"===b.type&&(d&&a.splice(c,1),a.reverse(),d&&a.push(d)):d&&(a.splice(c,1),a.push(d));return a};e.prototype._getRendererLegendElements=function(a,b){var c=this;return this._loadRenderer(a).then(function(a){c._hasColorRamp=!1;c._hasOpacityRamp=!1;c._hasSizeRamp=!1;var d=c._getVisualVariableLegendElements(a)||
[],e={type:"symbol-table",title:b||c._getRendererTitle(a),infos:[]},f=null;a.isInstanceOf(w)?a.uniqueValueInfos.forEach(function(a){a.symbol&&e.infos.push({label:a.label||a.value,value:a.value,symbol:a.symbol})}):a.isInstanceOf(t)?(f=c._isUnclassedRenderer(a),f&&c._hasSizeRamp||(a.classBreakInfos.forEach(function(a){a.symbol&&e.infos.unshift({label:a.label||(f?null:a.minValue+" - "+a.maxValue),value:[a.minValue,a.maxValue],symbol:a.symbol})}),f&&(e.title=null))):a.isInstanceOf(r)&&a.symbol&&!c._hasSizeRamp&&
e.infos.push({label:a.label,symbol:a.symbol});var h=!1;if(x(a)){var l=a.defaultLabel,y=a.defaultSymbol;y&&!f&&(e.infos.push({label:l||"others",symbol:y}),h=!0)}h||a.isInstanceOf(r)||f&&!c._hasColorRamp&&!c._hasSizeRamp&&!c._hasOpacityRamp||d.push({type:"symbol-table",infos:[{label:a.defaultLabel,symbol:a.defaultSymbol}]});e.infos.length&&d.unshift(e);var k=c._getSymbolConfig(a.visualVariables),h=d.reduce(function(a,b){return a.concat(b.infos)},[]).filter(function(a){return!!a.symbol}).map(function(a){return c._getSymbolPreview(a,
k)});a=null;return p.eachAlways(h).then(function(){return d})})};e.prototype._getSymbolConfig=function(a){var b=!1,c=!1;if(a)for(var d=0;d<a.length&&(!b||!c);d++){var g=a[d];"size"===g.type&&("height"===g.axis&&(b=!0),"width-and-depth"===g.axis&&(c=!0))}return b&&c?"tall":null};e.prototype._getSymbolPreview=function(a,b){return O.renderPreviewHTML(a.symbol,{size:a.size,opacity:this.layer.opacity,symbolConfig:b}).then(function(b){a.preview=b;return a}).otherwise(function(){a.preview=null;return a})};
e.prototype._loadRenderer=function(a){var b=this,c=[];if(!x(a))return q.warn("Renderer not supported!"),p.reject();a=a.clone();var d=this._getMedianColor(a),g=this.layer.opacity;(a.isInstanceOf(t)||a.isInstanceOf(w))&&c.concat((a.classBreakInfos||a.uniqueValueInfos).map(function(a){return b._fetchSymbol(a.symbol,d,g).then(function(b){a.symbol=b}).otherwise(function(){a.symbol=null})}));c.push(this._fetchSymbol(a.symbol||a.defaultSymbol,a.defaultSymbol?null:d,g).then(function(c){b._applySymbolToRenderer(a,
c,a.isInstanceOf(r))}).otherwise(function(){b._applySymbolToRenderer(a,null,a.isInstanceOf(r))}));return p.eachAlways(c).then(function(){return a})};e.prototype._applySymbolToRenderer=function(a,b,c){c?a.symbol=b:a.defaultSymbol=b};e.prototype._getMedianColor=function(a){if(!a.visualVariables)return null;var b=M.find(a.visualVariables,function(a){return"color"===a.type});if(!b)return null;var c=null,d=null;if(b.colors)c=b.minDataValue,d=b.maxDataValue;else if(b.stops){if(1===b.stops.length)return b.stops[0].color;
c=b.stops[0].value;d=b.stops[b.stops.length-1].value}if(null!=c&&null!=d)return a.getColor(c+(d-c)/2,{colorInfo:b})};e.prototype._fetchSymbol=function(a,b,c){var d=this;return a?"web-style-symbol"===a.type?a.fetchSymbol().then(function(a){return d._getAppliedCloneSymbol(a,b,c)}).otherwise(function(){q.warn("Fetching web-style-symbol failed!");return p.reject()}):p.resolve(this._getAppliedCloneSymbol(a,b,c)):p.reject()};e.prototype._getAppliedCloneSymbol=function(a,b,c){if(!a)return a;a=a.clone();
var d=-1<a.type.indexOf("3d");b=b&&b.toRgba();d?this._applyColorTo3dSymbol(a,b,c):(a.color&&(a.color=this._getOpacityAppliedColor(b||a.color.toRgba(),c)),(b=a.outline)&&b.color&&(b.color=this._getOpacityAppliedColor(b.color.toRgba(),c)));return a};e.prototype._applyColorTo3dSymbol=function(a,b,c){var d=this;a.symbolLayers.forEach(function(a){a&&(b&&(a.material||(a.material={}),a.material.color=new J(b)),null!=c&&(a.material&&a.material.color&&(a.material.color=d._getOpacityAppliedColor(a.material.color.toRgba(),
c)),a.outline&&a.outline.color&&(a.outline.color=d._getOpacityAppliedColor(a.outline.color.toRgba(),c))))})};e.prototype._getOpacityAppliedColor=function(a,b){a[3]*=b;return a};e.prototype._getVisualVariableLegendElements=function(a){var b=this,c=a.visualVariables,d=[],e=[],f=[],k=this.layer.opacity;if(!c)return null;c.forEach(function(a){"color"===a.type?d.push(a):"size"===a.type?e.push(a):"opacity"===a.type&&f.push(a)});var c=d.concat(e,f),h,l;0===d.length&&a.isInstanceOf(t)&&a.classBreakInfos&&
1===a.classBreakInfos.length&&(h=(h=a.classBreakInfos[0])&&h.symbol);0===d.length&&a.isInstanceOf(r)&&(h=a.symbol);h&&(-1<h.type.indexOf("3d")?(h=h.symbolLayers.getItemAt(0),h.get("material.color")&&(l=h.material.color)):h.url||(l=h.color),l&&(l=l.toRgba()));return c.map(function(c){if(!c.legendOptions||!1!==c.legendOptions.showLegend){var d=b._getRampTitle(c,b.layer),e=v.getRampBorderColor(a),g=v.getRampOverlayColor(k),f=null;"color"===c.type?(f={type:"color-ramp",title:d,borderColor:e,overlayColor:g,
infos:v.getRampStops(a,c)},b._hasColorRamp||(b._hasColorRamp=!(null==f.infos||!f.infos.length))):"size"===c.type?(f={type:"size-ramp",title:d,infos:L.getRampStops(a,c,b._getMedianColor(a),b.scale)},b._hasSizeRamp||(b._hasSizeRamp=!(null==f.infos||!f.infos.length))):"opacity"===c.type&&(f={type:"opacity-ramp",title:d,borderColor:e,overlayColor:g,infos:v.getRampStops(a,c,l)},b._hasOpacityRamp||(b._hasOpacityRamp=!(null==f.infos||!f.infos.length)));return f.infos&&f}}).filter(function(a){return!!a})};
e.prototype._getRampTitle=function(a,b){var c=a.field,d=a.normalizationField,e=!1,f=!1,k=!1,h=null,c=n.isFunction(c)?null:c,d=n.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)h=a.legendOptions.title;else if(a.valueExpressionTitle)h=a.valueExpressionTitle;else{if(b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables)for(a=b.renderer.authoringInfo.visualVariables,h=0;h<a.length;h++){var l=a[h];if("colorInfo"===l.type)if("ratio"===l.style){e=!0;break}else if("percent"===
l.style){f=!0;break}else if("percentTotal"===l.style){k=!0;break}}h={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),ratio:e,ratioPercent:f,ratioPercentTotal:k}}return h};e.prototype._getRendererTitle=function(a,b){if(a.legendOptions&&a.legendOptions.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;var c=this.layer,d=a.field,e=null,f=null;a instanceof t&&(e=a.normalizationField,f="percent-of-total"===a.normalizationType);d=n.isFunction(d)?
null:d;e=n.isFunction(e)?null:e;a=null;if(d||e)a={field:b?d:d&&this._getFieldAlias(d,c),normField:b?e:e&&this._getFieldAlias(e,c),normByPct:f};return a};e.prototype._getFieldAlias=function(a,b){var c=b.popupTemplate,c=c&&c.fieldInfos;b=n.isFunction(a)?null:b.getField&&b.getField(a);var d=null;c&&c.some(function(b){if(a===b.fieldName)return d=b,!0});var c=d||b,e=null;c&&(e=d&&d.label||b&&b.alias||c.name||c.fieldName);return e};e.prototype._isUnclassedRenderer=function(a){var b=a.visualVariables,c=
!1;a.isInstanceOf(t)&&a.classBreakInfos&&1===a.classBreakInfos.length&&b&&(c=a.field?b.some(function(b){return!(!b||a.field!==b.field||(a.normalizationField||b.normalizationField)&&a.normalizationField!==b.normalizationField)}):!!b.length);return c};return e}(k.declared(B));m([k.property()],f.prototype,"children",void 0);m([k.property()],f.prototype,"layer",void 0);m([k.property()],f.prototype,"legendElements",void 0);m([k.property()],f.prototype,"parent",void 0);m([k.property({readOnly:!0})],f.prototype,
"ready",null);m([k.property()],f.prototype,"scale",void 0);m([k.property()],f.prototype,"title",void 0);m([k.property({dependsOn:["ready"],readOnly:!0,value:0})],f.prototype,"version",null);return f=m([k.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],f)});