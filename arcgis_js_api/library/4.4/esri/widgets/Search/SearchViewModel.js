// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleRegistry ../../core/promiseUtils ../../core/watchUtils ../../styles/basic ./FeatureLayerSearchSource ./LocatorSearchSource ../../tasks/Locator dojo/has ../../Graphic ../../geometry/Point ../../symbols/PictureMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../symbols/TextSymbol ../../PopupTemplate ../../geometry/SpatialReference ./support/geometryUtils dojo/i18n!./nls/Search ../../core/accessorSupport/decorators".split(" "),
function(b,Q,B,f,C,D,u,E,F,k,p,G,t,n,H,I,y,q,J,K,L,M,N,O,P,v,m,e){function h(b,c){return b.hasOwnProperty(c)&&null!=b[c]&&""!==b[c]}var z=D.ofType(function(b){return b instanceof n||b instanceof t?b:b.featureLayer?new t(b):new n(b)}),A=P.WGS84,r=new n({locator:new H({url:"//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer"}),singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],name:m.esriLocatorName,localSearchOptions:{minScale:3E5,distance:5E4},placeholder:m.placeholder,
resultSymbol:new J({url:b.toUrl(I("trident")?"../../images/search/search-symbol-32.png":"../../images/search/search-symbol-32.svg"),size:24,width:24,height:24})});b=function(b){function c(a){a=b.call(this)||this;a._suggestPromises=[];a._handles=new F;a._suggestDelayPromise=null;a._viewReadyPromise=null;a._viewAnimation=null;a._popupTemplate=new O({title:m.searchResult,content:"{Match_addr}"});a.activeSource=null;a.activeSourceIndex=0;a.allPlaceholder=m.allPlaceholder;a.autoNavigate=!0;a.autoSelect=
!0;a.defaultSource=r;a.locationToAddressDistance=1500;a.maxInputLength=128;a.maxResults=6;a.maxSuggestions=6;a.minSuggestCharacters=1;a.placeholder="";a.popupOpenOnSelect=!0;a.popupTemplate=null;a.popupEnabled=!0;a.resultGraphicEnabled=!0;a.resultGraphic=null;a.results=null;a.selectedSuggestion=null;a.searchAllEnabled=!0;a.selectedResult=null;a.sources=new z([r]);a.suggestionDelay=150;a.suggestions=null;a.suggestionsEnabled=!0;a.view=null;a.zoomScale=1E3;return a}B(c,b);c.prototype.initialize=function(){var a=
this;this._handles.add([p.init(this,"activeSourceIndex",function(d){a._updateActiveSource();a._setPlaceholder(d)}),p.init(this,"allPlaceholder",function(){a._setPlaceholder(a.activeSourceIndex)}),p.init(this,"sources",function(){a._setDefaultActiveSourceIndex();a._setPlaceholder(a.activeSourceIndex)}),p.init(this,"searchAllEnabled",function(){return a._setDefaultActiveSourceIndex()})])};c.prototype.destroy=function(){this.clearGraphics();this._viewReadyPromise&&this._viewReadyPromise.cancel();this._handles.destroy();
this._handles=null};Object.defineProperty(c.prototype,"popup",{get:function(){return this.get("view.popup")||null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(a){this._set("searchTerm",a||"");this.clearGraphics();this.selectedSuggestion&&this.selectedSuggestion.text!==a&&this._set("selectedSuggestion",null);""===a&&this._clear()},enumerable:!0,configurable:!0});c.prototype.cancelSuggest=function(){this._cancelSuggestions();
var a=this._suggestDelayPromise;a&&a.cancel()};c.prototype.clear=function(){this.searchTerm=""};c.prototype.clearGraphics=function(){this._closePopup();this.view&&this.view.graphics.remove(this.resultGraphic);this._set("resultGraphic",null)};c.prototype.search=function(a){var d=this;this.emit("search-start");this.cancelSuggest();var g=this._getLocationSearch(a),l=this._createSuggestionForSearch(a);return this._ready(this.view).then(function(){return d._getResultsFromSources(g,l).then(function(a){var g=
{activeSourceIndex:d.activeSourceIndex,searchTerm:l.text,numResults:0,numErrors:0,errors:[],results:[]};d._formatEvent(g,a,l);d._set("searchTerm",l.text);l.key&&l.sourceIndex&&d._set("selectedSuggestion",l);d._set("results",g.results);d.emit("search-complete",g);return d._selectFirstResult(g.results).then(function(){return g.results})})})};c.prototype.select=function(a){var d=this;this.cancelSuggest();this.clearGraphics();if(!a)return k.reject(new u("searchviewmodel:missing-parameter","searchResult is required."));
var g=this.view,l=h(a,"sourceIndex")?a.sourceIndex:this._getSourceIndexOfResult(a),b=this.sources.getItemAt(l);if(!b)return k.reject(new u("searchviewmodel:missing-source","source not found for selection."));var c=b instanceof t?this._getSourcePopupTemplate(b):null,e=b.resultSymbol||this._getDefaultSymbol(a),f=h(b,"resultGraphicEnabled")?b.resultGraphicEnabled:this.resultGraphicEnabled,m=h(b,"autoNavigate")?b.autoNavigate:this.autoNavigate,p=h(b,"popupOpenOnSelect")?b.popupOpenOnSelect:this.popupOpenOnSelect,
n=h(b,"popupEnabled")?b.popupEnabled:this.popupEnabled,r=c||this.popupTemplate||this._popupTemplate,x=a.feature,q=this.popup;if(!x)return k.reject(new u("searchviewmodel:missing-feature","The SearchResult must contain a feature for selection."));c=v.getPointFromGeometry(x.geometry);return(this.view?v.getPointWithElevation(c,g):k.resolve(c)).then(function(c){e instanceof N&&(e.text=a.name);var w=new y({geometry:c,symbol:e,attributes:x.attributes,popupTemplate:n?r:null});return d._goToSearchResult(m,
a.extent).always(function(){d._viewAnimation=null;f&&g&&g.graphics.push(w);q&&n&&p&&q.open({features:[w],location:c});d._set("selectedResult",a);d._set("resultGraphic",w);d.emit("select-result",{result:a,source:b,sourceIndex:l});return a})})};c.prototype.suggest=function(a,d){var g=this;this.cancelSuggest();var b=a||this.searchTerm;this.emit("suggest-start",{searchTerm:b});return this._suggestTimer(d).then(function(){return g._suggestImmediate(b).then(function(a){g._set("suggestions",a.results);g.emit("suggest-complete",
a);return a.results})})};c.prototype._clear=function(){this._viewAnimation&&(this._viewAnimation.stop(),this._viewAnimation=null);this._set("results",null);this._set("suggestions",null);this._set("selectedResult",null);this._set("selectedSuggestion",null);this.emit("search-clear")};c.prototype._closePopup=function(){var a=this.get("view.popup"),d=this.resultGraphic;if(a&&this.popupEnabled&&d){var g=a.selectedFeature;g&&g===d&&a.close()}};c.prototype._suggestTimer=function(a){return this._suggestDelayPromise=
a=k.after(null!=a?a:this.suggestionDelay)};c.prototype._getLocationSearch=function(a){if(a instanceof y)return v.getPointFromGeometry(a.geometry);if(a instanceof q)return a;if(Array.isArray(a)&&2===a.length)return new q({longitude:a[0],latitude:a[1]})};c.prototype._createSuggestionForSearch=function(a){if(a&&h(a,"key")&&h(a,"text")&&h(a,"sourceIndex"))return a;a="string"===typeof a?a:this.searchTerm;var d=this.selectedSuggestion,g=this.selectedResult;return d&&g&&d.text===g.name?d:{text:a,key:null,
sourceIndex:null}};c.prototype._getFirstResult=function(a){var d=null;a&&a.some(function(a){a=a.results[0];var b=!!a;b&&(d=a);return b});return d};c.prototype._selectFirstResult=function(a){return this.autoSelect&&a&&this.view?(a=this._getFirstResult(a))?this.select(a):k.resolve():k.resolve()};c.prototype._suggestImmediate=function(a){var d=this;return this._ready(this.view).then(function(){return d._getSuggestionsFromSources(a)}).then(function(b){var g={activeSourceIndex:d.activeSourceIndex,searchTerm:a,
numResults:0,numErrors:0,errors:[],results:[]};d._formatEvent(g,b);return g})};c.prototype._formatEventSource=function(a,d,b){var g=d&&d.value||[];d=d&&d.error;var c=this.sources.getItemAt(b);d?(a.errors.push({sourceIndex:b,source:c,error:d}),a.numErrors++):(a.results.push({sourceIndex:b,source:c,results:g}),a.numResults+=g.length)};c.prototype._formatEvent=function(a,d,b){var g=this;if(d)if(-1===a.activeSourceIndex){var c=b&&h(b,"sourceIndex")&&-1!==b.sourceIndex?b.sourceIndex:void 0;d.forEach(function(d,
b){g._formatEventSource(a,d,void 0!==c?c:b)})}else this._formatEventSource(a,d[0],a.activeSourceIndex)};c.prototype._getResultsFromSources=function(a,d){var b=this,c=!a&&h(d,"sourceIndex")?d.sourceIndex:this.activeSourceIndex,e=[];-1===c?this.sources.forEach(function(g,c){e.push(b._getResultsFromSource(a,d,c))}):e.push(this._getResultsFromSource(a,d,c));return k.eachAlways(e)};c.prototype._getSuggestionsFromSources=function(a){var d=this,b=this.activeSourceIndex,c=[];-1===b?this.sources.forEach(function(b,
g){b=d._getSuggestionsFromSource(a,g);d._suggestPromises.push(b);c.push(b)}):(b=this._getSuggestionsFromSource(a,b),this._suggestPromises.push(b),c.push(b));return k.eachAlways(c)};c.prototype._getResultsFromSource=function(a,b,c){var d=this.sources.getItemAt(c),g=this.get("view.spatialReference")||A,e=h(d,"maxResults")?d.maxResults:this.maxResults,f=d instanceof t&&h(d,"exactMatch")?d.exactMatch:!1,k=h(d,"zoomScale")?d.zoomScale:this.zoomScale,m=d instanceof n&&h(d,"locationToAddressDistance")?d.locationToAddressDistance:
this.locationToAddressDistance;return d.getResults({view:this.view,sourceIndex:c,location:a,suggestResult:b,spatialReference:g,exactMatch:f,maxResults:e,distance:m,zoomScale:k})};c.prototype._getSuggestionsFromSource=function(a,d){var b=this.sources.getItemAt(d),c=h(b,"suggestionsEnabled")?b.suggestionsEnabled:this.suggestionsEnabled,e=a.trim().length,f=h(b,"minSuggestCharacters")?b.minSuggestCharacters:this.minSuggestCharacters;return c&&e>=f?(c=this.get("view.spatialReference")||A,e=h(b,"maxSuggestions")?
b.maxSuggestions:this.maxSuggestions,b.getSuggestions({view:this.view,sourceIndex:d,suggestTerm:a,spatialReference:c,maxSuggestions:e})):k.resolve()};c.prototype.createDefaultSymbol=function(a,b){if("point"===b)return new M({color:a.color,size:a.size,outline:{color:a.outline.color,width:a.outline.width}});if("polyline"===b)return new L({color:a.color,width:a.width});if("polygon"===b)return new K({color:a.color,outline:{color:a.outline.color,width:a.outline.width}})};c.prototype._cancelSuggestions=
function(){var a=this;this._suggestPromises.forEach(function(b){b.cancel(a.declaredClass+": cancelling request")});this._suggestPromises.length=0};c.prototype._updateActiveSource=function(){var a=this.sources.getItemAt(this.activeSourceIndex)||null;this._set("activeSource",a)};c.prototype._getPlaceHolderText=function(a){var b=this.sources.getItemAt(a),c=this.allPlaceholder,c=void 0===c?m.allPlaceholder:c;return-1===a?c:b?b.placeholder:""};c.prototype._setPlaceholder=function(a){this._set("placeholder",
this._getPlaceHolderText(a))};c.prototype._setDefaultActiveSourceIndex=function(){this.activeSourceIndex=1!==this.sources.length&&this.searchAllEnabled?-1:0};c.prototype._getSourcePopupTemplate=function(a){var b=a.featureLayer;if(b)return h(a,"popupTemplate")?a.popupTemplate:b.popupTemplate};c.prototype._getSourceIndexOfResult=function(a){var b=null;this.results.some(function(d){return d.results.some(function(c){if(c===a)return b=d.sourceIndex,!0})});return b};c.prototype._goToSearchResult=function(a,
b){var d=this.view;a=d&&a&&!!b;var c={animate:a};b="3d"===d.type?d.goTo({target:b,tilt:0},c):d.goTo({target:b},c);a&&(this._viewAnimation=b);return b};c.prototype._ready=function(a){this._viewReadyPromise&&this._viewReadyPromise.cancel();return a?this._viewReadyPromise=a=a.always():k.resolve()};c.prototype._getDefaultSymbol=function(a){var b=this.get("view.map.basemap.id");if(a=a&&a.feature&&a.feature.geometry&&a.feature.geometry.type)if(b=(b=G.getSchemes({theme:"default",basemap:b||"topo",geometryType:a}))&&
b.primaryScheme)return b.color&&h(b,"opacity")&&(b.color.a=b.opacity),this.createDefaultSymbol(b,a);return r.resultSymbol};return c}(e.declared(C,E));b.ALL_INDEX=-1;f([e.property({readOnly:!0})],b.prototype,"activeSource",void 0);f([e.property()],b.prototype,"activeSourceIndex",void 0);f([e.property()],b.prototype,"allPlaceholder",void 0);f([e.property()],b.prototype,"autoNavigate",void 0);f([e.property()],b.prototype,"autoSelect",void 0);f([e.property({readOnly:!0})],b.prototype,"defaultSource",
void 0);f([e.property()],b.prototype,"locationToAddressDistance",void 0);f([e.property()],b.prototype,"maxInputLength",void 0);f([e.property()],b.prototype,"maxResults",void 0);f([e.property()],b.prototype,"maxSuggestions",void 0);f([e.property()],b.prototype,"minSuggestCharacters",void 0);f([e.property({readOnly:!0})],b.prototype,"placeholder",void 0);f([e.property({dependsOn:["view.popup"],readOnly:!0})],b.prototype,"popup",null);f([e.property()],b.prototype,"popupOpenOnSelect",void 0);f([e.property()],
b.prototype,"popupTemplate",void 0);f([e.property()],b.prototype,"popupEnabled",void 0);f([e.property()],b.prototype,"resultGraphicEnabled",void 0);f([e.property({readOnly:!0})],b.prototype,"resultGraphic",void 0);f([e.property({readOnly:!0})],b.prototype,"results",void 0);f([e.property({readOnly:!0})],b.prototype,"selectedSuggestion",void 0);f([e.property()],b.prototype,"searchAllEnabled",void 0);f([e.property({readOnly:!0})],b.prototype,"selectedResult",void 0);f([e.property()],b.prototype,"searchTerm",
null);f([e.property({type:z})],b.prototype,"sources",void 0);f([e.property()],b.prototype,"suggestionDelay",void 0);f([e.property({readOnly:!0})],b.prototype,"suggestions",void 0);f([e.property()],b.prototype,"view",void 0);f([e.property()],b.prototype,"zoomScale",void 0);return b=f([e.subclass("esri.widgets.Search.SearchViewModel")],b)});