// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/Error ../../../core/lang ../../../core/promiseUtils ../../../geometry/support/scaleUtils ./geometryUtils".split(" "),function(P,u,x,F,k,G,H){function y(a,b){var c=a.filter,f=a.searchExtent;b=b.extent;a=a.withinViewEnabled&&b?b:void 0;return c&&c.geometry||f||a}function A(a){return a?("not-loaded"===a.loadStatus?a.load():a).then(k.resolve).otherwise(k.reject):k.resolve()}function B(a){return a&&!!a.get("capabilities.query.supportsPagination")}function C(a){var b=
"";a&&a.fields.some(function(a){if("string"===a.type)return b=a.name,!0});return b}function z(a,b){return a&&b?b.every(function(b){return!!a.getField(b)}):!1}function I(a){for(var b=0;b<a.length;b++)if(255<a.charCodeAt(b))return!0;return!1}function J(a,b,c){var f=null;(a=a.codedValues)&&a.some(function(a){var g=a.name,g=c?g:g.toLowerCase();if((c?b:b.toLowerCase())===g)return f=a.code.toString(),!0});return f}function r(a,b){return(b=b&&b.where)?"("+a+") AND ("+b+")":a}function D(a,b,c,f,p){var g=
"";if(a){var d=K.test(b.url)&&I(a)?"N":"";c&&c.forEach(function(c){var e=b.getField(c);c=((c=b.getFieldDomain(c))&&"coded-value"===c.type?J(c,a,p):null)||a||null;if(null!==c){var l=e.type,e=e.name;"string"===l||"date"===l?p?e=r(e+" \x3d "+d+"'"+c+"'",f):(c=c.toUpperCase(),e=r("UPPER("+e+") LIKE "+d+"'%"+c+"%'",f)):"oid"===l||"small-integer"===l||"integer"===l||"single"===l||"double"===l?(c=parseFloat(c),e=isNaN(c)?null:r(e+" \x3d "+c,f)):e=r(e+" \x3d "+c,f);e&&(g+=g?" OR ("+e+")":"("+e+")")}})}return g}
function L(a,b){var c=null;(a=a.codedValues)&&a.length&&a.some(function(a){if(a.code===b)return c=a.name,!0});return c}function E(a,b,c,f){var p=a.attributes;f=a.layer.getFieldDomain(c);return b?F.substitute(p,b):c&&a.hasOwnProperty("attributes")&&p.hasOwnProperty(c)?(a=p[c],f&&"coded-value"===f.type?L(f,a):a):""}function M(a,b,c,f){return a.features.map(function(a){var g=a.attributes[a.layer.objectIdField];return{text:E(a,b.suggestionTemplate,f,b),key:g,sourceIndex:c}})}function N(a,b,c,f,k,g,d){return a.features.map(function(a){var e=
a.clone();a=E(a,c.searchTemplate,k,c);return{extent:H.createExtentFromGeometry(e.geometry,b,g,d),feature:e,name:a,sourceIndex:f}})}Object.defineProperty(u,"__esModule",{value:!0});var K=/https?:\/\/services.*\.arcgis\.com/i,O=/(?:\{([^}]+)\})/g;u.getResults=function(a){var b=a.exactMatch,c=void 0===b?!1:b,f=a.location,p=a.maxResults,g=a.spatialReference,d=a.source,r=a.sourceIndex,e=a.suggestResult,l=a.view,v=a.zoomScale,h=d.featureLayer,m=d.filter,q=l&&l.scale,w=y(d,l);return A(h).then(function(){var a=
d.displayField||d.featureLayer.displayField||C(d.featureLayer);if(!h.getField(a))return k.reject(new x("searchfeaturelayerutils:invalid-field","displayField is invalid."));var b=d.outFields||[a];if(!(b&&1===b.length&&"*"===b[0]||z(h,b)))return k.reject(new x("searchfeaturelayerutils:invalid-field","outField is invalid."));var n=h.createQuery(),t=d.searchQueryParams;t&&n.set(t);g&&(n.outSpatialReference=g,t=G.getUnitValueForSR(g))&&(n.maxAllowableOffset=t);n.returnGeometry=!0;b&&(n.outFields=b);if(f)n.geometry=
f;else if(e.key)n.objectIds=[parseInt(e.key,10)];else{b=d.searchFields||[a];if(!z(h,b))return k.reject(new x("searchfeaturelayerutils:invalid-field","search field is invalid."));B(h)&&(n.num=p);w&&(n.geometry=w);t=e.text.trim();if(!t)return k.resolve();var u=d.prefix,y=d.suffix,t=(""+(void 0===u?"":u)+t+(void 0===y?"":y)).replace(/\'/g,"''"),b=D(t,h,b,m,c);if(!b)return k.resolve();n.where=b}return h.queryFeatures(n).then(function(b){return N(b,l,d,r,a,q,v)})})};u.getSuggestions=function(a){var b=
a.source,c=a.spatialReference,f=a.suggestTerm,p=a.maxSuggestions,g=a.sourceIndex,d=b.featureLayer,u=b.filter,e=y(b,a.view);return A(d).then(function(){if(!B(d))return k.resolve();var a=b.displayField||b.featureLayer.displayField||C(b.featureLayer),v=b.searchFields||[a],h=[];b.suggestionTemplate?b.suggestionTemplate.replace(O,function(a,b){h.push(b);return a}):h.push(a);-1===h.indexOf(d.objectIdField)&&h.push(d.objectIdField);var m=!!d.getField(a),q=h&&1===h.length&&"*"===h[0]||z(d,h),w=z(d,v);if(!m)return k.reject(new x("searchfeaturelayerutils:invalid-field",
"displayField is invalid."));if(!q)return k.reject(new x("searchfeaturelayerutils:invalid-field","outField is invalid."));if(!w)return k.reject(new x("searchfeaturelayerutils:invalid-field","search field is invalid."));m=d.createQuery();(q=b.suggestQueryParams)&&m.set(q);m.outSpatialReference=c;m.returnGeometry=!1;m.num=p;m.outFields=h;e&&(m.geometry=e);q=f.trim();if(!q)return k.resolve();var w=b.prefix,r=b.suffix,q=(""+(void 0===w?"":w)+q+(void 0===r?"":r)).replace(/\'/g,"''"),v=D(q,d,v,u,!1);if(!v)return k.resolve();
m.where=v;return d.queryFeatures(m).then(function(c){return M(c,b,g,a)})})}});