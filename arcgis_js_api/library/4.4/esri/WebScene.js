// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
require({cache:{"esri/core/Version":function(){define(["require","exports","./Error"],function(a,c,l){Object.defineProperty(c,"__esModule",{value:!0});a=function(){function b(b,a,c){void 0===c&&(c="");this.major=b;this.minor=a;this._context=c}b.prototype.validate=function(b){if(this.major!==b.major)throw new l((this._context&&this._context+":")+"unsupported-version","Required major "+(this._context&&this._context+" ")+"version is '"+this.major+"', but got '${version.major}.${version.minor}'",{version:b});
};b.parse=function(a,d){void 0===d&&(d="");var c=a.split("."),e=c[0],c=c[1],k=/^\s*\d+\s*$/;if(!e||!e.match||!e.match(k))throw new l((d&&d+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:a});if(!c||!c.match||!c.match(k))throw new l((d&&d+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:a});a=parseInt(e,10);e=parseInt(c,10);return new b(a,e,d)};return b}();c.Version=a})},"esri/core/accessorSupport/originUtils":function(){define(["require",
"exports","../MultiOriginJSONSupport"],function(a,c,l){Object.defineProperty(c,"__esModule",{value:!0});c.updateOrigins=function(b){b&&b.writtenProperties&&b.writtenProperties.forEach(function(b){var a=b.target;b.newOrigin&&b.oldOrigin!==b.newOrigin&&a.isInstanceOf(l)&&a.updateOrigin(b.propName,b.newOrigin)})}})},"esri/support/webSceneUtils":function(){define(["require","exports","../core/Error"],function(a,c,l){Object.defineProperty(c,"__esModule",{value:!0});c.createCopyError=function(){return new l("webscene:failed-to-copy-embedded-resources",
"Copying of embedded resources is currently not supported")};c.isCopyError=function(b){return b&&"webscene:failed-to-copy-embedded-resources"===b.name}})},"esri/geometry/support/castUtils":function(){define(["../Point","../Polyline","../Polygon","../Multipoint","../Extent"],function(a,c,l,b,e){return{cast:function(d){return!d||d.declaredClass?d||null:void 0!==d.x&&void 0!==d.y?new a(d):void 0!==d.paths?new c(d):void 0!==d.rings?new l(d):void 0!==d.points?new b(d):void 0!==d.xmin&&void 0!==d.ymin&&
void 0!==d.xmax&&void 0!==d.ymax?new e(d):null}}})},"esri/webscene/Presentation":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/JSONSupport ../core/Collection ../core/collectionUtils ../core/accessorSupport/decorators ./Slide".split(" "),function(a,c,l,b,e,d,f,q,k){var p=d.ofType(k);a=function(b){function a(a){a=b.call(this,a)||this;a.slides=new p;return a}l(a,b);Object.defineProperty(a.prototype,"slides",{set:function(b){this._set("slides",
f.referenceSetter(b,this._get("slides"),p))},enumerable:!0,configurable:!0});a.prototype.clone=function(){return new this.constructor({slides:this.slides.clone()})};a.sanitizeJSON=function(b){return{slides:void 0!==b.slides&&Array.isArray(b.slides)?b.slides.filter(function(b){return b&&!!b.viewpoint}).map(function(b){return k.sanitizeJSON(b)}):[]}};return a}(q.declared(e));b([q.property({type:p,json:{write:!0}}),q.cast(f.castForReferenceSetter)],a.prototype,"slides",null);return a=b([q.subclass("esri.webscene.Presentation")],
a)})},"esri/webscene/Slide":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/accessorSupport/decorators ../Viewpoint ../Basemap ../support/basemapUtils ../core/JSONSupport ../core/lang ../core/Logger ../core/Collection ../core/collectionUtils ../core/promiseUtils ./Environment ./Lighting ./support/Description ./support/Title ./support/Thumbnail dojo/_base/lang dojo/promise/all ../views/3d/lib/glMatrix".split(" "),function(a,c,l,b,e,
d,f,q,k,p,v,r,K,u,A,F,G,H,B,C,L,M){var N=0,w=y=function(b){function a(){var m=null!==b&&b.apply(this,arguments)||this;m.id="";return m}l(a,b);a.prototype.clone=function(){return new y({id:this.id})};return a}(e.declared(k));b([e.property({type:String,json:{write:!0}})],w.prototype,"id",void 0);var w=y=b([e.subclass()],w),D=r.ofType(w),x=v.getLogger("esri.webscene.Slide");a=function(b){function a(a){a=b.call(this,a)||this;a._currentAnimation=null;a.id=Date.now().toString(16)+"-slide-"+N++;a.title=
new H.default;a.description=new G.default;a.thumbnail=new B.default;a.viewpoint=null;a.basemap=null;a.environment=new A;a.visibleLayers=new D;return a}l(a,b);a.prototype.readBasemap=function(a,b,c){if(!b.baseMap)return null;a=new f;a.resourceInfo=b.baseMap;a.read(b.baseMap,c);return a};a.prototype.writeBasemap=function(a,b,c,d){b.baseMap||(b.baseMap={});a.write(b.baseMap,d)};a.prototype.castBasemap=function(a){return q.ensureType(a)};Object.defineProperty(a.prototype,"visibleLayers",{set:function(a){this._set("visibleLayers",
K.referenceSetter(a,this._get("visibleLayers"),D))},enumerable:!0,configurable:!0});a.prototype.castVisibleLayers=function(a){return a&&"function"===typeof a.map?a.map(function(a){if("string"===typeof a)return{id:a};if(a.id)return{id:a.id};x.warn('Invalid visible layer, expected { id }, Layer or "id"');return a}):a};a.prototype.clone=function(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||
null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})};a.prototype._updateVisibleLayersFrom=function(a){var b=this,m=[];return u.eachAlways(this._allLayers(a.map).map(function(b){return a.whenLayerView(b).then(function(a){a.visible&&m.push(new w({id:a.layer.id}))})}).toArray()).then(function(){b.visibleLayers.removeAll();b.visibleLayers.addMany(m)})};
a.prototype.updateFrom=function(a,b){var m=this;b=C.mixin({screenshot:C.mixin({format:"jpeg",quality:80,width:120,height:75},b&&b.screenshot)},b);return a.then(function(){m.viewpoint=a.viewpoint.clone();m.environment.lighting=F.prototype.clone.apply(a.environment.lighting);m.basemap=a.map.basemap&&a.map.basemap.clone()||null;return m._updateVisibleLayersFrom(a)}).then(function(){return a.takeScreenshot(b.screenshot)}).then(function(a){m.thumbnail=new B.default({url:a.dataURL});return m})};a.prototype.applyTo=
function(a,b){var m=this,c=C.mixin({animate:!0},b);return this._applyBasemap(a).then(function(){return L([m._applyViewpoint(a,c),m._applyLayerVisibility(a,c)])}).then(function(){return m})};a.prototype._applyBasemap=function(a){var b=this;return this.basemap?this.basemap.load().always(function(){a.map.basemap=q.clonePreservingTiledLayers(b.basemap,a.map.basemap)}):u.resolve()};a.prototype._allLayers=function(a){var b=new r;this._collectLayers(a,b);this._collectLayers(a.ground,b);return b};a.prototype._collectLayers=
function(a,b){var c=this;a.layers.forEach(function(a){b.add(a);a.layers&&c._collectLayers(a,b)})};a.prototype._applyLayerVisibility=function(a,b){var c=this;if(this.visibleLayers){var m=this._allLayers(a.map);if(b.applyToLayerViews)return u.eachAlways(m.map(function(b){return a.whenLayerView(b).then(function(a){a.visible=c.visibleLayers.some(function(b){return b.id===a.layer.id})})}).toArray());m.forEach(function(a){return a.visible=c.visibleLayers.some(function(b){return b.id===a.id})});return u.resolve()}};
a.prototype._applyViewpoint=function(a,b){if(this.viewpoint){this.viewpoint.camera.fov=a.camera.fov;if(b.animate){if(this.get("environment.lighting.date"))return this._animateToLighting(a,b).then(function(){});a.environment.lighting=this.environment.lighting.clone();return a.goTo(this.viewpoint,b).then(function(){})}a.viewpoint=this.viewpoint;a.environment.lighting=this.environment.lighting.clone()}return u.resolve()};a.prototype._animateToLighting=function(a,b){var c=this,d;"global"===a.viewingMode&&
(d=this._animateLightingWithCamera(a));this._currentAnimation&&(this._currentAnimation.stop(),this._currentAnimation=null);a.environment.lighting.cameraTrackingEnabled=!1;a.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled;null!=this.environment.lighting.displayUTCOffset&&(a.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);var m=a.goTo(this.viewpoint,b);this._currentAnimation=m;this._currentAnimation.always(function(){d&&d.remove();
c._currentAnimation===m&&(a.environment.lighting.cameraTrackingEnabled=!0)});this._currentAnimation.then(function(){a.environment.lighting=c.environment.lighting.clone()});return this._currentAnimation};a.prototype._getTime=function(a){var b=a.getTime();a=3600*a.getUTCHours()+60*a.getUTCMinutes()+a.getUTCSeconds();return[b,a]};a.prototype._setTime=function(a,b,c){a.setTime(b);a.setUTCHours(c/3600);a.setUTCMinutes(c%3600/60);a.setUTCSeconds(c%3600%60);return a};a.prototype._animateLightingWithCamera=
function(a){var b=this,c=M.vec3d,d=this._getTime(new Date(a.environment.lighting.date.toString())),k=d[0],p=d[1],d=this._getTime(this.environment.lighting.date),f=d[0],e=d[1],O=a.renderCoordsHelper,g=[0,0,0];O.toRenderCoords(a.camera.position,g);var n=[0,0,0];O.toRenderCoords(this.viewpoint.camera.position,n);var z=[0,0,0],m=new Date;return a.watch("camera",function(d){O.toRenderCoords(d.position,z);d=c.dist2(g,z);var S=c.dist2(n,z),P=0;0!==d+S&&(P=d/(d+S));a.environment.lighting.date=b._setTime(m,
k+(f-k)*P,p+(e-p)*P)})};a.createFrom=function(a,b){return(new this).updateFrom(a,b)};a.sanitizeJSON=function(a){var b;b=void 0!==a.visibleLayers&&Array.isArray(a.visibleLayers)?p.clone(a.visibleLayers):[];b={id:a.id||"",title:a.title||{text:""},thumbnail:a.thumbnail||{url:""},viewpoint:a.viewpoint,baseMap:a.baseMap,visibleLayers:b};void 0!==a.description&&(b.description=a.description);void 0!==a.environment&&(b.environment=A.sanitizeJSON(a.environment));return b};return a}(e.declared(k));b([e.property({json:{write:!0}})],
a.prototype,"id",void 0);b([e.property({type:H.default,json:{write:!0}})],a.prototype,"title",void 0);b([e.property({type:G.default,json:{write:!0}})],a.prototype,"description",void 0);b([e.property({type:B.default,json:{write:!0}})],a.prototype,"thumbnail",void 0);b([e.property({type:d,json:{write:!0}})],a.prototype,"viewpoint",void 0);b([e.property({json:{write:{target:"baseMap"}}})],a.prototype,"basemap",void 0);b([e.reader("basemap",["baseMap"])],a.prototype,"readBasemap",null);b([e.writer("basemap")],
a.prototype,"writeBasemap",null);b([e.cast("basemap")],a.prototype,"castBasemap",null);b([e.property({type:D,json:{write:!0}})],a.prototype,"visibleLayers",null);b([e.cast("visibleLayers")],a.prototype,"castVisibleLayers",null);b([e.property({type:A,json:{write:!0}})],a.prototype,"environment",void 0);a=b([e.subclass("esri.webscene.Slide")],a);var y;return a})},"esri/webscene/Environment":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/JSONSupport ../core/accessorSupport/decorators ./Lighting".split(" "),
function(a,c,l,b,e,d,f){a=q=function(a){function b(b){b=a.call(this,b)||this;b.lighting=new f;return b}l(b,a);b.prototype.clone=function(){return new q({lighting:f.prototype.clone.call(this.lighting)})};b.sanitizeJSON=function(a){return{lighting:a.lighting?f.sanitizeJSON(a.lighting):(new f).toJSON()}};return b}(d.declared(e));b([d.property({type:f,json:{write:!0}})],a.prototype,"lighting",void 0);a=q=b([d.subclass("esri.webscene.Environment")],a);var q;return a})},"esri/webscene/Lighting":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/JSONSupport ../core/accessorSupport/decorators".split(" "),
function(a,c,l,b,e,d){a=f=function(a){function b(b){b=a.call(this,b)||this;b.date=null;b.directShadowsEnabled=!1;b.displayUTCOffset=null;return b}l(b,a);b.prototype.readDate=function(a,b){return null!=b.datetime&&new Date(b.datetime)||null};b.prototype.writeDate=function(a,b){null!=a&&(b.datetime=a.getTime())};b.prototype.readDirectShadowsEnabled=function(a,b){return!!b.directShadows};b.prototype.writedirectShadowsEnabled=function(a,b){a&&(b.directShadows=!0)};b.prototype.writeDisplayUTCOffset=function(a,
b){null!=a&&(b.displayUTCOffset=a)};b.prototype.clone=function(){return new f({date:null!=this.date?new Date(this.date.getTime()):null,directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null})};b.sanitizeJSON=function(a){var b={datetime:a.datetime};void 0!==a.directShadows&&(b.directShadows=!!a.directShadows);void 0!==a.displayUTCOffset&&(b.displayUTCOffset=a.displayUTCOffset);return b};return b}(d.declared(e));b([d.property({type:Date})],
a.prototype,"date",void 0);b([d.reader("date",["datetime"])],a.prototype,"readDate",null);b([d.writer("date")],a.prototype,"writeDate",null);b([d.property({type:Boolean})],a.prototype,"directShadowsEnabled",void 0);b([d.reader("directShadowsEnabled",["directShadows"])],a.prototype,"readDirectShadowsEnabled",null);b([d.writer("directShadowsEnabled")],a.prototype,"writedirectShadowsEnabled",null);b([d.property({type:Number,json:{write:!0}})],a.prototype,"displayUTCOffset",void 0);b([d.writer("displayUTCOffset")],
a.prototype,"writeDisplayUTCOffset",null);a=f=b([d.subclass("esri.webscene.Lighting")],a);var f;return a})},"esri/webscene/support/Description":function(){define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/JSONSupport ../../core/accessorSupport/decorators".split(" "),function(a,c,l,b,e,d){Object.defineProperty(c,"__esModule",{value:!0});a=f=function(a){function b(){var b=null!==a&&a.apply(this,arguments)||this;b.text="";return b}l(b,a);
b.prototype.clone=function(){return new f({text:this.text})};return b}(d.declared(e));b([d.property({type:String,json:{write:!0}})],a.prototype,"text",void 0);a=f=b([d.subclass("esri.webscene.support.Description")],a);c.default=a;var f})},"esri/webscene/support/Title":function(){define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/JSONSupport ../../core/accessorSupport/decorators".split(" "),function(a,c,l,b,e,d){Object.defineProperty(c,
"__esModule",{value:!0});a=f=function(a){function b(){var b=null!==a&&a.apply(this,arguments)||this;b.text="";return b}l(b,a);b.prototype.clone=function(){return new f({text:this.text})};return b}(d.declared(e));b([d.property({type:String,json:{write:!0}})],a.prototype,"text",void 0);a=f=b([d.subclass("esri.webscene.support.Title")],a);c.default=a;var f})},"esri/webscene/support/Thumbnail":function(){define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/JSONSupport ../../core/accessorSupport/decorators".split(" "),
function(a,c,l,b,e,d){Object.defineProperty(c,"__esModule",{value:!0});a=f=function(a){function b(){var b=null!==a&&a.apply(this,arguments)||this;b.url="";return b}l(b,a);b.prototype.clone=function(){return new f({url:this.url})};return b}(d.declared(e));b([d.property({type:String,json:{write:!0}})],a.prototype,"url",void 0);a=f=b([d.subclass("esri.webscene.support.Thumbnail")],a);c.default=a;var f})},"esri/webscene/InitialViewProperties":function(){define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../Viewpoint ../core/Accessor ../geometry/HeightModelInfo ../geometry/SpatialReference ./Environment ../core/accessorSupport/decorators".split(" "),
function(a,c,l,b,e,d,f,q,k,p){a=v=function(a){function b(b){b=a.call(this,b)||this;b.environment=new k;b.spatialReference=null;b.heightModelInfo=null;b.viewpoint=null;return b}l(b,a);Object.defineProperty(b.prototype,"viewingMode",{set:function(a){"local"!==a&&"global"!==a||this._set("viewingMode",a)},enumerable:!0,configurable:!0});b.prototype.clone=function(){return new v({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,
viewpoint:this.viewpoint?this.viewpoint.clone():null})};return b}(p.declared(d));b([p.property({type:k})],a.prototype,"environment",void 0);b([p.property({type:q})],a.prototype,"spatialReference",void 0);b([p.property({type:f})],a.prototype,"heightModelInfo",void 0);b([p.property()],a.prototype,"viewingMode",null);b([p.property({type:e})],a.prototype,"viewpoint",void 0);a=v=b([p.subclass("esri.webscene.InitialViewProperties")],a);var v;return a})},"*noref":1}});
define("require exports ./core/tsSupport/declareExtendsHelper ./core/tsSupport/decorateHelper ./core/tsSupport/paramHelper ./Map ./core/Error ./core/requireUtils ./core/promiseUtils ./core/JSONSupport ./core/Loadable ./core/urlUtils ./core/Logger ./core/Version ./core/accessorSupport/read ./core/accessorSupport/originUtils ./support/groundUtils ./support/webSceneUtils ./Basemap ./Viewpoint ./kernel ./geometry/support/jsonUtils ./geometry/support/castUtils ./geometry/Geometry ./geometry/HeightModelInfo ./geometry/SpatialReference ./webscene/Presentation ./webscene/InitialViewProperties ./webscene/Environment ./portal/PortalItem ./portal/Portal dojo/has dojo/_base/lang ./core/accessorSupport/decorators".split(" "),function(a,
c,l,b,e,d,f,q,k,p,v,r,K,u,A,F,G,H,B,C,L,M,N,w,D,x,y,Q,R,m,I,T,t,h){var E=K.getLogger("esri.webscene"),J=new u.Version(1,7,"webscene");c=function(b){function c(a){a=b.call(this)||this;a.basemapElevationLayerIds=[];a.clippingArea=null;a.clippingEnabled=!1;a.sourceVersion=null;a.presentation=null;a.initialViewProperties=null;a.portalItem=null;a.resourceInfo=null;a.authoringApp=null;a.authoringAppVersion=null;a._isAuthoringAppSetByUser=!1;a._isAuthoringAppVersionSetByUser=!1;return a}l(c,b);c.prototype.initialize=
function(){this.otherwise(function(a){E.error("#load()","Failed to load web scene",a)});if(this.resourceInfo){var a=void 0;try{a=this._validateJSON(this.resourceInfo)}catch(n){this.addResolvingPromise(k.reject(n));return}this.read(a);this.addResolvingPromise(this._validateSpatialReference())}};c.prototype.getDefaults=function(a){return t.mixin(this.inherited(arguments),{presentation:{},initialViewProperties:{}})};c.prototype.readBasemap=function(a,b,c){if(!b.baseMap)return null;a=t.mixin({},b.baseMap);
delete a.elevationLayers;b=new B;b.resourceInfo=a;b.read(a,{origin:"web-scene",portal:c&&c.portal});return b};c.prototype.writeBasemap=function(a,b,c,d){var g=this;a&&(b.baseMap||(b.baseMap={}),a.write(b.baseMap,d),b.baseMap.elevationLayers=[]);this.ground&&(a=this.ground.layers.filter(function(a){return!g._groundLayerIsOperational(a)&&g.verifyWriteLayer(a,d)}).map(function(a){return a.write(null,d)}),0<a.length&&(b.baseMap||(b.baseMap={id:"basemap",title:"Basemap"}),b.baseMap.elevationLayers=a.toArray()))};
c.prototype.readClippingArea=function(a){return a&&a.geometry?M.fromJSON(a.geometry):null};c.prototype.writeClippingArea=function(a,b){b.clippingArea||(b.clippingArea={});b.clippingArea.geometry=a.toJSON()};c.prototype.readClippingEnabled=function(a,b){return b.clippingArea?!!b.clippingArea.clip:!1};c.prototype.writeClippingEnabled=function(a,b){this.clippingArea&&(b.clippingArea||(b.clippingArea={}),b.clippingArea.clip=a)};c.prototype.writeLayers=function(a,b,c,d){var g=this,n=t.mixin({},d,{layerContainerType:"ground"}),
z=t.mixin({},d,{layerContainerType:"operational-layers"});c=this.ground.layers.filter(function(a){return g._groundLayerIsOperational(a)&&g.verifyWriteLayer(a,n)}).map(function(a){return a.write(null,n)});c.addMany(a.filter(function(a){return g.verifyWriteLayer(a,z)}).map(function(a){return a.write(null,z)}));c=c.filter(function(a){return!!a});b.operationalLayers=c.toArray()};c.prototype.verifyWriteLayer=function(a,b){return a.write?!0:(b&&b.messages.push(new f("layer:unsupported","Layers ("+a.title+
", "+a.id+") of type '"+a.declaredClass+"' cannot be persisted in web scenes",{layer:a})),!1)};c.prototype.readSourceVersion=function(a,b){a=b.version.split(".");b=a[1];return{major:parseInt(a[0],10),minor:parseInt(b,10)}};c.prototype.writeSourceVersion=function(a,b){b.version=J.major+"."+J.minor};Object.defineProperty(c.prototype,"authoringApp",{set:function(a){this._isAuthoringAppSetByUser=!0;this._set("authoringApp",a)},enumerable:!0,configurable:!0});c.prototype.writeAuthoringApp=function(a,b){b.authoringApp=
a&&this._isAuthoringAppSetByUser?a:"ArcGIS API for JavaScript"};Object.defineProperty(c.prototype,"authoringAppVersion",{set:function(a){this._isAuthoringAppVersionSetByUser=!0;this._set("authoringAppVersion",a)},enumerable:!0,configurable:!0});c.prototype.writeAuthoringAppVersion=function(a,b){b.authoringAppVersion=a&&this._isAuthoringAppVersionSetByUser?a:L.version};c.prototype.writePresentation=function(a,b,c,d){var g=this;a=a.write({},d);a.slides.forEach(function(a){a.visibleLayers=a.visibleLayers.filter(function(a){var b=
g.ground.layers.find(function(b){return b.id===a.id});return!b||g._groundLayerIsOperational(b)})});b.presentation=a};c.prototype.readInitialViewProperties=function(a,b){a={};b.initialState&&b.initialState.environment&&(a.environment=R.fromJSON(b.initialState.environment));b.spatialReference&&(a.spatialReference=x.fromJSON(b.spatialReference));b.heightModelInfo&&(a.heightModelInfo=D.fromJSON(b.heightModelInfo));a.viewingMode=b.viewingMode||"global";b.initialState&&b.initialState.viewpoint&&(a.viewpoint=
C.fromJSON(b.initialState.viewpoint));return new Q(a)};c.prototype.writeInitialViewProperties=function(a,b,c,d){a&&(c={},a.environment&&(c.environment=a.environment.write({},d)),a.viewpoint&&(c.viewpoint=a.viewpoint.toJSON()),0!==Object.keys(c).length&&(b.initialState=c),b.spatialReference=a.spatialReference?a.spatialReference.toJSON():x.WebMercator.toJSON(),b.viewingMode=null!=a.viewingMode?a.viewingMode:"global")};c.prototype.load=function(){this.addResolvingPromise(this._loadFromSource());return this};
c.prototype.read=function(a,b){var c=this;b=t.mixin({},b,{origin:"web-scene"});var g=this._isAuthoringAppVersionSetByUser,n=this._isAuthoringAppSetByUser,d=arguments;A.readLoadable(this,a,function(b){return c.inherited(d,[a,b])},b);n||(this._isAuthoringAppSetByUser=!1);g||(this._isAuthoringAppVersionSetByUser=!1);if(a.baseMap&&Array.isArray(a.baseMap.elevationLayers)){var f=a.baseMap.elevationLayers.map(function(a){return{id:a.id}});this.presentation.slides.forEach(function(a){a.visibleLayers.addMany(f)})}return this};
c.prototype.write=function(a,b){if("loaded"!==this.loadStatus){var c=new f("webscene:not-loaded","Web scene must be loaded before it can be serialized");E.error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus);throw c;}b=t.mixin({},b,{origin:"web-scene"});return this.inherited(arguments,[a,b])};c.prototype.save=function(a){var b=this;if(!this.portalItem)return E.error("save(): requires the .portalItem property to be set"),k.reject(new f("webscene:portal-item-not-set",
"Portal item to save to has not been set on the WebScene"));if("Web Scene"!==this.portalItem.type)return k.reject(new f("webscene:portal-item-wrong-type",'Portal item needs to have type "Web Scene"'));var c,g;return this.load().then(function(){return b._loadBasemaps()}).then(function(){c=b._enableVerifyItemRelativeUrls({origin:"web-scene",url:b.portalItem.itemUrl&&r.urlToObject(b.portalItem.itemUrl),messages:[],portal:b.portalItem.portal||I.getDefault(),writtenProperties:[],blockedRelativeUrls:[]});
g=b.write(null,c);return b._verifySave(g,c,a).then(function(){b._updateTypeKeywords(b.portalItem);return b.portalItem.update({data:g})})}).then(function(){F.updateOrigins(c);return k.resolve(b.portalItem)})};c.prototype.saveAs=function(a,b){var c=this;if(!a)return E.error("saveAs(portalItem): requires a portal item parameter"),k.reject(new f("webscene:portal-item-required","saveAs requires a portal item to save to"));if(a.type&&"Web Scene"!==a.type||a.id)return k.reject(new f("webscene:portal-item-already-exists",
"WebScene can only saveAs to a new and empty portal item"));var g=a.portal||I.getDefault(),d,n;return this.load().then(function(){return c._loadBasemaps()}).then(function(){d=c._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:g,writtenProperties:[],blockedRelativeUrls:[]});n=c.write(null,d);return c._verifySaveAs(n,d,b).then(function(){return g._signIn()})}).then(function(){a.type="Web Scene";a.portal=g;c._updateTypeKeywords(a);return g.user.addItem({item:a,folder:b&&
b.folder,data:n})}).then(function(){c.portalItem=a;p.prototype.read.call(c,{version:n.version,authoringApp:n.authoringApp,authoringAppVersion:n.authoringAppVersion},{name:"web-scene",url:a.itemUrl&&r.urlToObject(a.itemUrl)});F.updateOrigins(d);return k.resolve(a)})};c.prototype._verifySave=function(b,c,d,e){void 0===e&&(e=!1);var g=c.messages.filter(function(a){return"error"===a.type}).map(function(a){return new f(a.name,a.message,a.details)});c.blockedRelativeUrls&&(g=g.concat(c.blockedRelativeUrls.map(function(a){return new f("url:unsupported",
"Relative url '"+a+"' is not supported in Web Scene")})));d&&d.ignoreUnsupported&&(g=g.filter(function(a){return"layer:unsupported"!==a.name&&"symbol:unsupported"!==a.name&&"property:unsupported"!==a.name}));var n=d&&d.strictSchemaValidationEnabled;return(n?q.when(a,"./webscene/validator").then(function(a){a=a.validate(b);if(0<a.length){var c="webscene did not validate: "+a.join(", ");E.error((e?"saveAs":"save")+"(): "+c)}return n?g.concat(a.map(function(a){return new f("webscene:schema-validation",
a)})):g}):k.resolve(g)).then(function(a){if(0<a.length)return k.reject(new f("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:a}))})};c.prototype._verifySaveAs=function(a,b,c){return b.verifyItemRelativeUrls&&0<b.verifyItemRelativeUrls.writtenUrls.length?k.reject(H.createCopyError()):this._verifySave(a,b,c,!0)};c.prototype.verifySaveAs=function(a){var b=this._enableVerifyItemRelativeUrls({origin:"web-scene",
messages:[]}),c=this.write(null,b);return this._verifySaveAs(c,b,a)};c.prototype.updateFrom=function(a,b){void 0===b&&(b={});b.environmentExcluded||(this.initialViewProperties.environment=R.prototype.clone.apply(a.environment));b.viewpointExcluded||(this.initialViewProperties.viewpoint=a.viewpoint.clone());this.initialViewProperties.spatialReference=a.spatialReference.clone();this.initialViewProperties.viewingMode=a.viewingMode;a.clippingArea?a.clippingArea!==this.clippingArea&&(this.clippingArea=
a.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1;this.initialViewProperties.heightModelInfo=a.heightModelInfo?a.heightModelInfo.clone():null;a.map===this&&a.allLayerViews.forEach(function(a){a.layer.visible=a.visible})};c.prototype.isDefaultGroundLayer=function(a){var b=G.groundElevationLayers["world-elevation"];return a.id===b.id&&r.normalize(a.url)===r.normalize(b.url)};c.prototype._groundLayerIsOperational=function(a){return"esri.layers.ElevationLayer"!==a.declaredClass||
-1===this.basemapElevationLayerIds.indexOf(a.id)&&!this.isDefaultGroundLayer(a)||this.presentation.slides.some(function(b){return!b.visibleLayers.some(function(b){return b.id===a.id})})?!0:!1};c.prototype._loadFromSource=function(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadBasemaps()};c.prototype._readAndLoadFromJSON=function(a,b){a=this._validateJSON(a,b&&b.url&&b.url.path);
this.read(a,b);return this._loadFromJSON(a,b)};c.prototype._loadFromJSON=function(b,c){var d=this;return this._validateSpatialReference().then(function(){return q.when(a,"./portal/support/layersCreator")}).then(function(a){var g=[],n=b.operationalLayers,f=[];b.baseMap&&Array.isArray(b.baseMap.elevationLayers)&&(f.push.apply(f,b.baseMap.elevationLayers),d.basemapElevationLayerIds=b.baseMap.elevationLayers.map(function(a){return a.id}));var e=function(a){a.layers&&(a.layers=a.layers.filter(e));return"ArcGISTiledElevationServiceLayer"===
a.layerType?(f.push(a),!1):!0};n&&(n=n.filter(e));var h={context:t.mixin({},c,{layerContainerType:"operational-layers"})};d.portalItem&&(h.context.portal=d.portalItem.portal||I.getDefault());if(0<f.length){var l=t.mixin({},h,{context:t.mixin({},h.context,{layerContainerType:"ground"})});l.defaultLayerType="ArcGISTiledElevationServiceLayer";g.push.apply(g,a.populateOperationalLayers(d.ground.layers,f,l))}n&&0<n.length&&g.push.apply(g,a.populateOperationalLayers(d.layers,n,h));return k.eachAlways(g).then(function(){})}).then(function(){return d._loadBasemaps()})};
c.prototype._loadBasemaps=function(){var a=[];this.basemap&&a.push(this.basemap.load());this.presentation.slides.forEach(function(b){b.basemap&&a.push(b.basemap.load())});return k.eachAlways(a).then(function(){})};c.prototype._loadFromItem=function(a){var b=this;return a.load().otherwise(function(a){throw new f("webscene:load-portal-item","Failed to load portal item",{error:a});}).then(function(){if("Web Scene"!==a.type)throw new f("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",
{type:a.type});}).then(function(){return a.fetchData()}).then(function(c){b.resourceInfo=c;return b._readAndLoadFromJSON(c,{origin:"web-scene",url:r.urlToObject(a.itemUrl),portal:a.portal||I.getDefault()})})};c.prototype._validateSpatialReference=function(){var a=this.initialViewProperties,b=a.spatialReference||x.WebMercator,c;if("local"!==a.viewingMode){if(!b.isWGS84&&!b.isWebMercator)return k.reject(new f("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator or WGS84 GCS are supported",
{spatialReference:b,viewingMode:a.viewingMode}));c=function(a){return!a||a.isWGS84||a.isWebMercator}}else{if(b.isGeographic)return k.reject(new f("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:b,viewingMode:a.viewingMode}));c=function(a){return!a||a.equals(b)}}var d=function(a){return a&&(a.camera&&a.camera.position&&a.camera.position.spatialReference||a.targetGeometry&&
a.targetGeometry.spatialReference)},e=d(a.viewpoint);return e&&!c(e)?k.reject(new f("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:e,sceneSpatialReference:b,viewingMode:a.viewingMode})):(e=this.presentation.slides.find(function(a){return!c(d(a.viewpoint))}))?(e=d(e.viewpoint),k.reject(new f("webscene:incompatible-slide-spatial-reference",
"Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:e,sceneSpatialReference:b,viewingMode:a.viewingMode}))):k.resolve()};c.prototype._validateJSON=function(a,b){void 0===b&&(b=null);a=this._sanitizeJSON(a,b);b=u.Version.parse(a.version,"webscene");J.validate(b);a.version=b.major+"."+b.minor;1===b.major&&2>=b.minor&&(a.spatialReference=x.WebMercator.toJSON());return a};c.prototype._sanitizeJSON=
function(a,b){void 0===b&&(b=null);return{version:a.version||"",baseMap:a.baseMap,operationalLayers:a.operationalLayers,authoringApp:a.authoringApp||"",authoringAppVersion:a.authoringAppVersion||"",viewingMode:a.viewingMode||"global",presentation:a.presentation&&y.sanitizeJSON(a.presentation)||{},initialState:a.initialState,spatialReference:a.spatialReference||x.WebMercator.toJSON(),heightModelInfo:a.heightModelInfo||null,clippingArea:a.clippingArea}};c.prototype._updateTypeKeywords=function(a){"local"===
this.initialViewProperties.viewingMode?a.typeKeywords?-1===a.typeKeywords.indexOf("ViewingMode-Local")&&a.typeKeywords.push("ViewingMode-Local"):a.typeKeywords=["ViewingMode-Local"]:"global"===this.initialViewProperties.viewingMode&&a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter(function(a){return"ViewingMode-Local"!==a}));a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter(function(a,b,c){return c.indexOf(a)===b}))};Object.defineProperty(c.prototype,"_verifyItemRelativeRootPath",{get:function(){return this.portalItem&&
this.portalItem.itemUrl?r.urlToObject(this.portalItem.itemUrl).path:null},enumerable:!0,configurable:!0});c.prototype._enableVerifyItemRelativeUrls=function(a){var b=this._verifyItemRelativeRootPath;b&&(a.verifyItemRelativeUrls={rootPath:b,writtenUrls:[]});return a};c.fromJSON=function(a){return new this({resourceInfo:a})};return c}(h.declared(d,v,p));c.VERSION=J;b([h.property({json:{write:{allowNull:!0}}})],c.prototype,"basemap",void 0);b([h.reader("basemap",["baseMap"])],c.prototype,"readBasemap",
null);b([h.writer("basemap")],c.prototype,"writeBasemap",null);b([h.property({type:w}),h.cast(N.cast)],c.prototype,"clippingArea",void 0);b([h.reader("clippingArea")],c.prototype,"readClippingArea",null);b([h.writer("clippingArea")],c.prototype,"writeClippingArea",null);b([h.property({type:Boolean})],c.prototype,"clippingEnabled",void 0);b([h.reader("clippingEnabled",["clippingArea"])],c.prototype,"readClippingEnabled",null);b([h.writer("clippingEnabled")],c.prototype,"writeClippingEnabled",null);
b([h.property()],c.prototype,"layers",void 0);b([h.writer("layers")],c.prototype,"writeLayers",null);b([h.property({readOnly:!0,json:{write:{allowNull:!0}}})],c.prototype,"sourceVersion",void 0);b([h.reader("sourceVersion",["version"])],c.prototype,"readSourceVersion",null);b([h.writer("sourceVersion")],c.prototype,"writeSourceVersion",null);b([h.property({type:String,json:{write:{allowNull:!0}}})],c.prototype,"authoringApp",null);b([h.writer("authoringApp")],c.prototype,"writeAuthoringApp",null);
b([h.property({type:String,json:{write:{allowNull:!0}}})],c.prototype,"authoringAppVersion",null);b([h.writer("authoringAppVersion")],c.prototype,"writeAuthoringAppVersion",null);b([h.property({type:y})],c.prototype,"presentation",void 0);b([h.writer("presentation")],c.prototype,"writePresentation",null);b([h.property({type:Q})],c.prototype,"initialViewProperties",void 0);b([h.reader("initialViewProperties",["initialState.environment","spatialReference","heightModelInfo","viewingMode","initialState.viewpoint"])],
c.prototype,"readInitialViewProperties",null);b([h.writer("initialViewProperties")],c.prototype,"writeInitialViewProperties",null);b([h.property({type:m})],c.prototype,"portalItem",void 0);b([h.property()],c.prototype,"resourceInfo",void 0);b([e(0,h.cast(m))],c.prototype,"saveAs",null);b([h.property()],c.prototype,"_verifyItemRelativeRootPath",null);return c=b([h.subclass("esri.WebScene")],c)});