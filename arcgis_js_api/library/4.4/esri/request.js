// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require dojo/_base/config dojo/Deferred dojo/_base/lang dojo/_base/url dojo/request dojo/io-query dojo/when ./kernel ./config ./core/global ./core/sniff ./core/lang ./core/urlUtils ./core/deferredUtils ./core/promiseUtils dojo/has!host-browser?dojo/io/script dojo/has!host-webworker?./core/workers/request".split(" "),function(S,y,D,l,H,z,A,T,m,U,V,n,B,p,W,I,X,J){function Y(a){var c=A.objectToQuery(a.content);c&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+c);if(2E3<a.url.length)return I.reject(l.mixin(Error(),
{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));var b=new Image;a.allowImageDataAccess&&(b.crossOrigin=a.withCredentials?"use-credentials":"anonymous");var e=!1,d=new D(function(a){e=!0;b.onload=b.onerror=b.onabort=null;b.src=""}),c=function(a){b.onload=b.onerror=b.onabort=null;e||d.reject(a)};b.onload=function(){b.onload=b.onerror=b.onabort=null;e||d.resolve(this)};b.onerror=c;b.onabort=c;b.alt="";b.src=a.url;return d.promise}function F(a){a=new H(a);return(a.host+
(a.port?":"+a.port:"")).toLowerCase()}function K(a,c){var b=!!a.useProxy,e=a.method||"auto",d=B.isDefined(a.crossOrigin)?a.crossOrigin:k.useCors;a=l.mixin({},a);a._ssl&&(a.url=a.url.replace(/^http:/i,"https:"));var E=a.content,r=a.url;a.load=function(a){var b;a&&(a.error?(b=l.mixin(Error(),a.error),b.log=!!y.isDebug):"error"===a.status&&(b=l.mixin(Error(),a),b.log=!!y.isDebug),b&&!B.isDefined(b.httpCode)&&(b.httpCode=b.code));return b||a};a.error=function(a,b){b&&b.xhr&&b.xhr.abort();a instanceof
Error||(a=l.mixin(Error(),a));a.log=!!y.isDebug;return a};a._token&&(a.content=a.content||{},a.content.token=a._token);var h=0,w;r&&(w=A.objectToQuery(E),h=w.length+r.length+1,n("esri-url-encodes-apostrophe")&&(h=w.replace(/'/g,"%27").length+r.length+1));a.timeout=B.isDefined(a.timeout)?a.timeout:k.timeout;a.handleAs=a.handleAs||"json";try{var q,t,C=d&&p.canUseXhr(a.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(a.url),v=p.hasSameOrigin(a.urlObj,p.appUrl)||C,u="post"===e||!!a.body||
h>k.maxUrlLength,L=!v&&-1!==a.handleAs.indexOf("json")&&a.callbackParamName&&!a.body,g=!!p.getProxyRule(a.url)||k.forceProxy||b||("image"!==a.handleAs||a.allowImageDataAccess)&&(!L||u)&&!v;if((n("host-browser")||n("host-webworker"))&&g)if(q=p.getProxyUrl(r,d),t=q.path,q._xo&&(C=!0),!u&&t.length+1+h>k.maxUrlLength&&(u=!0),a.url=t+"?"+r,u)a.content=l.mixin(q.query||{},E);else{var M=A.objectToQuery(l.mixin(q.query||{},E));M&&(a.url+=(-1===r.indexOf("?")?"?":"\x26")+M);a.content=null}if((n("host-browser")||
n("host-webworker"))&&L&&!u)return!B.isDefined(a.isAsync)&&4>n("ff")&&(a.isAsync=!0),X.get(x?x(a):a);var f=a.headers;!n("host-browser")&&!n("host-webworker")||f&&f.hasOwnProperty("X-Requested-With")||(f=a.headers=f||{},f["X-Requested-With"]=null);if(n("host-browser")&&c){var N=a.content&&a.content.token;N&&c.set("token",N);a.contentType=!1}if(C&&!a.hasOwnProperty("withCredentials")&&"with-credentials"===k.useCors){var b=g?t:r,G=p.getCorsConfig(b);if(G&&G.hasOwnProperty("withCredentials"))G.withCredentials&&
(a.withCredentials=!0);else if(m.id){var O=m.id.findServerInfo(b);O&&O.webTierAuth&&(a.withCredentials=!0)}}a=x?x(a):a;if("image"===a.handleAs)return Y(a);if(u)return a.body?(a.data=c||a.body,a.query=a.content):a.data=a.content,delete a.body,delete a.content,!g&&n("safari")&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+"_ts\x3d"+(new Date).getTime()+aa++),z.post(a.url,a);a.query=a.content;delete a.content;return z.get(a.url,a)}catch(Z){return c=new D,c.reject(a.error(Z)),c}}function P(a){var c=k.corsStatus,
b=p.getCorsConfig(a,!0);-1<b&&k.corsEnabledServers.splice(b,1);c[F(a)]=1;return b}function Q(a){var c=k.corsStatus;try{var b=F(a.url);if(k.corsDetection&&k.useCors&&n("esri-cors")&&a.url&&-1!==a.url.toLowerCase().indexOf("/rest/services")&&!p.hasSameOrigin(a.urlObj,p.appUrl)&&!p.canUseXhr(a.urlObj)){if(c[b])return c[b];var e=new D;c[b]=e.promise;var d=a.url.substring(0,a.url.toLowerCase().indexOf("/rest/")+6)+"info";z.get(d,{query:{f:"json"},handleAs:"json",headers:{"X-Requested-With":null},timeout:1E3*
k.corsDetectionTimeout}).then(function(c){c?(p.canUseXhr(a.url)||k.corsEnabledServers.push(b),e.resolve()):e.reject()},function(a){e.reject()});return e.promise}}catch(E){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}function v(a,c,b,e){function d(a){a._pendingDfd=K(b,t);if(a._pendingDfd){var c=!!a._pendingDfd.response;(a._pendingDfd.response||a._pendingDfd).then(function(a){if(!c||!a.data)return a;var b=a.getHeader("Content-Type");if(b&&(b=b.toLowerCase(),
-1===b.indexOf("text/plain")&&-1===b.indexOf("application/json")))return a;b=a.data;if(b instanceof ArrayBuffer&&750>=b.byteLength)b=new Blob([b]);else if(!(b instanceof Blob&&750>=b.size))return a;var f=new D,g=new FileReader;g.readAsText(b);g.onloadend=function(){if(!g.error)try{var b=JSON.parse(g.result);b.error&&(Object.isExtensible(a)||(a=l.mixin({},a)),a._jsonData=b)}catch(da){}f.resolve(a)};return f.promise}).then(function(b){var g=c?b.data:b,d=c?b.getHeader.bind(b):ba,f=null;a.ioArgs=a._pendingDfd&&
a._pendingDfd.ioArgs;if(g&&(b=c&&b._jsonData||g,b.error?(f=l.mixin(Error(),b.error),f.log=!!y.isDebug):"error"===b.status&&(f=l.mixin(Error(),b),f.log=!!y.isDebug),f&&!B.isDefined(f.httpCode)&&(f.httpCode=f.code),f))throw f;a.resolve({data:g,url:e.url,requestOptions:e.requestOptions,getHeader:d});a._pendingDfd=null}).otherwise(function(c){var g,d,f;c&&(g=c.code,d=c.subcode,f=(f=c.messageCode)&&f.toUpperCase());if(c&&403==g&&(4==d||c.message&&-1<c.message.toLowerCase().indexOf("ssl")&&-1===c.message.toLowerCase().indexOf("permission"))){if(!b._ssl){b._ssl=
b._sslFromServer=!0;v(a,!0,b,e);return}}else if(c&&415==c.status){if(P(b.url),!b._err415){b._err415=1;v(a,!0,b,e);return}}else if(m.id&&m.id._errorCodes&&-1!==m.id._errorCodes.indexOf(g)&&!m.id._isPublic(b.url)&&!r&&(403!=g||R&&-1===R.indexOf(f)&&(!B.isDefined(d)||2==d&&b._token))){ca(a,b,e,c);return}a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;a.reject(c);a._pendingDfd=null})}else{a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;var d=Error("Deferred object is missing");d.log=!!y.isDebug;a.reject(d);
a._pendingDfd=null}}var h=b.body,r=b.disableIdentityLookup,x=b._preLookup,w=!1;if(n("esri-workers")&&!1!==k.useWorkers)if(!0===b.useWorkers||!0===k.useWorkers)w=!0;else if(b.workerOptions){var q=b.workerOptions;if(q.callback||q.worker&&q.worker.worker instanceof Worker)w=!0}var t=null;if((q=h instanceof FormData)||h&&h.elements)t=q?h:new FormData(h);var C=!!(-1!==b.url.toLowerCase().indexOf("token\x3d")||b.content&&b.content.token||t&&t.get("token"));if(!c){a.then(function(a){if((/\/sharing\/rest\/accounts\/self/i.test(b.url)||
/\/sharing\/rest\/portals\/self/i.test(b.url))&&!C&&!b._token&&a.user&&a.user.username){var c=k.corsEnabledServers,d=p.getCorsConfig(b.url,!0),f={host:F(b.url),withCredentials:!0};if(-1===d)c.push(f);else{var e=c[d];"object"===typeof e?e.withCredentials=!0:c.splice(d,1,f)}}if(c=b._credential)if(d=(d=m.id.findServerInfo(c.server))&&d.owningSystemUrl)d=d.replace(/\/?$/,"/sharing"),(c=m.id.findCredential(d,c.userId))&&-1===m.id._getIdenticalSvcIdx(d,c)&&c.resources.splice(0,0,d);return a}).always(function(a){delete b._credential;
a&&(a.ssl=!!b._ssl)});var A=b.load,u=b.error;A&&a.then(function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return A.call(c&&c.args,b,c)});u&&a.then(null,function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return u.call(c&&c.args,b,c)})}!m.id||C||b._token||m.id._isPublic(b.url)||r&&!x||!(c=m.id.findCredential(b.url))||(b._token=c.token,b._ssl=c.ssl);w?b.workerOptions&&b.workerOptions.worker?(z=b.workerOptions.worker,d(a)):S(["./workers/RequestClient"],function(c){if(b.workerOptions){var e=b.workerOptions;z=c.getClient(e.callback,
e.cbFunction)}else z=c.getClient();d(a)}):d(a);return a.promise}function ca(a,c,b,e){a._pendingDfd=m.id.getCredential(c.url,{token:c._token,error:e});a._pendingDfd.then(function(d){c._token=d.token;c._credential=d;c._ssl=c._sslFromServer||d.ssl;v(a,!0,c,b)}).otherwise(function(b){a.reject(b);a._pendingDfd=null})}function h(a,c){if(J&&V.invokeStaticMessage)return J.execute(a,c);"string"!==typeof a&&console.error("esri/request: the first parameter should be a url string");var b=l.mixin({},c),e={url:a,
requestOptions:l.mixin({},c)};b.content=b.query;delete b.query;b.preventCache=!!b.cacheBust;delete b.cacheBust;b.handleAs=b.responseType;delete b.responseType;"array-buffer"===b.handleAs&&(b.handleAs="arraybuffer");if("image"===b.handleAs){if(n("host-webworker"))return I.reject(l.mixin(Error(),{message:"The responseType 'image' is not supported in Web Workers or Node environment."}));b.preventCache&&(b.content=b.content||{},b.content["request.preventCache"]=Date.now());b.method="auto"}b.url=p.normalize(a);
b.urlObj=new H(b.url);var d=W.makeDeferredCancellingPending();T(Q(b)).always(function(){v(d,!1,b,e)});return d.promise}var x,k=U.request,R=["COM_0056","COM_0057"],aa=0,ba=function(){return null};h._makeRequest=K;h._processRequest=v;h._disableCors=P;h._detectCors=Q;h.setRequestPreCallback=function(a){x=a};return h});