// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("../core/kebabDictionary ../core/urlUtils ../geometry/Polygon dojo/_base/lang dojo/dom-construct dojox/gfx/canvas ./Geoprocessor ./support/PrintTemplate ./support/printTaskUtils ./Task".split(" "),function(w,B,C,m,D,x,E,F,q,G){function r(a){return!(!a||!a.path)}var y={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},z=w({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),H=w({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape","A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape",
"A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"});return G.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},_vtlExtent:null,_legendLayers:[],_legendLayerNameMap:{},properties:{_geoprocessor:{dependsOn:["url","updateDelay"],
get:function(){return new E(this.url,{updateDelay:this.updateDelay})}},mode:{value:"sync"},url:{value:null,type:String},updateDelay:{value:1E3,type:Number}},execute:function(a,d){a=this._setPrintParams(a);return this._geoprocessor["async"===this.mode?"submitJob":"execute"](a,d).then(this._handleExecuteResponse)},_createOperationalLayers:function(a,d){var c=[],k,b,h,f,g=a.map.allLayers.items;for(k=0;k<g.length;k++)if(b=g[k],b.loaded&&b.visible)switch(f={id:b.id,title:this._legendLayerNameMap[b.id]||
b.title,opacity:b.opacity,minScale:b.minScale||0,maxScale:b.maxScale||0,url:b.url&&B.normalize(b.url),token:b.token},h=b.declaredClass,h){case "esri.layers.ImageryLayer":h={bandIds:b.bandIds,compressionQuality:b.compressionQuality,format:b.format,interpolation:b.interpolation};b.mosaicRule&&(h.mosaicRule=b.mosaicRule.toJSON());b.renderingRule&&(h.renderingRule=b.renderingRule.toJSON());c.push(m.mixin(f,h));this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.OpenStreetMapLayer":m.mixin(f,
{type:"OpenStreetMap"});c.push(f);break;case "esri.layers.GraphicsLayer":m.mixin(f,this._createFeatureCollectionJSON(b));c.push(f);this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.VectorTileLayer":f.type="image";f.url&&delete f.url;var l=d.exportOptions&&d.exportOptions.dpi||96,t=d.exportOptions&&d.exportOptions.width%2===a.width%2,e=d.exportOptions&&d.exportOptions.height%2===a.height%2,p={format:"png",pixelRatio:l/96,rotation:0};h=this._vtlExtent||a.extent.clone();
"MAP_ONLY"!==d.layout||!d.preserveScale||d.outScale&&d.outScale!==a.scale||96!==l||t&&e||(p.area={x:0,y:0,width:a.width,height:a.height},t||(p.area.width+=1),e||(p.area.height+=1),this._vtlExtent||(l=a.toMap({x:p.area.width,y:p.area.height}),h.ymin=l.y,h.xmax=l.x,this._vtlExtent=h));f.extent=h.clone()._normalize(!0).toJSON();b=a.whenLayerView(b);b.isResolved()&&b.then(function(b){b=b.takeScreenshot(p,a);b.isResolved()?b.then(function(a){"data:image/png;base64,"===a.dataURL.substr(0,22)&&(f.imageData=
a.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise");f.imageData&&c.push(f)});break;case "esri.layers.MapImageLayer":var n={id:b.id,subLayerIds:[]},u=[],q=a.scale,v=function(a){var b=0===q,c=0===a.minScale||q<=a.minScale,d=0===a.maxScale||q>=a.maxScale;a.visible&&(b||c&&d)&&(a.sublayers?a.sublayers.forEach(v):(b=a.toExportImageJSON().drawingInfo,c=a.toJSON(),c.layerDefinition.drawingInfo=b,u.unshift(c),n.subLayerIds.push(a.id)))};b.sublayers&&
b.sublayers.forEach(v);m.mixin(f,{layers:u});c.push(f);this._legendLayers.push(n);break;case "esri.layers.WMSLayer":u=[];v=function(a){a.visible&&(a.sublayers?a.sublayers.forEach(v):a.name&&u.unshift(a.name))};b.sublayers&&b.sublayers.forEach(v);m.mixin(f,{type:"wms",transparentBackground:b.imageTransparency,visibleLayers:u,version:b.version});c.push(f);break;case "esri.layers.WMTSLayer":b=b.activeLayer;m.mixin(f,{type:"wmts",layer:b.id,style:b.styleId,format:b.imageFormat,tileMatrixSet:b.tileMatrixSetId});
c.push(f);break;case "esri.layers.WebTileLayer":h=b.urlTemplate.replace(/\$\{/g,"{");m.mixin(f,{type:"WebTiledLayer",urlTemplate:h,credits:b.copyright});b.subDomains&&0<b.subDomains.length&&(f.subDomains=b.subDomains);c.push(f);break;case "esri.layers.FeatureLayer":case "esri.layers.CSVLayer":case "esri.layers.StreamLayer":var A;a.whenLayerView(b).then(function(a){return a.queryGraphics&&a.queryGraphics()||a.featuresView.graphics}).then(function(a){A=a.map(function(a){a.geometry.hasZ=!1;return a})});
m.mixin(f,this._createFeatureCollectionJSON(b,A));c.push(f);this._legendLayers&&this._legendLayers.push({id:b.id});break;case "esri.layers.MapNotesLayer":var r=[];b.featureCollections.map(function(a){var b=a.source.toArray();a=this._createFeatureCollectionJSON(a,b).featureCollection;r=r.concat(a.layers)}.bind(this));m.mixin(f,{featureCollection:{layers:r}});c.push(f);break;default:c.push(f)}return c},_createFeatureCollectionJSON:function(a,d){var c=q.createPolygonLayer(),k=q.createPolylineLayer(),
b=q.createPointLayer(),h=q.createMultipointLayer(),f=q.createPointLayer();f.layerDefinition.name="textLayer";delete f.layerDefinition.drawingInfo;"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass?c.layerDefinition.name=k.layerDefinition.name=b.layerDefinition.name=h.layerDefinition.name=this._legendLayerNameMap[a.id]||a.get("arcgisProps.title")||a.title:"esri.layers.GraphicsLayer"===a.declaredClass&&(d=a.graphics.items);if(a.renderer&&!m.isFunction(a.get("renderer.field"))){var g=
a.renderer.toJSON();c.layerDefinition.drawingInfo.renderer=g;k.layerDefinition.drawingInfo.renderer=g;b.layerDefinition.drawingInfo.renderer=g;h.layerDefinition.drawingInfo.renderer=g}else delete c.layerDefinition.drawingInfo,delete k.layerDefinition.drawingInfo,delete b.layerDefinition.drawingInfo,delete h.layerDefinition.drawingInfo;var l=a.fields,g=a.renderer,t=[];g&&!m.isFunction(a.get("renderer.field"))&&("classBreaks"===g.type?(l||(l=[{name:g.field,type:"esriFieldTypeDouble"}],g.normalizationField&&
l.push({name:g.normalizationField,type:"esriFieldTypeDouble"})),g.field&&t.push(g.field),g.normalizationField&&t.push(g.normalizationField)):"uniqueValue"===g.type&&(l||(l=[{name:g.field,type:"esriFieldTypeString"}],g.field2&&l.push({name:g.field2,type:"esriFieldTypeString"}),g.field3&&l.push({name:g.field3,type:"esriFieldTypeString"})),g.field&&t.push(g.field),g.field2&&t.push(g.field2),g.field3&&t.push(g.field3)));l&&(c.layerDefinition.fields=l,k.layerDefinition.fields=l,b.layerDefinition.fields=
l,h.layerDefinition.fields=l);for(var l=d&&d.length,e,p=0;p<l;p++){var n=d[p]||d.getItemAt(p);if(!1!==n.visible&&n.geometry&&(e=n.toJSON(),e.hasOwnProperty("popupTemplate")&&delete e.popupTemplate,e.geometry&&e.geometry.z&&delete e.geometry.z,!e.symbol||!e.symbol.outline||"esriCLS"!==e.symbol.outline.type)){e.symbol&&e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color[3]&&(e.symbol.outline.color[3]=255);if(a.renderer&&!e.symbol&&(m.isFunction(a.renderer.field)||a.renderer.compiledFunc||
a.renderer.hasVisualVariables())){var g=a.renderer,u=g.getSymbol(n);if(!u)continue;e.symbol=u.toJSON();g.hasVisualVariables()&&q.applyVisualVariables(e.symbol,{renderer:g,graphic:n,symbol:u})}e.symbol&&(e.symbol.angle||delete e.symbol.angle,e.symbol.path?e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol):e.symbol.text&&delete e.attributes);if(a.renderer&&"simple"===a.renderer.type)delete e.attributes;else if(t.length){var r={};t.forEach(function(a){e.attributes&&e.attributes.hasOwnProperty(a)&&
(r[a]=e.attributes[a])});e.attributes=r}"polygon"===n.geometry.type?c.featureSet.features.push(e):"polyline"===n.geometry.type?k.featureSet.features.push(e):"point"===n.geometry.type?e.symbol&&e.symbol.text?f.featureSet.features.push(e):b.featureSet.features.push(e):"multipoint"===n.geometry.type?h.featureSet.features.push(e):"extent"===n.geometry.type&&(e.geometry=C.fromExtent(n.geometry).toJSON(),c.featureSet.features.push(e))}}a=[c,k,h,b,f].filter(function(a){return 0<a.featureSet.features.length});
a.forEach(function(a){a.featureSet.features.every(function(a){return a.symbol})&&(a.featureSet.features.forEach(function(a){delete a.attributes}),delete a.layerDefinition.drawingInfo);a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(a.layerDefinition.drawingInfo.renderer)},this);return{featureCollection:{layers:a}}},_convertSvgToPictureMarkerSymbolJson:function(a){this._canvasParent||(this._canvasParent=D.create("div"),this._canvasSurface=x.createSurface(this._canvasParent,
200,200));var d=this._canvasSurface.createObject(x.Path,a.path).setFill(a.color).setStroke(a.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var c=this._canvasSurface.rawNode.getContext("2d"),d=d.getBoundingBox(),k=Math.ceil(d.width+d.x),b=Math.ceil(d.height+d.y),h=c.getImageData(d.x,d.y,k,b);c.canvas.width=k;c.canvas.height=b;c.putImageData(h,0,0);return{type:"esriPMS",imageData:c.canvas.toDataURL("image/png").substr(22),angle:-a.angle,contentType:"image/png",height:a.size?
a.size:b-d.y,width:a.size?a.size:k-d.x,xoffset:a.xoffset,yoffset:a.yoffset}},_convertSvgRenderer:function(a){var d=a.type;if("simple"===d&&r(a.symbol))a.symbol=this._convertSvgToPictureMarkerSymbolJson(a.symbol);else if("uniqueValue"===d||"classBreaks"===d)d=a["uniqueValue"===d?"uniqueValueInfos":"classBreakInfos"],r(a.defaultSymbol)&&(a.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(a.defaultSymbol)),d&&d.forEach(function(a){r(a)&&(a.symbol=this._convertSvgToPictureMarkerSymbolJson(a.symbol))},
this)},_getPrintDefinition:function(a,d){var c=a.view,k=c.map,b=c.spatialReference,h={operationalLayers:this._createOperationalLayers(c,d)};a=this._vtlExtent||a.extent||c.extent;b&&b.isWrappable&&(a=a.clone()._normalize(!0),b=a.spatialReference);h.mapOptions={extent:a&&a.toJSON(),spatialReference:b&&b.toJSON(),showAttribution:d.attributionVisible};this._vtlExtent=null;c.rotation&&(h.mapOptions.rotation=-c.rotation);d.preserveScale&&(h.mapOptions.scale=d.outScale||c.scale);k.timeExtent&&(h.mapOptions.time=
[k.timeExtent.startTime.getTime(),k.timeExtent.endTime.getTime()]);return h},_handleExecuteResponse:function(a){return"sync"===this.mode?a.results&&a.results[0]&&a.results[0].value:this._geoprocessor.getResultData(a.jobId,"Output_File").then(function(a){return a.value})},_setPrintParams:function(a){var d=a.template||new F;null==d.showLabels&&(d.showLabels=!0);var c=d.exportOptions,k;if(c){k={dpi:c.dpi};var b=H.toJSON(d.layout);if("map_only"===b.toLowerCase()||""===b)k.outputSize=[c.width,c.height]}var c=
d.layoutOptions,h;if(c){var f,g;if("Miles"===c.scalebarUnit||"Kilometers"===c.scalebarUnit)f="Kilometers",g="Miles";else if("Meters"===c.scalebarUnit||"Feet"===c.scalebarUnit)f="Meters",g="Feet";h={titleText:c.titleText,authorText:c.authorText,copyrightText:c.copyrightText,customTextElements:c.customTextElements,scaleBarOptions:{metricUnit:z.toJSON(f),metricLabel:y[f],nonMetricUnit:z.toJSON(g),nonMetricLabel:y[g]}}}f=null;c&&c.legendLayers&&(f=c.legendLayers.map(function(a){this._legendLayerNameMap[a.layerId]=
a.title;var b={id:a.layerId};a.subLayerIds&&(b.subLayerIds=a.subLayerIds);return b},this));c=this._getPrintDefinition(a,d);a.outSpatialReference&&(c.mapOptions.spatialReference=a.outSpatialReference.toJSON());m.mixin(c,{exportOptions:k,layoutOptions:h});m.mixin(c.layoutOptions,{legendOptions:{operationalLayers:null!=f?f:this._legendLayers}});d={Web_Map_as_JSON:JSON.stringify(c),Format:d.format,Layout_Template:b};a.extraParameters&&m.mixin(d,a.extraParameters);return d}})});