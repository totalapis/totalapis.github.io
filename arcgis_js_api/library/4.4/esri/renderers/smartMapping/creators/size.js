// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports dojo/i18n!../../nls/smartMapping dojo/_base/lang ../../../core/lang ../../ClassBreaksRenderer ../statistics/summaryStatistics ../symbology/size ../../support/utils ../../../core/promiseUtils ../../../views/SceneView ./support/utils ../support/utils".split(" "),function(I,q,z,t,A,B,C,r,u,e,v,f,m){function D(b){if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))return e.reject(f.createError("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));
var a=t.mixin({},b);a.layer=m.createLayerAdapter(a.layer);return a.layer?a.layer.load().then(function(){var b=a.layer.geometryType;if("mesh"===b)return e.reject(f.createError("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type"));if(a.worldScale){if("polyline"===b||"polygon"===b)return e.reject(f.createError("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers"));if(!(a.view instanceof
v))return e.reject(f.createError("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"))}b=m.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});return(b=f.verifyBasicFieldValidity(a.layer,b,"size-visual-variable:invalid-parameters"))?e.reject(b):a}):e.reject(f.createError("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+w))}function E(b){if(!(b&&
b.layer&&(b.field||b.valueExpression||b.sqlExpression)))return e.reject(f.createError("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var a=t.mixin({},b);a.symbolType=a.symbolType||"2d";a.layer=m.createLayerAdapter(a.layer);return a.layer?a.layer.load().then(function(){var b=a.layer.geometryType,c=-1<a.symbolType.indexOf("3d");if("mesh"===b)return e.reject(f.createError("size-continuous-renderer:invalid-parameters",
"Size visualization is not applicable to layers with 'mesh' geometry type"));if(c&&("polyline"===b||"polygon"===b))return e.reject(f.createError("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(-1<a.symbolType.indexOf("3d-volumetric")&&!(a.view instanceof v))return e.reject(f.createError("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform"));
b=m.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});return(b=f.verifyBasicFieldValidity(a.layer,b,"size-continuous-renderer:invalid-parameters"))?e.reject(b):a}):e.reject(f.createError("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+w))}function F(b){b=t.mixin({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");if(b.worldScale=a)b.axis="3d-volumetric-uniform"===b.symbolType?"all":"height";delete b.symbolType;
delete b.defaultSymbolEnabled;return b}function G(b,a,e,c){var H=c.field,d=c.layer.geometryType,k=null==c.defaultSymbolEnabled?!0:c.defaultSymbolEnabled,l=r.cloneScheme(b.sizeScheme),n="polygon"===d,g=n?l.marker:l,h=n?l.background:null,l="polyline"===d?g.noDataWidth:g.noDataSize,h=h?f.createSymbol(h,h.color,d,c.symbolType):null;return{renderer:new B({backgroundFillSymbol:h,classBreakInfos:[{minValue:-x,maxValue:x,symbol:f.createSymbol(g,g.color,n?"point":d,c.symbolType)}],defaultLabel:k?z.other:null,
defaultSymbol:k?f.createSymbol(g,g.noDataColor,n?"point":d,c.symbolType,null,l):null,field:H,normalizationField:e,normalizationType:a,valueExpression:c.valueExpression,visualVariables:b.visualVariables.map(function(a){return u.cloneSizeVariable(a)}),authoringInfo:A.clone(b.authoringInfo)}),visualVariables:b.visualVariables.map(function(a){return u.cloneSizeVariable(a)}),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,sizeScheme:r.cloneScheme(b.sizeScheme),basemapId:b.basemapId}}function y(b){return D(b).then(function(a){var b=
a.normalizationField,c=b?"field":void 0;return(a.statistics?e.resolve(a.statistics):C({layer:a.layer,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:c,normalizationField:b,minValue:a.minValue,maxValue:a.maxValue})).then(function(c){var d,k;d=a.layer;var l=a.field,n=(k=l&&"function"!==typeof l?d.getField(l):null)&&"date"===k.type,g=d.geometryType;d=a.sizeScheme;k=a.basemap;d?d=r.cloneScheme(d):(d=(k=r.getSchemes({basemap:a.basemap,
geometryType:g,worldScale:a.worldScale,view:a.view}))&&k.primaryScheme,k=k&&k.basemapId);if(d){var h,p;switch(g){case "point":case "multipoint":p=[d.minSize,d.maxSize];break;case "polyline":p=[d.minWidth,d.maxWidth];break;case "polygon":p=[d.marker.minSize,d.marker.maxSize]}h=p;p=(n=f.getDefaultDataRange(c,n,!1))||[c.min,c.max];var g=[],m=h[0];h=h[1];var q=void 0;"height"===a.axis&&(g.push({type:"size",axis:"width-and-depth",minSize:((h-m)/2+m)/4.6}),q="height",h*=2);g.unshift({type:"size",field:l,
valueExpression:a.valueExpression,valueUnit:"unknown",normalizationField:b,axis:q,minSize:m,maxSize:h,minDataValue:p[0],maxDataValue:p[1],legendOptions:a.legendOptions});c=e.resolve({basemapId:k,visualVariables:g,statistics:c,defaultValuesUsed:!!n,sizeScheme:r.cloneScheme(d),authoringInfo:{visualVariables:[{type:"size",minSliderValue:c.min,maxSliderValue:c.max}]}})}else c=e.reject(f.createError("size-visual-variable:insufficient-info","Unable to find size scheme"));return c})})}Object.defineProperty(q,
"__esModule",{value:!0});var x=Math.pow(2,53)-1,w=m.supportedLayerTypes.join(", ");q.createVisualVariables=y;q.createContinuousRenderer=function(b){return E(b).then(function(a){return y(F(a)).then(function(b){var c=a.normalizationField;return G(b,c?"field":void 0,c,a)})})}});