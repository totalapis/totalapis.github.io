// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../InputHandler ./support ../../../core/now".split(" "),function(g,h,k,l,m,n){Object.defineProperty(h,"__esModule",{value:!0});g=function(g){function b(){var a=g.call(this,"recognizers.Drag",!1)||this;a._startStateModifiers=new Set;a._activePointers=[];a._activePointerMap=new Map;a._isDragging=!1;a._drag=a.registerOutgoing("drag");a.registerIncoming("pointer-drag",a._handlePointerDrag.bind(a));a.registerIncoming("pointer-down",a._handlePointerDown.bind(a));
a.registerIncoming("pointer-up",a._handlePointerUpAndPointerLost.bind(a));a.registerIncoming("pointer-capture-lost",a._handlePointerUpAndPointerLost.bind(a));return a}k(b,g);b.prototype._createPayload=function(a,d){return{action:a,pointers:this._activePointers.map(function(a){return a.data}),startState:this._startState,previousState:this._previousState,currentState:d}};b.prototype._fitCircleLSQ=function(){var a=this._activePointers.map(function(a){return a.data.currentEvent});return m.fitCircleLSQ(a)};
b.prototype._createDragState=function(){for(var a=this._fitCircleLSQ(),d=0,c=0,b=this._activePointers;c<b.length;c++){for(var e=b[c],f=this._pointerAngle(e,a),f=f-e.lastAngle;f>Math.PI;)f-=2*Math.PI;for(;f<-Math.PI;)f+=2*Math.PI;f=e.lastAngle+f;e.lastAngle=f;d+=f-e.initialAngle}d/=this._activePointers.length;return{angle:d,radius:a.radius,center:a.center,timestamp:n()}};b.prototype._updateMultiPointer=function(a){var d=a.startEvent.native.pointerId,c=this._activePointerMap.get(d),b=!c;b?(c={data:null,
initialAngle:0,lastAngle:0},this._activePointers.push(c),this._activePointerMap.set(d,c),c.data={startEvent:a.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent},a=this._fitCircleLSQ(),c.initialAngle=this._pointerAngle(c,a),c.lastAngle=c.initialAngle):c.data={startEvent:c.data.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent};b&&this._isDragging&&this._updateInitialAngles();return c};b.prototype._pointerAngle=function(a,d){a=a.data.currentEvent;return Math.atan2(a.y-
d.center.y,a.x-d.center.x)};b.prototype._updateInitialAngles=function(){for(var a=this._createDragState(),d=0,c=this._activePointers;d<c.length;d++){var b=c[d];b.initialAngle=this._pointerAngle(b,a)}};b.prototype._emitStart=function(a){this._updateInitialAngles();var b=this._createDragState();this._previousState=this._startState=b;this._startStateModifiers=a.modifiers;this._isDragging=!0;for(var c=0,g=this._activePointers;c<g.length;c++){var e=g[c];e.data={previousEvent:e.data.currentEvent,startEvent:e.data.currentEvent,
currentEvent:e.data.currentEvent}}this._drag.emit(this._createPayload("start",b),a.timestamp)};b.prototype._emitUpdate=function(a){a=this._createDragState();this._drag.emit(this._createPayload("update",a),void 0,this._startStateModifiers);this._previousState=a};b.prototype._emitEnd=function(){var a=this._createDragState();this._drag.emit(this._createPayload("end",a),void 0,this._startStateModifiers);this._startState=this._previousState=null;this._isDragging=!1};b.prototype._handlePointerDown=function(a){a=
a.data;this._isDragging&&this._emitEnd();this._updateMultiPointer({startEvent:a,previousEvent:a,currentEvent:a})};b.prototype._removeMultiPointer=function(a){var b=a.native.pointerId,c=this._activePointerMap.get(b);c&&(this._isDragging&&(this._updateMultiPointer({startEvent:c.data.startEvent,previousEvent:c.data.currentEvent,currentEvent:a}),this._emitEnd()),this._activePointerMap.delete(b),a=this._activePointers.indexOf(c),this._activePointers.splice(a,1),this._isDragging&&this._updateInitialAngles())};
b.prototype._handlePointerUpAndPointerLost=function(a){this._removeMultiPointer(a.data)};b.prototype._handlePointerDrag=function(a){var b=a.data;switch(b.action){case "start":this._isDragging||this._emitStart(a);break;case "update":this._isDragging||this._emitStart(a),this._updateMultiPointer(b),this._emitUpdate(a)}};return b}(l.InputHandler);h.Drag=g});