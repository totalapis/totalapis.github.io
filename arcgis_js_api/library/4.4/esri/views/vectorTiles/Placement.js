// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define(["require","exports","./Geometry","./GeometryUtils","./Conflict"],function(B,x,u,h,D){Object.defineProperty(x,"__esModule",{value:!0});B=function(){return function(c,a,b,k,d){void 0===b&&(b=0);void 0===k&&(k=-1);void 0===d&&(d=C);this.x=c;this.y=a;this.angle=b;this.segment=k;this.minzoom=d}}();x.Anchor=B;B=function(){return function(c,a,b){this.glyph=c;this.x=a;this.y=b}}();x.ShapedGlyph=B;var P=function(){return function(c,a,b,k,d,e,n){void 0===d&&(d=!1);void 0===e&&(e=C);void 0===n&&(n=h.C_INFINITY);
this.anchor=c;this.labelAngle=a;this.glyphAngle=b;this.page=k;this.upsideDown=d;this.minzoom=e;this.maxzoom=n}}(),Q=function(){return function(c,a,b,k,d,e,h,q,u,I){this.tl=c;this.tr=a;this.bl=b;this.br=k;this.mosaicRect=d;this.labelAngle=e;this.anchor=h;this.minzoom=q;this.maxzoom=u;this.page=I}}();x.PlacedSymbol=Q;var R=function(){return function(h,a){this.footprint=h;this.shapes=a}}();x.Placement=R;var C=.5;B=function(){function c(){this.mapAngle=0;this._conflictEngine=new D.ConflictEngine}c.prototype.reset=
function(){this._conflictEngine.reset()};c.prototype.setAngle=function(a){this.mapAngle=a;this._conflictEngine.setAngle(a)};c.prototype.getIconPlacement=function(a,b,k,d,e,c){var q=b.width/b.pixelRatio,n=b.height/b.pixelRatio;d=e.offset[0]-q/2;var I=e.offset[1]-n/2,q=d+q,n=I+n,A=b.rect,r=d-2,l=I-2,f=r+A.width/b.pixelRatio,g=l+A.height/b.pixelRatio;b=new u.Point(r,l);var t=new u.Point(f,g),r=new u.Point(r,g),f=new u.Point(f,l),g=e.rotate*h.C_DEG_TO_RAD,l=1===e.rotationAlignment;0<=a.segment&&!l&&(g+=
a.angle);if(0!==g){var p=Math.cos(g),m=Math.sin(g);b.rotate(p,m);t.rotate(p,m);r.rotate(p,m);f.rotate(p,m)}p=8*e.padding;m=new u.Point(a.x,a.y);a=new D.Footprint(this.mapAngle,p,l);a.addBox(m,new D.Box(d,I,q,n),k,g,C,h.C_INFINITY);k=new Q(b,f,r,t,A,0,m,C,h.C_INFINITY,0);k=new R(a,[k]);d=C;e.allowOverlap||(d=this._conflictEngine.getMinZoom(k.footprint,d,c,l));a.minzoom=d;return k};c.prototype.getTextPlacement=function(a,b,k,d,e,c,q,B){for(var n=new u.Point(a.x,a.y),A=q.rotate*h.C_DEG_TO_RAD,r=0===
q.rotationAlignment,l=q.keepUpright,f=C,g=!r,t=g?0:a.angle,p=0<=a.segment&&r,m=new D.Footprint(this.mapAngle,8*q.padding,g),x=[],S=!p,E=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,J=E,K=F,ea=p?l:r&&l,fa=[],T,U=0;U<k.length;U++){var y=k[U],v=d[y.glyph];if(v&&!v.rect.isEmpty){var V=v.rect,G=v.metrics,z=v.page;S&&(T&&T!==y.y&&(m.addBox(n,new D.Box(E,J,F,K),e,A,C,h.C_INFINITY),E=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,J=E,K=F),T=y.y);var H=[];if(p){if(v=(b.x+y.x+G.left-4+.5*v.metrics.width)*
e,f=this._placeGlyph(a,f,v,c,a.segment,1,z,H),l&&(f=this._placeGlyph(a,f,v,c,a.segment,-1,z,H)),2<=f)break}else H.push(new P(n,t,t,z)),r&&l&&H.push(new P(n,t+h.C_PI,t+h.C_PI,z,!0));for(var z=y.x+b.x+G.left,y=y.y+b.y-G.top,v=z+G.width,G=y+G.height,L=new u.Point(z-4,y-4),W=new u.Point(L.x+V.width,L.y+V.height),ga=new u.Point(L.x,W.y),ha=new u.Point(W.x,L.y),X=0;X<H.length;X++){var w=H[X],aa=L.clone(),ba=ga.clone(),ca=ha.clone(),da=W.clone(),Y=y,Z=G,M=w.glyphAngle+A;if(0!==M){var N=Math.cos(M),O=Math.sin(M);
aa.rotate(N,O);da.rotate(N,O);ba.rotate(N,O);ca.rotate(N,O)}x.push(new Q(aa,ca,ba,da,V,w.labelAngle,w.anchor,w.minzoom,w.maxzoom,w.page));if(!ea||this._legible(w.labelAngle))S?(z<E&&(E=z),Y<J&&(J=Y),v>F&&(F=v),Z>K&&(K=Z)):2>w.minzoom&&m.addBox(w.anchor,new D.Box(z,Y,v,Z),e,M,w.minzoom,w.maxzoom);fa.push(w)}}}if(2<=f)return null;S&&m.addBox(n,new D.Box(E,J,F,K),e,A,C,h.C_INFINITY);a=new R(m,x);q.allowOverlap||(f=this._conflictEngine.getMinZoom(a.footprint,f,B,g));m.minzoom=f;return a};c.prototype.add=
function(a){this._conflictEngine.add(a.footprint)};c.prototype._legible=function(a){a=h.radToByte(a);return 65>a||193<=a};c.prototype._placeGlyph=function(a,b,c,d,e,n,q,x){var k=0>n?h.positiveMod(a.angle+h.C_PI,h.C_2PI):a.angle,A=this._legible(k),r=0;0>c&&(n*=-1,c*=-1,r=h.C_PI);0<n&&++e;a=new u.Point(a.x,a.y);var l=d[e],f=h.C_INFINITY;if(d.length<=e)return f;for(;;){var g=l.x-a.x,t=l.y-a.y,p=Math.sqrt(g*g+t*t),m=Math.max(c/p,b),g=h.positiveMod(Math.atan2(t/p,g/p)+r,h.C_2PI);x.push(new P(a,k,g,q,A,
m,f));if(m<=b)return m;a=l.clone();do{e+=n;if(d.length<=e||0>e)return m;l=d[e]}while(a.isEqual(l));f=l.x-a.x;g=l.y-a.y;t=Math.sqrt(f*f+g*g);f*=p/t;g*=p/t;a.x-=f;a.y-=g;f=m}};return c}();x.PlacementEngine=B});