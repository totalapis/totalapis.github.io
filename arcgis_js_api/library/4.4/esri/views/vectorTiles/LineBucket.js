// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ./Bucket ./LineTess ./style/StyleLayer".split(" "),function(u,v,q,w,r,d,t){return function(p){function f(a,b,e,c){a=p.call(this,a,b)||this;a.extrudeVectorsDoubleBuffer=[d.allocExtrudeVectors(),d.allocExtrudeVectors()];a.firstExtrudeVectors=d.allocExtrudeVectors();a.recycledTriangleBridge=d.allocTriangles(20);a.recycledTrianglePie=d.allocTriangles(20);a.lineVertexBuffer=e;a.lineIndexBuffer=c;return a}q(f,
p);Object.defineProperty(f.prototype,"triangleIndexStart",{get:function(){return this.triangleElementsStart},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"triangleIndexCount",{get:function(){return this.triangleElementsCount},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"connectorStart",{get:function(){return 0},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"connectorCount",{get:function(){return 0},enumerable:!0,configurable:!0});f.prototype.assignBufferInfo=
function(a){a.triangleElementsStart=this.triangleElementsStart;a.triangleElementsCount=this.triangleElementsCount};f.prototype.processFeatures=function(a,b){this.triangleElementsStart=this.lineIndexBuffer.index;this.triangleElementsCount=0;a&&a.setExtent(this.layerExtent);b=new t.LineLayout(this.layer,this.zoom);for(var e=0,c=this._features;e<c.length;e++){var d=c[e].getGeometry(a);this._processFeature(b,d)}};f.prototype._processFeature=function(a,b){if(b){var e=b.length,c;for(c=0;c<e;c++)this._processGeometry(b[c],
a)}};f.prototype._processGeometry=function(a,b){if(!(2>a.length)){var e=a[0],c=a[a.length-1],k=c.x-e.x,c=c.y-e.y,e=1E-6>k*k+c*c;if(!(2>a.length)){for(var g=a[0],h=1;h<a.length;)k=a[h].x-g.x,c=a[h].y-g.y,1E-6>k*k+c*c?a.splice(h,1):(g=a[h],++h);if(!(2>a.length)){this.vertices=a;this.verticesLen=a.length;this.isClosed=e;this.cap=b.cap;this.join=b.join;this.almostParallelRads=.05;this.veryShallowRads=.1;this.miterSafeRads=d.MITER_SAFE_RADS;this.miterLimitMag=Math.min(b.miterLimit,d.SYSTEM_MAG_LIMIT);
this.roundLimitRads=Math.min(b.roundLimit,.5);this.newRoundJoinsSafeRads=2.3;b=this.lineIndexBuffer.index;for(var k=0,f=void 0,c=this.verticesLen,g=0;g<c;++g){var l=a[g],h=f===this.extrudeVectorsDoubleBuffer[g%2]?this.extrudeVectorsDoubleBuffer[(g+1)%2]:this.extrudeVectorsDoubleBuffer[g%2];g<c||!e?(this._computeExtrudeVectors(h,g),this._writeGPUVertices(l.x,l.y,k,h),!h.capCenter||e&&g===c-1||this._writeGPUPieElements(h),e&&0===g&&d.copyExtrudeVectors(this.firstExtrudeVectors,h)):d.copyExtrudeVectors(h,
this.firstExtrudeVectors);f&&this._writeGPUBridgeElements(f,h);g<c-1&&(f=a[g+1],l=d.length([f.x-l.x,f.y-l.y]),k+=l);f=h}this.triangleElementsCount+=3*(this.lineIndexBuffer.index-b)}}}};f.prototype._computeExtrudeVectors=function(a,b){var e=this.vertices,c=this.verticesLen,k=this.isClosed,g=e[b],f=[void 0,void 0],m=[void 0,void 0];if(0<b&&b<c-1){var l=e[(b+c-1)%c],n=e[(b+1)%c];d.normalize(f,[g.x-l.x,g.y-l.y]);d.normalize(m,[n.x-g.x,n.y-g.y])}else if(0===b)n=e[(b+1)%c],d.normalize(m,[n.x-g.x,n.y-g.y]),
k?(e=e[c-2],d.normalize(f,[g.x-e.x,g.y-e.y])):f=m;else if(b===c-1)l=e[(b+c-1)%c],d.normalize(f,[g.x-l.x,g.y-l.y]),k?(e=e[1],d.normalize(m,[e.x-g.x,e.y-g.y])):m=f;else{console.error("Vertex index 'i' out of range.");return}k||0!==b?k||b!==c-1?this._computeJoinExtrudeVectors(a,f,m):this._computeCapExtrudeVectors(a,f,m,d.CapPosition.END):this._computeCapExtrudeVectors(a,f,m,d.CapPosition.START)};f.prototype._computeCapExtrudeVectors=function(a,b,e,c){0===this.cap?d.buttCap(a,b,e):1===this.cap?d.roundCap(a,
b,e,c,d.getNumberOfSlices(Math.PI),c===d.CapPosition.START?-1:1):2===this.cap?d.squareCap(a,b,e,c):(d.buttCap(a,b,e),console.error("Unknown cap type!"))};f.prototype._computeJoinExtrudeVectors=function(a,b,e){var c=d.getRads(b,e);if(c>Math.PI-this.almostParallelRads)d.rectJoin(a,b,e);else if(2===this.join||c<this.veryShallowRads)c<this.almostParallelRads?d.fastMiterJoin(a,b,e):c<this.miterSafeRads?d.miterJoin(a,b,e):d.bevelJoin(a,b,e,this.miterLimitMag);else if(0===this.join)d.bevelJoin(a,b,e,1);
else if(1===this.join){var f=d.getNumberOfSlices(c);c<this.newRoundJoinsSafeRads?2>f||c<this.roundLimitRads?d.bevelJoin(a,b,e,1):d.roundJoin(a,b,e,f):d.unitRoundJoin(a,b,e,f)}};f.prototype._writeGPUVertices=function(a,b,e,c){var d;for(d=0;d<c.vectors.count;++d){var f=this.lineVertexBuffer.add(a,b,c.vectors.items[d].vector[0],c.vectors.items[d].vector[1],c.vectors.items[d].texCoords[0],c.vectors.items[d].texCoords[1],e);c.vectors.items[d].base=f}};f.prototype._writeGPUBridgeElements=function(a,b){d.bridge(this.recycledTriangleBridge,
a,b);for(a=0;a<this.recycledTriangleBridge.count;++a)b=this.recycledTriangleBridge.items[a],this.lineIndexBuffer.add(b.v1.base,b.v2.base,b.v3.base)};f.prototype._writeGPUPieElements=function(a){d.pie(this.recycledTrianglePie,a);for(a=0;a<this.recycledTrianglePie.count;++a){var b=this.recycledTrianglePie.items[a];this.lineIndexBuffer.add(b.v1.base,b.v2.base,b.v3.base)}};return f}(r)});