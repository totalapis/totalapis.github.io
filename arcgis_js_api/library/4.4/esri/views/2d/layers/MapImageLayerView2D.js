// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/HandleRegistry ../../../layers/support/ExportImageParameters ./LayerView2D ./support/ExportStrategy ../engine/BitmapSource ../engine/Canvas2DContainer".split(" "),function(e,t,h,k,g,l,m,n,p,q,r){e=function(e){function a(){var b=e.call(this)||this;b._handles=new l;b.container=new r;b.container.hidpi=!0;return b}h(a,e);a.prototype.hitTest=function(b,
a){return null};a.prototype.update=function(b){this.strategy.update(b);this.notifyChange("updating")};a.prototype.attach=function(){var b=this,a=this.layer,d=a.imageMaxWidth,c=a.imageMaxHeight,f=a.version,a=10.3<=f,f=10<=f;this.strategy=new p({container:this.container,fetchImage:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:d,imageMaxHeight:c,imageRotationSupported:a,imageNormalizationSupported:f,hidpi:!0});this._exportImageParameters=new m({layer:this.layer});
this._handles.add(this._exportImageParameters.watch("version",function(a){b._exportImageVersion!==a&&(b._exportImageVersion=a,b.requestUpdate())}))};a.prototype.detach=function(){this.container.removeAllChildren();this.strategy.destroy();this._handles.removeAll();this._exportImageParameters.layer=null;this._exportImageParameters.destroy();this._exportImageParameters=null};a.prototype.moveStart=function(){};a.prototype.viewChange=function(){};a.prototype.moveEnd=function(){this.requestUpdate()};a.prototype.isUpdating=
function(){return this.attached&&(this.strategy.updating||this.updateRequested)};a.prototype.getPopupData=function(a){var b=this,d=this.view.scale;return this.layer.allSublayers.filter(function(a){var b=0===a.minScale||d<=a.minScale,c=0===a.maxScale||d>=a.maxScale;return a.popupTemplate&&a.visible&&b&&c}).map(function(c){var d=c.createQuery();d.geometry=a;d.outFields=b.getTemplateOutFields(c.popupTemplate);return c.queryFeatures(d).then(function(a){return a.features})})};a.prototype.getTemplateOutFields=
function(a){if(!a||!a.fieldInfos)return["*"];var b=[];a.fieldInfos.forEach(function(a){var c=a.fieldName&&a.fieldName.toLowerCase();c&&"shape"!==c&&0!==c.indexOf("relationships/")&&b.push(a.fieldName)});return b};a.prototype.fetchImage=function(a,e,d,c){var b=this;this._exportImageParameters.scale!==this.view.scale&&(this._exportImageParameters.scale=this.view.scale,this._exportImageVersion=this._exportImageParameters.version);return this.layer.fetchImage(a,e,d,c).then(function(a){b.notifyChange("updating");
return new q(a)})};return a}(g.declared(n));return e=k([g.subclass("esri.views.2d.layers.MapImageLayerView2D")],e)});