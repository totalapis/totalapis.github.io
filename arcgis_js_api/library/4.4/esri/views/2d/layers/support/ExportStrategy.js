// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/promiseUtils ../../tiling/TileInfoView ../../tiling/TileKey ../../engine/Bitmap ../../viewStateUtils ../../../../geometry/Extent ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo".split(" "),function(y,z,n,r,t,u,v,m,p,w,x){var k=[0,0,0,0],b=[0,0],q=new u(0,0,0,0),l={container:null,fetchImage:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,
imageDataAccessRequired:!1,hidpi:!1};return function(){function h(a){this._imagePromise=null;this.hidpi=l.hidpi;this.imageDataAccessRequired=l.imageDataAccessRequired;this.imageMaxWidth=l.imageMaxWidth;this.imageMaxHeight=l.imageMaxHeight;this.imageRotationSupported=l.imageRotationSupported;this.imageNormalizationSupported=l.imageNormalizationSupported;a=n({},l,a);this.container=a.container;this.fetchImage=a.fetchImage;this.requestUpdate=a.requestUpdate;this.imageMaxWidth=a.imageMaxWidth;this.imageMaxHeight=
a.imageMaxHeight;this.imageRotationSupported=a.imageRotationSupported;this.imageNormalizationSupported=a.imageNormalizationSupported;this.hidpi=a.hidpi}h.prototype.destroy=function(){};Object.defineProperty(h.prototype,"updating",{get:function(){return null!==this._imagePromise},enumerable:!0,configurable:!0});h.prototype.update=function(a){var g=this,c=a.state,e=w.getInfo(c.spatialReference),f=this.hidpi?a.devicePixelRatio:1;this._imagePromise&&(this._imagePromise.cancel(),this._imagePromise=null);
if(a.stationary){this.imageRotationSupported?(b[0]=c.width,b[1]=c.height):m.getOuterSize(b,c);b[0]=Math.floor(b[0]*f);b[1]=Math.floor(b[1]*f);a=!this.imageNormalizationSupported&&e&&(c.extent.xmin<e.valid[0]||c.extent.xmax>e.valid[1]);e=this.imageRotationSupported?c.rotation:0;if(b[0]>this.imageMaxWidth||b[1]>this.imageMaxHeight||a){var d=Math.min(this.imageMaxWidth,this.imageMaxHeight);a&&(d=Math.min(c.worldScreenWidth,d));this._imagePromise=this._tiledExport(c,d,e,f)}else this._imagePromise=this._singleExport(c,
b[0],b[1],e,f);this._imagePromise.then(function(a){g._imagePromise=null;g.container.removeAllChildren();a.forEach(g.container.addChild,g.container)}).otherwise(function(a){g._imagePromise=null;if("cancel"!==a.dojoType)throw a;})}};h.prototype.updateExports=function(a,g){for(var c=0,e=this.container.children;c<e.length;c++){var f=e[c];if(!f.visible||!f.attached)break;a(f,g)?console.error("ExportStrategy.updateExports doesn't support promise yet"):f.requestRender()}};h.prototype._export=function(a,
g,c,e,f){return this.fetchImage(a,g,c,{allowImageDataAccess:this.imageDataAccessRequired,rotation:e,pixelRatio:f}).then(function(d){var b=new v(d);b.coords[0]=d.coords[0]=a.xmin;b.coords[1]=d.coords[1]=a.ymax;b.resolution=d.resolution=a.width/g;d.rotation=e;d.pixelRatio=f;b.width=g;b.height=c;return b})};h.prototype._singleExport=function(a,g,c,e,f){m.getBBox(k,a.center,a.resolution,a.size);a=new p(k[0],k[1],k[2],k[3],a.spatialReference);return this._export(a,b[0],b[1],e,f).then(function(a){return[a]})};
h.prototype._tiledExport=function(a,b,c,e){var f=this,d=x.create({size:b,spatialReference:a.spatialReference,scales:[a.scale]}),g=new t(d),d=g.getTileCoverage(a);if(!d)return null;var h=[];d.forEach(function(d,l,m,n){q.set(d,l,m,n);g.getTileBounds(k,q);d=new p(k[0],k[1],k[2],k[3],a.spatialReference);h.push(f._export(d,b,b,c,e))});return r.all(h)};return h}()});