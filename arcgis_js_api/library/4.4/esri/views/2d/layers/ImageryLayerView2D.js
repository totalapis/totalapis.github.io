// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/HandleRegistry ../../../core/promiseUtils ../../../core/watchUtils ../../../Graphic ./LayerView2D ./support/ExportStrategy ../engine/BitmapSource ../engine/Canvas2DContainer ../engine/BitmapContainer".split(" "),function(d,v,g,h,f,k,l,m,n,p,q,r,t,u){d=function(d){function b(){var a=null!==d&&d.apply(this,arguments)||this;a._handles=new k;a.container=
new t;return a}g(b,d);b.prototype.hitTest=function(a,c){a=this.view.toMap(a,c);return l.resolve(new n({attributes:{},geometry:a}))};b.prototype.update=function(a){this.strategy.update(a);this.notifyChange("updating")};b.prototype.attach=function(){var a=this;this._tileContainer=new u;this.container.addChild(this._tileContainer);this.strategy=new q({container:this._tileContainer,fetchImage:this.fetchImage.bind(this),requestUpdate:function(){return a.requestUpdate()}});this._handles.add([m.watch(this,
"layer.exportImageServiceParameters.version",function(c){a._exportImageVersion!==c&&(a._exportImageVersion=c,a.requestUpdate())}),this.layer.on("redraw",function(){a.strategy.updateExports(function(c){c=c.source.data.getContext("2d");a.pixelData=a.layer.applyFilter(a._rawPixelData);a._drawPixelData(c,a.pixelData,0,0);return null})})])};b.prototype.detach=function(){this.container.removeChild(this._tileContainer);this.strategy.destroy();this._handles.removeAll()};b.prototype.moveStart=function(){};
b.prototype.viewChange=function(){};b.prototype.moveEnd=function(){this.requestUpdate()};b.prototype.isUpdating=function(){return this.attached&&(this.strategy.updating||this.updateRequested)};b.prototype.fetchImage=function(a,c,b,d){var e=this;this._exportImageVersion=this.get("layer.exportImageServiceParameters.version");return this.layer.fetchImage(a,c,b,d).then(function(a){e._rawPixelData=a.pixelData;e.pixelData=e.layer.applyFilter(e._rawPixelData);a=document.createElement("canvas");a.width=c;
a.height=b;var d=a.getContext("2d");e._drawPixelData(d,e.pixelData,0,0);e.notifyChange("updating");return new r(a)})};b.prototype._drawPixelData=function(a,c,b,d){if(c.pixelBlock){var e=c.pixelBlock;c=a.createImageData(e.width,e.height);e=e.getAsRGBA();c.data.set(e);a.putImageData(c,b,d)}};return b}(f.declared(p));return d=h([f.subclass("esri.views.2d.layers.ImageryLayerView2D")],d)});