// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/ObjectPool ../../../core/HandleRegistry ./LayerView2D ../engine/Bitmap ../engine/BitmapSource ../engine/BitmapContainer ../engine/Canvas2DContainer ../engine/Tiled ../../../geometry/support/webMercatorUtils ../tiling/TileStrategy ../tiling/TileKey ../tiling/TileInfoView ../tiling/TileQueue".split(" "),function(f,D,l,m,g,n,p,q,r,t,u,v,w,x,y,z,A,
B){var h=function(e){function c(a){a=e.call(this,a)||this;a.key=new z(0,0,0,0);return a}l(c,e);c.prototype.acquire=function(a){};c.prototype.release=function(){this.key.set(0,0,0,0)};return c}(w(r));h.pool=new n(h,!0);var C=[102113,102100,3857,3785,900913];f=function(e){function c(){var a=null!==e&&e.apply(this,arguments)||this;a._handles=new p;a._tileStrategy=null;a._tileInfoView=null;a._fetchQueue=null;a._tileRequests=new Map;a.container=new v;a.layer=null;return a}l(c,e);c.prototype.hitTest=function(a,
d){return null};c.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")};c.prototype.attach=function(){var a=this,d=this.layer.activeLayer,b=this.layer.findSublayerById(d.id).clone(),c;d.tileMatrixSetId?c=b.tileMatrixSets.find(function(a){return a.id===d.tileMatrixSetId}):(c=this._getTileMatrixSetBySpatialReference(b),d.tileMatrixSetId=c.id);var k=c.tileInfo.spatialReference,b=d.fullExtent||
b.fullExtent&&b.fullExtent;102100===k.wkid||102113===k.wkid?b=x.geographicToWebMercator(b):4326!==k.wkid&&(b=c.fullExtent);this._tileContainer=new u;this.container.addChild(this._tileContainer);this._tileInfoView=new A(c.tileInfo,b);this._fetchQueue=new B({tileInfoView:this._tileInfoView,process:function(b){return a.fetchTile(b)}});this._tileStrategy=new y({cachePolicy:"keep",acquireTile:function(b){return a.acquireTile(b)},releaseTile:function(b){return a.releaseTile(b)},tileInfoView:this._tileInfoView});
this._handles.add(d.watch("styleId",function(b){a.refresh()}));this._handles.add(this.layer.watch("activeLayer",function(b){if(!b.tileMatrixSetId){var d=a._getTileMatrixSetBySpatialReference(a.layer.activeLayer);b.tileMatrixSetId=d.id}a.refresh()}))};c.prototype.detach=function(){this._handles.removeAll();this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeChild(this._tileContainer);this._fetchQueue=this._tileStrategy=this._tileInfoView=this._tileContainer=null};c.prototype.moveStart=
function(){this.requestUpdate()};c.prototype.viewChange=function(){this.requestUpdate()};c.prototype.moveEnd=function(){this.requestUpdate()};c.prototype.refresh=function(){var a=this;this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(d){if(d.source){d.source=null;var b=a._fetchQueue.push(d.key).then(function(a){d.source=a;d.requestRender()});a._tileRequests.set(d,b)}})};c.prototype.getTileBounds=function(a,d){return this._tileStrategy.tileInfoView.getTileBounds(a,d)};c.prototype.getTileCoords=
function(a,d){return this._tileStrategy.tileInfoView.getTileCoords(a,d)};c.prototype.getTileResolution=function(a){return this._tileStrategy.tileInfoView.getTileResolution(a)};c.prototype.acquireTile=function(a){var d=this,b=h.pool.acquire();b.key.set(a);this._tileInfoView.getTileCoords(b.coords,b.key);b.resolution=this._tileInfoView.getTileResolution(b.key);a=this._tileInfoView.tileInfo.size;b.width=a[0];b.height=a[1];a=this._fetchQueue.push(b.key).then(function(a){b.source=a;b.once("attach",function(){return d.requestUpdate()});
d._tileContainer.addChild(b)});this._tileRequests.set(b,a);this.requestUpdate();return b};c.prototype.releaseTile=function(a){var d=this._tileRequests.get(a);d.isFulfilled()||d.cancel();this._tileRequests.delete(a);this._tileContainer.removeChild(a);this.requestUpdate()};c.prototype.fetchTile=function(a){var d=this;return this.layer.fetchTile(a.level,a.row,a.col).then(function(b){b=t.pool.acquire(b);b.coords=d.getTileCoords(b.coords,a);b.resolution=d.getTileResolution(a);return b})};c.prototype._getTileMatrixSetBySpatialReference=
function(a){var d=this.view.spatialReference,b=d.wkid,c=a.tileMatrixSets.find(function(a){return a.tileInfo.spatialReference.wkid===b});!c&&d.isWebMercator&&(c=a.tileMatrixSets.find(function(a){return-1<C.indexOf(a.tileInfo.spatialReference.wkid)}));return c};return c}(g.declared(q));m([g.property({dependsOn:["updateRequested","attached"]})],f.prototype,"updating",void 0);return f=m([g.subclass("esri.views.2d.layers.WMTSLayerView2D")],f)});