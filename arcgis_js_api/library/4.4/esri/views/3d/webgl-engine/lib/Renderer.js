// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ./IntervalUtilities ./ModelDirtyTypesTs ./Float32ArrayList ./InstanceBufferData ../lighting/SceneLighting ../materials/internal/SimpleGLMaterial ./LinearDepthTextureHelper ./NormalTextureHelper ./HighlightTextureHelper ./RenderPass ./RenderSlot ./RenderContext ./ExternalRendererContainer ./StencilRenderingHelper ./Util ./gl-matrix ./ComponentUtils ../../../webgl/Texture ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ../../../webgl/Util ./FxaaRenderPass ./SmaaRenderPass ../../../webgl/enums ./DefaultVertexAttributeLocations ../../../webgl/Profiling".split(" "),
function(T,oa,U,pa,V,ca,da,W,ea,fa,ga,A,p,ha,ia,ja,G,Q,N,X,O,R,F,ka,la,qa,S,ma){var D=G.assert,Y=G.objectEmpty,K=G.getFirstObjectValue,P=G.setMatrixTranslation3;T=Q.vec2d;var Z=Q.vec4d,C=Q.mat4d,aa=G.VertexAttrConstants,M=C.identity();G=function(){function f(a,b,d,c,e){this._lighting=new da.SceneLighting;this._mat2dataMerged={};this._mat2dataInstanced={};this._renderOrder=[];this._externalRenderers=new ia;this._renderContext=new ha;this._framesRendered=0;this._isRendering=!1;this._highlights=[];this._pixelRatio=
1;this._threshold=1535;this._needsRender=!0;this._fallbackDepthStencilTexture=null;this._stats=new na;this.ssaoEnabled=!1;this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1};this._programRep=a;this._materialRep=b;this._textureRep=d;this._orderedRendering=e;this._rctx=c;b=c.gl;this._fxaaPass=new ka(c);this._smaaPass=new la(c);this._selectionMaterial=new W(a,Z.createFrom(.1,.2,.9,.4),b.EQUAL);this._selectionMaterialLines=new W(a,Z.createFrom(.1,.2,.9,.4),b.EQUAL,b.LINES);this._renderContext.lightingData=
this._lighting.getOld();c.setDepthTestEnabled(!0);c.setFaceCullingEnabled(!0);c.setBlendingEnabled(!1);c.setBlendFunctionSeparate(770,771,1,771);this._bindParameters={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null,extensions:{angleInstancedArrays:c.extensions.angleInstancedArrays}};this._linearDepthTextureHelper=new ea(c);
this._normalTextureHelper=new fa(c);this._highlightTextureHelper=new ga(c);this._stencilRenderingHelper=new ja(c);this._initializeFramebufferTexture()}f.prototype._initializeFramebufferTexture=function(){var a=this._rctx.gl,a=this._rctx.contextAttributes.alpha?a.RGBA:a.RGB,b=new X(this._rctx,{target:3553,pixelFormat:a,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:a,texture:b}};f.prototype.dispose=function(){for(var a in this._mat2dataMerged){this._releaseMaterials(a);
var b=this._mat2dataMerged[a],d;for(d in b.origin2data)b.origin2data[d].vao.dispose(!0)}this._mat2dataMerged=null;for(a in this._mat2dataInstanced)for(d in this._releaseMaterials(a),b=this._mat2dataInstanced[a],b.origin2data)b.origin2data[d].vao.dispose(!0);this._mat2dataInstanced=null;this._framebuffer.texture.dispose();this._framebuffer.texture=null;this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable();this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable();
this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1);this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1);this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null)};f.prototype.setLighting=function(a){this._lighting.set(a)};f.prototype.setPixelRatio=function(a){this._pixelRatio=a;this._needsRender=!0};f.prototype.getPixelRatio=function(){return this._pixelRatio};
f.prototype.addExternalRenderer=function(a,b){this._externalRenderers.addRenderer(a,b);return!0};f.prototype.removeExternalRenderer=function(a){this._externalRenderers.removeRenderer(a);return!0};f.prototype.getExternalRenderers=function(){return this._externalRenderers};f.prototype.resetNeedsRender=function(){this._needsRender=!1;this._externalRenderers.resetNeedsRender()};f.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()};f.prototype.getCombinedStats=
function(){this._stats.VBOallocatedSize=0;this._stats.VBOoptimalSize=0;this._stats.VBOusedSize=0;for(var a in this._mat2dataInstanced){var b=this._mat2dataInstanced[a],d;for(d in b.origin2data){var c=b.origin2data[d];this._stats.VBOallocatedSize+=c.buffer.getArray().length;this._stats.VBOusedSize+=c.buffer.getSize();this._stats.VBOoptimalSize+=c.optimalCount}}for(a in this._mat2dataMerged)for(d in b=this._mat2dataMerged[a],b.origin2data)c=b.origin2data[d],this._stats.VBOallocatedSize+=c.buffer.getArray().length,
this._stats.VBOusedSize+=c.buffer.getSize(),this._stats.VBOoptimalSize+=c.optimalCount;this._stats.VBOallocatedSize*=.00390625;this._stats.VBOusedSize*=.00390625;this._stats.VBOoptimalSize*=.00390625;return this._stats};f.prototype._addHighlight=function(a){var b=this._getInstance(a,!0)||this._getInstance(a,!1);if(null===b)console.error("No instance found for RenderGeometry {name: '"+a.name+"', uniqueName: '"+a.uniqueName+"'}");else if(this._highlights.push(b),this._orderedRendering&&this._sortHighlightsByRenderOrder(),
this._needsRender=!0,this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights)};f.prototype._removeHighlight=function(a){var b=this._highlights.length;this._highlights=this._highlights.filter(function(b){return b.uniqueName!==a.uniqueName});if(b!==this._highlights.length){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights);this._needsRender=!0}};Object.defineProperty(f.prototype,"hasHighlights",{get:function(){return 0<this._highlights.length},enumerable:!0,
configurable:!0});f.prototype._renderHUDVisibility=function(a){var b=this;a.offscreenRenderingHelper.renderHUDVisibility(function(){b._renderInternalSlot(p.OCCLUSION_PIXELS,a)})};f.prototype.renderGeometrySlots=function(a){this._externalRenderers.render(p.INTERNAL_MATERIAL,a);this._renderInternalSlot(p.STENCIL_MATERIAL,a);this._externalRenderers.render(p.OPAQUE_TERRAIN,a);this._renderInternalSlot(p.OPAQUE_MATERIAL,a);this._externalRenderers.render(p.OPAQUE_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);
this._renderInternalSlot(p.TRANSPARENT_MATERIAL,a);this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(a),this._renderInternalSlot(p.LINE_CALLOUTS,this._renderContext));this._externalRenderers.render(p.TRANSPARENT_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);this._externalRenderers.render(p.TRANSPARENT_TERRAIN,a)};f.prototype._renderHighlights=function(a,b,d){var c=!!d&&d.getEnableState()&&(this.hasHighlights||this._externalRenderers.needsHighlight());this._highlightTextureHelper.setEnableState(c);
if(c){c=null;d.profilingCallback&&(c=ma.startMeasurement(this._renderContext.rctx));this._highlightTextureHelper.setupFBOs(a);this._highlightTextureHelper.prepareHighlightPass();this.renderGeometryPass(A.MATERIAL_HIGHLIGHT,a,null,null);this._rctx.clear(this._rctx.gl.DEPTH_BUFFER_BIT);this._renderInternalSlot(p.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL2,this._renderContext);this._highlightTextureHelper.finish(b);
var e=this._highlightTextureHelper.getHighlightFBO();d.render(a,b,e);null!==c&&d.profilingCallback&&c.stop(function(a){d.profilingCallback&&d.profilingCallback(a)})}};f.prototype._renderUnordered=function(a,b,d,c,e,l){var g=this._rctx;this._isRendering=!0;this._stats.reset();this._updateGlobalUniforms(a.projectionMatrix);this._renderContext.pass=A.MATERIAL;this._renderContext.camera=a;this._renderContext.shadowMap=b;this._renderContext.ssaoHelper=d;this._renderContext.offscreenRenderingHelper=e;this._renderContext.stencilRenderingHelper=
this._stencilRenderingHelper;this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO();this._renderContext.options=this.renderOptions;this._renderContext.rctx=this._rctx;this._renderContext.lightingData=this._lighting.getOld();e.setEnableState(!0);e.initializeFrame(a);this._externalRenderers.render(p.BACKGROUND,this._renderContext);this.renderGeometrySlots(this._renderContext);
this._externalRenderers.render(p.POSTPROCESSING_ATMOSPHERE,this._renderContext);this.renderOptions.earlyOcclusionPixelDraw||(this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(p.LINE_CALLOUTS,this._renderContext));switch(this.renderOptions.antialiasing){case "none":b=a.viewport;b=C.ortho(b[0],b[2],b[1],b[3],-1,1);e.drawQuad(b);this._fxaaPass.disable();this._smaaPass.disable();break;case "fxaa":this._smaaPass.disable();this._fxaaPass.render({colorTexture:e.getColorTexture()},null);
break;case "smaa":this._fxaaPass.disable(),this._smaaPass.render({colorTexture:e.getColorTexture()},null)}g.bindFramebuffer(null);this._renderContext.framebufferTex=e.getColorTexture();this._renderInternalSlot(p.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(p.HUDMATERIAL2,this._renderContext);this._renderHighlights(a,c,l);this._framesRendered++;this._isRendering=!1};f.prototype._renderGeometryPassOrderedHighlight=
function(a){this._renderInternalHighlights(this._highlights)};f.prototype._renderGeometryPassOrderedMaterial=function(a){for(var b=null,d=0;d<this._renderOrder.length;d++){var c=this._renderOrder[d][1];if(c.instanced){var e=c.instanced||c.merged,l=e[a.pass];!l||l.isVisible&&!l.isVisible()||(this._renderInternalInstanced(e,l,this._bindParameters,Infinity),b=null)}c.merged&&(e=c.merged,!(l=e[a.pass])||l.isVisible&&!l.isVisible()||(c=l.getProgram(),c!==b&&(c.setUniformMatrix4fv("model",M),c.hasUniform("modelNormal")&&
c.setUniformMatrix4fv("modelNormal",M)),b=c,this._renderInternalMerged(e,l,this._bindParameters,Infinity)))}};f.prototype._renderGeometryPassOrdered=function(a){var b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;H[0]=b.near;H[1]=b.far;this._bindParameters.nearFar=H;this._bindParameters.lightingData=this._lighting.getOld();this._bindParameters.viewport=b.fullViewport;this._bindParameters.framebufferTex=
this._framebuffer.texture;this._bindParameters.pixelRatio=this._pixelRatio;this._bindParameters.instanceParameters=void 0;this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO();a.isHighlightPass?this._renderGeometryPassOrderedHighlight(a):this._renderGeometryPassOrderedMaterial(a)};f.prototype._renderOrdered=function(a,b){this._stats.reset();this.renderGeometryPass(a,b);this._framesRendered++};f.prototype.render=
function(a,b,d,c,e,l){this._orderedRendering?this._renderOrdered(A.MATERIAL,a):this._renderUnordered(a,b,d,c,l,e)};f.prototype.renderAuxiliaryBuffers=function(a,b,d,c,e){e=this.ssaoEnabled;this._linearDepthTextureHelper.setEnableState(e);e&&(this._linearDepthTextureHelper.setupFBOs(a),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(A.MATERIAL_DEPTH,a,b,d),this._linearDepthTextureHelper.finish(c));this._normalTextureHelper.setEnableState(this.ssaoEnabled);this.ssaoEnabled&&
(this._normalTextureHelper.setupFBOs(a),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(A.MATERIAL_NORMAL,a,b,d),this._normalTextureHelper.finish(c));this.ssaoEnabled&&d.computeSSAO(a,c,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO());d.bindAll(this._programRep)};f.prototype.renderGeometryPass=function(a,b,d,c){this._isRendering=!0;this._updateGlobalUniforms(b.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=b;this._renderContext.shadowMap=
d;this._renderContext.ssaoHelper=c;this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._renderContext.rctx=this._rctx;this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext);this._isRendering=!1};f.prototype._renderGeometryPassUnordered=function(a){this.renderGeometrySlots(a)};f.prototype._renderInternalHighlights=function(a,b){void 0===
b&&(b=null);for(var d=0;d<a.length;++d){var c=a[d],e=c.matData[A.MATERIAL_HIGHLIGHT];!e||null!==b&&!e.beginSlot(b)||e.isVisible&&!e.isVisible()||this._renderInternalHighlight(c,this._bindParameters,A.MATERIAL_HIGHLIGHT)}};f.prototype._renderInternalSlotMaterial=function(a,b){for(var d in this._mat2dataInstanced){var c=this._mat2dataInstanced[d],e=c[b.pass];e&&e.beginSlot(a)&&(!e.isVisible||e.isVisible())&&this._renderInternalInstanced(c,e,this._bindParameters,a)}for(var c=this._programRep.getProgramsUsingUniform("model"),
e=this._programRep.getProgramsUsingUniform("modelNormal"),l=0;l<c.length;l++){var g=c[l];g.setUniformMatrix4fv("model",M);-1<e.indexOf(g)&&g.setUniformMatrix4fv("modelNormal",M)}for(d in this._mat2dataMerged)c=this._mat2dataMerged[d],(e=c[b.pass])&&e.beginSlot(a)&&(!e.isVisible||e.isVisible())&&this._renderInternalMerged(c,e,this._bindParameters,a);a===p.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish()};f.prototype._renderInternalSlotHighlights=function(a,b){this._renderInternalHighlights(this._highlights,
a)};f.prototype._renderInternalSlot=function(a,b){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;this._bindParameters.poiDistance=b.camera.distance;H[0]=b.camera.near;H[1]=b.camera.far;var d=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=H;this._bindParameters.lightingData=
this._lighting.getOld();this._bindParameters.viewport=b.camera.fullViewport;this._bindParameters.framebufferTex=d?d.getColorTexture():null;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.getEnableState();this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.getEnableState();this._bindParameters.pixelRatio=this._pixelRatio;this._bindParameters.instanceParameters=void 0;this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();
this._bindParameters.hudVisibilityTexture=d?d.getHUDVisibilityTexture():null;b.isHighlightPass?this._renderInternalSlotHighlights(a,b):this._renderInternalSlotMaterial(a,b)};f.prototype._renderInternalInstanced=function(a,b,d,c){var e=this._rctx,l=e.gl,g=!1,f=b.getDrawMode(e),h=this._bindParameters.extensions.angleInstancedArrays,k;for(k in a.origin2data){var w=a.origin2data[k];d.origin=w.origin;c===p.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());
var v=!1;if(b.instanced)for(var m in w.perGeometryDataInfo){var n=w.perGeometryDataInfo[m];g||(b.bind(e,d),g=!0);e.bindVAO(n.vao);var y=b.getProgram();F.assertCompatibleVertexAttributeLocations(n.vao,y);v||(b.bindView(e,d),v=!0);var y=n.to-n.from,u=n.refCount;f===l.TRIANGLES&&(this._stats.trianglesRendered+=u*y/3);h.drawArraysInstancedANGLE(f,n.from,y,u);this._stats.drawCallsAngleInstanced++;this._stats.instancesDrawnAngle+=u}else{var n=w.instances,t;for(t in n)y=n[t],u=y.displayedIndexRange,u&&0===
u.length||(g||(b.bind(e,d),g=!0),v||(e.bindVAO(w.vao),b.bindView(e,d),v=!0),b.bindInstance(e,y),this._stats.drawCallsInstanced++,f===l.TRIANGLES&&(this._stats.trianglesRendered+=(y.to-y.from)/3),u?this._drawArraysFaceRange(u,y.from,f):e.drawArrays(f,y.from,y.to-y.from))}}e.bindVAO(null);g&&b.release(e,d)};f.prototype._renderInternalHighlight=function(a,b,d){var c=this._rctx,e=c.gl;d=a.matData[d];var l=d.getDrawMode(c),g=a.instance,f=g.highlightedIndexRange,h=this._renderContext.offscreenRenderingHelper,
h=(h?h.getDepthTexture():null)||this._getFallbackDepthTexture(),k=d.getProgram(),w=this._bindParameters.extensions.angleInstancedArrays;b.origin=a.originData.origin;if(d.instanced&&"instanced"===a.type){var v=a.instancedVAO;d.bind(c,b);c.bindVAO(v);F.assertCompatibleVertexAttributeLocations(v,k);d.bindView(c,b);for(a=0;a<f.length;a++){var m=f[a],v=m.range?m.range[0]+g.from:g.from,m=m.range?m.range[1]-m.range[0]+1:g.to-g.from;c.bindTexture(h,5);k.setUniform1i("depthTex",5);k.setUniform4f("highlightViewportPixelSz",
0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);w.drawArraysInstancedANGLE(l,v,m,1);l===e.TRIANGLES&&(this._stats.trianglesRendered+=1*m/3);this._stats.drawCallsHighlight++}}else if("merged"===a.type||"instanced"===a.type&&!d.instanced)for(v=a.originData.vao,d.bind(c,b),c.bindVAO(v),d.bindView(c,b),"instanced"===a.type?d.bindInstance(c,g):k.setUniformMatrix4fv("model",M),a=0;a<f.length;a++)m=f[a],v=m.range?m.range[0]+g.from:g.from,m=m.range?m.range[1]-m.range[0]+1:g.to-
g.from,c.bindTexture(h,5),d.getProgram().setUniform1i("depthTex",5),k.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),c.drawArrays(l,v,m),l===e.TRIANGLES&&(this._stats.trianglesRendered+=m/3),this._stats.drawCallsHighlight++;else console.error("_renderInternalHighlight: incompatible istance type");c.bindVAO(null);d.release(c,b)};f.prototype._drawArraysFaceRange=function(a,b,d){for(var c=this._rctx,e=0;e<a.length;e++){var l=a[e];c.drawArrays(d,
l[0]+b,l[1]-l[0]+1)}this._stats.drawCallsFragmented+=a.length-1};f.prototype._renderInternalMerged=function(a,b,d,c){var e=this._rctx,l=e.gl,g=!1,f;for(f in a.origin2data){var h=a.origin2data[f];d.origin=h.origin;c===p.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());if(!h.displayedIndexRange||0!==h.displayedIndexRange.length){g||(b.bind(e,d),g=!0);var k=b.getProgram();e.bindVAO(h.vao);F.assertCompatibleVertexAttributeLocations(h.vao,
k);b.bindView(e,d);this._stats.drawCallsMerged++;k=b.getDrawMode(e);k===l.TRIANGLES&&(this._stats.trianglesRendered+=h.vao.vertexBuffers.geometry.size/3);h.displayedIndexRange?this._drawArraysFaceRange(h.displayedIndexRange,0,k):e.drawArrays(k,0,F.vertexCount(h.vao,"geometry"))}}g&&b.release(e,d)};f.prototype._updateGlobalUniforms=function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),d=0;d<b.length;d++)b[d].setUniformMatrix4fv("proj",a);if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");
for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d])}};f.prototype.print=function(){var a=Object.keys(this._mat2dataMerged).length,b=Object.keys(this._mat2dataInstanced).length;console.log("number of materials (merged/instanced): "+a+"/"+b);var a=0,d;for(d in this._mat2dataMerged){var b=this._mat2dataMerged[d],c;for(c in b.origin2data)a+=Object.keys(b.origin2data[c].instances).length}var e=
0;for(d in this._mat2dataInstanced)for(c in b=this._mat2dataInstanced[d],b.origin2data)e+=Object.keys(b.origin2data[c].instances).length;console.log("number of instances (merged/instanced): "+a+"/"+e)};f.prototype.isEmpty=function(){for(var a in this._mat2dataInstanced){var b=this._mat2dataInstanced[a],d;for(d in b.origin2data)if(!Y(b.origin2data[d].instances))return!1}for(a in this._mat2dataMerged)for(d in b=this._mat2dataMerged[a],b.origin2data)if(!Y(b.origin2data[d].instances))return!1;return!0};
f.prototype.modify=function(a,b,d,c){this._isRendering&&console.warn("Renderer.modify called while rendering");var e=[],l=[];this._mergedOrInstanced(a,e,l);a=[];var g=[];this._mergedOrInstanced(b,a,g);var f={};d&&this._performUpdates(d,f);d=[];this._modifyMerged(e,a,d,f);this._modifyInstanced(l,g,d);this._updateMergedFaceranges(f);this._releaseMaterials(d);e=this._highlights.length;if(b&&0<b.length&&0<e&&(this._highlights=this._highlights.filter(function(a){return!b.some(function(b){return b.uniqueName===
a.uniqueName})}),e!==this._highlights.length&&this.onHasHighlightsChanged))this.onHasHighlightsChanged(this.hasHighlights);this._updateHighlightVAOs();this._modifyMaterials(c);this._needsRender=!0};f.prototype._isInstanced=function(a){var b=!1,d=K(a.data.faces.indices).length,b=(b=(b=b||!1===a.material.canBeMerged)||a.material.instanced)||a.material.isBackdrop;return a.singleUse?b:b=b||d>this._threshold};f.prototype._mergedOrInstanced=function(a,b,d){for(var c=0;c<a.length;++c)1>K(a[c].data.faces.indices).length||
(this._isInstanced(a[c])?d.push(a[c]):b.push(a[c]))};f.prototype._performUpdates=function(a,b){for(var d=0;d<a.length;d++){var c=a[d],e=c.renderGeometry,l=this._isInstanced(e),c=c.updateType;c&2&&this._updateFaceranges(e,l,b);if(c&32){var g=this._getInstance(e,l);g&&this._updateHighlightFaceranges(e,g.instance)}c&4||!l&&c&16?this._updateVertexAttributes(e,l):l&&c&16?this._updateInstanceTransformation(e,l):c&8&&this._updateColorAttributes(e)}};f.prototype._updateFaceranges=function(a,b,d){var c=a.material.getId(),
e=a.origin.id,l=(b?this._mat2dataInstanced:this._mat2dataMerged)[c].origin2data[e],g=l.instances[a.uniqueName];g&&(g.displayedIndexRange=N.generateVisibleIndexRanges(a.instanceParameters.componentVisibilities,a.componentOffsets),b||(d[this._modifiedMergedFacerangesKey(c,e)]=l),this._updateHighlightFaceranges(a,g))};f.prototype._updateHighlightFaceranges=function(a,b){if(b){var d=b.highlightedIndexRange,c;c=N.generateHighlightedIndexRanges(a.instanceParameters.componentVisibilities,a.instanceParameters.componentHighlights,
a.componentOffsets);(b.highlightedIndexRange=c)&&!d?this._addHighlight(a):!c&&d&&this._removeHighlight(a)}};f.prototype._updateMergedFaceranges=function(a){for(var b in a){var d=a[b];d.displayedIndexRange=[];var c=d.instances,e=!0,l;for(l in c){var g=c[l];g.displayedIndexRange?(d.displayedIndexRange.push.apply(d.displayedIndexRange,U.offsetIntervals(g.displayedIndexRange,g.from)),e=!1):d.displayedIndexRange.push([g.from,g.to-1])}d.displayedIndexRange=e?null:U.mergeIntervals(d.displayedIndexRange)}};
f.prototype._updateVertexAttributes=function(a,b){var d=a.material,c=d.getId(),c=(b?this._mat2dataInstanced:this._mat2dataMerged)[c].origin2data[a.origin.id],e=c.instances[a.uniqueName],l,g;b||(l=a.origin.vec3,P(I,-l[0],-l[1],-l[2]),C.multiply(I,a.transformation,J),C.inverse(J,L),C.transpose(L),l=J,g=L);b=F.getStride(d.getVertexBufferLayout());var f=b/4;D(e.from+d.getOutputAmount(K(a.data.faces.indices).length)/f===e.to,"material VBO layout has changed");d.fillInterleaved(a.data,l,g,a.instanceParameters,
c.buffer.getArray(),e.from*f);c.vao.vertexBuffers.geometry.setSubData(c.buffer.getArray(),e.from*b,e.from*b,e.to*b)};f.prototype._updateInstanceTransformation=function(a,b){var d=a.origin.vec3,c=(b?this._mat2dataInstanced:this._mat2dataMerged)[a.material.getId()].origin2data[a.origin.id];b=c.instances[a.uniqueName];P(I,-d[0],-d[1],-d[2]);C.multiply(I,a.transformation,b.transformation);C.inverse(b.transformation,b.transformationNormal);C.transpose(b.transformationNormal,b.transformationNormal);d=c.perGeometryDataInfo[a.data.id];
if(c=d.instanceBufferData)a=c.getSlot(a.idx),c.fill(a,0,b.transformation),c.fill(a,16,b.transformationNormal),a=4*c.getOffset(a),b=F.getStride(d.vao.layout.instance),d.vao.vertexBuffers.instance.setSubData(c.getArray(),a,a,a+b)};f.prototype._updateColorAttributes=function(a){var b=a.material,d=b.getId(),c=a.origin.id,d=(this._isInstanced(a)?this._mat2dataInstanced:this._mat2dataMerged)[d].origin2data[c],c=d.instances[a.uniqueName],e=(l={},l[aa.COLOR]=!0,l[aa.SYMBOLCOLOR]=!0,l),l=F.getStride(b.getVertexBufferLayout())/
4;D(c.from+b.getOutputAmount(K(a.data.faces.indices).length)/l===c.to,"material VBO layout has changed");b.fillInterleaved(a.data,void 0,void 0,a.instanceParameters,d.buffer.getArray(),c.from*l,e);d.vao.vertexBuffers.geometry.setSubData(d.buffer.getArray(),c.from*l*4,c.from*l*4,c.to*l*4);var l};f.prototype._modifyMerged=function(a,b,d,c){var e=this._rctx;a=this._compMat2delta(a,b,!1);for(var l in a){b=a[l];for(var g in b){var f=b[g],h=f.optimalCount,k=f.material,w=k.getVertexBufferLayout(),v=F.getStride(w)/
4,m=this._mat2dataMerged[l];if(null==m){D(0<h);var n=k.getRenderPriority(),m={origin2data:{}};m[A.MATERIAL]=this._materialRep.aquire(k);m[A.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(k);m[A.MATERIAL_NORMAL]=this._materialRep.aquireNormal(k);m[A.MATERIAL_DEPTH]=this._materialRep.aquireDepth(k);m[A.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(k);this._mat2dataMerged[l]=m;this._orderedRendering&&this._insertIntoRenderOrder(m,n,"merged")}n=m.origin2data[g];null==n&&(D(0<
h),n={instances:{},vao:new O(e,S.Default3D,{geometry:w},{geometry:R.createVertex(e,35044)}),buffer:new V(h),optimalCount:0,origin:f.origin},m.origin2data[g]=n);if(0<h){var w=n.buffer.getSize(),y=n.buffer.getArray(),m=h<f.sparseCount/2,u=n.buffer.resize(m?h:f.sparseCount),t=f.toRemove;if(m||u){for(var w=0,x=n.buffer.getArray(),m=0;m<t.length;++m)u=n.instances[t[m].uniqueName],n.optimalCount-=(u.to-u.from)*v,delete n.instances[t[m].uniqueName];var m={},z;for(z in n.instances)u=n.instances[z],D(null==
m[u.from]),m[u.from]=u;for(var q in m){var u=m[q],r=u.from*v,B=u.to*v;x.set(y.subarray(r,B),w);u.from=w/v;w+=B-r;u.to=w/v}D(w===n.optimalCount)}else for(m=0;m<t.length;++m)u=t[m].uniqueName,D(void 0!==n.instances[u]),r=n.instances[u].from*v,B=n.instances[u].to*v,n.buffer.erase(r,B),delete n.instances[u],n.optimalCount-=B-r;P(I,-f.origin[0],-f.origin[1],-f.origin[2]);y=f.toAdd;f=!1;for(m=0;m<y.length;++m)t=y[m],r=t.data,C.multiply(I,t.transformation,J),C.inverse(J,L),C.transpose(L),u=w,k.fillInterleaved(r,
J,L,t.instanceParameters,n.buffer.getArray(),w),r=k.getOutputAmount(K(r.faces.indices).length),x=u+r,D(null==n.instances[t.uniqueName]),B=N.generateVisibleIndexRanges(t.instanceParameters.componentVisibilities,t.componentOffsets),u=new ba(t.name,u/v,x/v,B,void 0,void 0,t.idx),n.instances[t.uniqueName]=u,this._updateHighlightFaceranges(t,u),B&&(f=!0),n.optimalCount+=r,w+=r;D(n.optimalCount===h);h=new Float32Array(n.buffer.getArray().buffer,0,n.buffer.getSize());n.vao.vertexBuffers.geometry.setData(h);
if(f||n.displayedIndexRange)c[this._modifiedMergedFacerangesKey(l,g)]=n}else D(0===h),n.vao.dispose(!0),n.vao=null,delete m.origin2data[g],0===Object.keys(m.origin2data).length&&(d.push(l),delete this._mat2dataMerged[l],this._orderedRendering&&this._removeFromRenderOrder(m,"merged"))}}};f.prototype._modifyInstanced=function(a,b,d){a=this._compMat2delta(a,b,!0);b=this._rctx;for(var c in a){var e=a[c],f;for(f in e){var g=e[f];if(0===g.optimalCount)g=this._mat2dataInstanced[c],g.origin2data[f].vao.dispose(!0),
delete g.origin2data[f],0===Object.keys(g.origin2data).length&&(d.push(c),delete this._mat2dataInstanced[c],this._orderedRendering&&this._removeFromRenderOrder(g,"instanced"));else{var E=g.material,h=this._mat2dataInstanced[c];if(null==h){var k=E.getRenderPriority(),h={origin2data:{}};h[A.MATERIAL]=this._materialRep.aquire(E);h[A.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(E);h[A.MATERIAL_NORMAL]=this._materialRep.aquireNormal(E);h[A.MATERIAL_DEPTH]=this._materialRep.aquireDepth(E);
h[A.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(E);this._mat2dataInstanced[c]=h;this._orderedRendering&&this._insertIntoRenderOrder(h,k,"instanced")}var w=E.getVertexBufferLayout(),v=h[A.MATERIAL].instanced?E.getInstanceBufferLayout():void 0,m=v&&F.findAttribute(v,"instanceColor"),n=v&&F.findAttribute(v,"instanceFeatureAttribute"),y=F.getStride(w)/4,k=h.origin2data[f];null==k&&(k={instances:{},vao:new O(b,S.Default3D,{geometry:w},{geometry:R.createVertex(b,35044)}),buffer:new V(g.optimalCount),
optimalCount:0,perGeometryDataInfo:{},origin:g.origin},h.origin2data[f]=k);var h=k.buffer.getSize(),u=k.buffer.getArray(),t=g.optimalCount<g.sparseCount/2,x=k.buffer.resize(t?g.optimalCount:g.sparseCount),z;for(z in g.perGeometryDelta){var q=k.perGeometryDataInfo[z];if(q&&q.instanceBufferData){var r=g.perGeometryDelta[z].removeCount;0<r&&q.instanceBufferData.prepareFree(r)}}var B=g.toRemove;if(t||x){for(t=0;t<B.length;++t){x=B[t];delete k.instances[x.uniqueName];z=x.data.id;var p=q=k.perGeometryDataInfo[z];
0===--p.refCount&&null==g.dataId2refCount[z]?(k.optimalCount-=(p.to-p.from)*y,delete k.perGeometryDataInfo[z]):q.instanceBufferData&&q.instanceBufferData.free(x.idx)}var h=0,t=k.buffer.getArray(),x={},G;for(G in k.perGeometryDataInfo)p=k.perGeometryDataInfo[G],D(null==x[p.from]),x[p.from]=p;for(var H in x)p=x[H],r=p.from*y,q=p.to*y,t.set(u.subarray(r,q),h),p.from=h/y,h+=q-r,p.to=h/y;for(var J in k.instances)r=k.instances[J],r.from=k.perGeometryDataInfo[r.dataId].from,r.to=k.perGeometryDataInfo[r.dataId].to}else for(t=
0;t<B.length;++t)x=B[t],delete k.instances[x.uniqueName],z=x.data.id,q=k.perGeometryDataInfo[z],0===--q.refCount&&null==g.dataId2refCount[z]?(r=q.from*y,q=q.to*y,k.buffer.erase(r,q),k.optimalCount-=q-r,delete k.perGeometryDataInfo[z]):q.instanceBufferData&&q.instanceBufferData.free(x.idx);P(I,-g.origin[0],-g.origin[1],-g.origin[2]);for(z in g.perGeometryDelta)(q=k.perGeometryDataInfo[z])&&q.instanceBufferData&&(t=g.perGeometryDelta[z].addCount,0<t&&q.instanceBufferData.prepareAllocate(t));u=g.toAdd;
for(t=0;t<u.length;++t)if(x=u[t],r=x.data,z=r.id,q=k.perGeometryDataInfo[z],null==q?(E.fillInterleaved(r,void 0,void 0,void 0,k.buffer.getArray(),h),B=E.getOutputAmount(K(r.faces.indices).length),r=h/y,h+=B,q=h/y,k.optimalCount+=B,q={refCount:1,from:r,to:q,vao:null,instanceBufferData:null},v&&(r=F.getStride(v)/4,q.vao=new O(b,S.Default3D,{geometry:w,instance:v},{geometry:k.vao.vertexBuffers.geometry,instance:R.createVertex(b,35044)}),q.instanceBufferData=new ca(r,g.perGeometryDelta[z].addCount)),
k.perGeometryDataInfo[z]=q):++q.refCount,D(q.from*y<=k.buffer.getSize()&&q.to*y<=k.buffer.getSize()),r=C.create(),C.multiply(I,x.transformation,r),B=N.generateVisibleIndexRanges(x.instanceParameters.componentVisibilities,x.componentOffsets),r=new ba(x.name,q.from,q.to,B,r,x.instanceParameters,x.idx,z),k.instances[x.uniqueName]=r,this._updateHighlightFaceranges(x,r),q=q.instanceBufferData)B=q.allocate(x.idx),q.fill(B,0,r.transformation),q.fill(B,16,r.transformationNormal),m&&q.fill(B,m.offset/4,x.instanceParameters.color),
n&&q.fill(B,n.offset/4,x.instanceParameters.featureAttribute);D(k.optimalCount===g.optimalCount);E=new Float32Array(k.buffer.getArray().buffer,0,k.buffer.getSize());k.vao.vertexBuffers.geometry.setData(E);for(z in k.perGeometryDataInfo)if(w=k.perGeometryDataInfo[z],w.vao&&(E=w.vao.vertexBuffers.instance))v=g.perGeometryDelta[z],0<v.addCount+v.removeCount&&(w=w.instanceBufferData.compact(),E.setData(w))}}}};f.prototype._compMat2delta=function(a,b,d){var c={};this._updateMat2delta(a,!0,d,c);this._updateMat2delta(b,
!1,d,c);return c};f.prototype._updateMat2delta=function(a,b,d,c){for(var e=0;e<a.length;++e){var f=a[e],g=f.origin,p=f.material,h=p.getId(),k=d?this._mat2dataInstanced[h]:this._mat2dataMerged[h],k=k&&k.origin2data[g.id],w=c[h];null==w&&(w={},c[h]=w);h=w[g.id];if(null==h){h={optimalCount:null==k?0:k.optimalCount,sparseCount:null==k?0:k.buffer.getSize(),material:p,toAdd:[],toRemove:[],perGeometryDelta:null,origin:g.vec3};if(d){var v={};if(void 0!==k)for(var m in k.perGeometryDataInfo)v[m]=k.perGeometryDataInfo[m].refCount;
h.dataId2refCount=v;h.perGeometryDelta={}}w[g.id]=h}g=p.getOutputAmount(K(f.data.faces.indices).length);d?(p=f.data.id,k=h.perGeometryDelta[p],k||(k={addCount:0,removeCount:0},h.perGeometryDelta[p]=k),b?(k.addCount++,null==h.dataId2refCount[p]&&(h.dataId2refCount[p]=0),1===++h.dataId2refCount[p]&&(h.optimalCount+=g,h.sparseCount+=g),h.toAdd.push(f)):(k.removeCount++,0===--h.dataId2refCount[p]&&(delete h.dataId2refCount[p],h.optimalCount-=g),h.toRemove.push(f))):b?(h.optimalCount+=g,h.sparseCount+=
g,h.toAdd.push(f)):(h.optimalCount-=g,h.toRemove.push(f))}};f.prototype._modifiedMergedFacerangesKey=function(a,b){return a+"_"+b};f.prototype._insertIntoRenderOrder=function(a,b,d){for(var c=a[A.MATERIAL].getMaterialId(),e=this._renderOrder.length,f=0;f<e&&this._renderOrder[f][0]>=b;){var g=this._renderOrder[f][1];if(g.id===c){D(!g[d],"matData for type already exists");g[d]=a;return}f++}c={id:c,instanced:null,merged:null};c[d]=a;this._renderOrder.splice(f,0,[b,c])};f.prototype._removeFromRenderOrder=
function(a,b){var d=a[A.MATERIAL].getMaterialId();for(a=0;this._renderOrder[a][1].id!==d;)a++;d=this._renderOrder[a][1];d[b]=null;d.instanced||d.merged||this._renderOrder.splice(a,1)};f.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(a,b){a=a.matData[A.MATERIAL].getRenderPriority();b=b.matData[A.MATERIAL].getRenderPriority();return a>b?-1:b>a?1:0})};f.prototype._updateRenderOrder=function(a,b){for(var d=b.length,c=0;c<d&&b[c][1].id!==a;)c++;if(c<d){a=b[c][1];a=(a.merged||
a.instanced)[A.MATERIAL].getRenderPriority();var e=b[c][0];if(a!==b[c][0])for(b[c][0]=a,e=a>e?-1:1,c+=e;-1<c&&c<d&&e*b[c][0]>e*a;){var f=b[c];b[c]=b[c-e];b[c-e]=f;c+=e}}};f.prototype._modifyMaterials=function(a){for(var b in a)this._materialRep.updateMaterialParameters(b)};f.prototype.modifyRenderOrder=function(a){if(this._orderedRendering){for(var b in a)this._updateRenderOrder(b,this._renderOrder);this._sortHighlightsByRenderOrder();this._needsRender=!0}};f.prototype._releaseMaterials=function(a){if(Array.isArray(a))for(var b=
0;b<a.length;b++)this._materialRep.release(a[b]),this._materialRep.releaseDepthShadowMap(a[b]),this._materialRep.releaseNormal(a[b]),this._materialRep.releaseDepth(a[b]),this._materialRep.releaseHighlight(a[b]);else this._materialRep.release(a),this._materialRep.releaseDepthShadowMap(a),this._materialRep.releaseNormal(a),this._materialRep.releaseDepth(a),this._materialRep.releaseHighlight(a)};f.prototype._getInstance=function(a,b){var d=a.material.getId(),d=(b?this._mat2dataInstanced:this._mat2dataMerged)[d];
if(!d)return null;var c=d.origin2data[a.origin.id];if(!c)return null;var e=c.instances[a.uniqueName];return e?{uniqueName:a.uniqueName,instance:e,matData:d,originData:c,type:b?"instanced":"merged",instancedVAO:null,instancedVAOBaseInstance:null}:null};f.prototype._createBaseInstanceVAO=function(a){var b=this._rctx,d=a.instance;if("instanced"===a.type&&a.originData.perGeometryDataInfo){var c=a.originData.perGeometryDataInfo[d.dataId],e=c.instanceBufferData;e&&(c=c.vao,d=e.getSlot(d.idx),a.instancedVAOBaseInstance!==
d&&(e=F.setBaseInstanceOffset(c.layout,d),a.instancedVAO=new O(b,c.locations,e,c.vertexBuffers,c.indexBuffer),a.instancedVAOBaseInstance=d))}};f.prototype._updateHighlightVAOs=function(){for(var a=0;a<this._highlights.length;++a)this._createBaseInstanceVAO(this._highlights[a])};f.prototype._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new X(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,
255,255,255])));return this._fallbackDepthStencilTexture};return f}();var na=function(){function f(){this.reset()}f.prototype.reset=function(){this.VBOusedSize=this.VBOoptimalSize=this.VBOallocatedSize=this.instancesDrawnAngle=this.drawCallsHighlight=this.drawCallsFragmented=this.drawCallsMerged=this.drawCallsAngleInstanced=this.drawCallsInstanced=this.trianglesRendered=0};return f}(),ba=function(){return function(f,a,b,d,c,e,l,g){this.name=f;this.from=a;this.to=b;this.displayedIndexRange=d;this.transformation=
c;this.instanceParameters=e;this.idx=l;this.dataId=g;null!=c&&(this.transformationNormal=C.create(),C.set(c,this.transformationNormal),C.inverse(this.transformationNormal,this.transformationNormal),C.transpose(this.transformationNormal,this.transformationNormal))}}(),H=T.create(),I=C.identity(),J=C.create(),L=C.create();return G});