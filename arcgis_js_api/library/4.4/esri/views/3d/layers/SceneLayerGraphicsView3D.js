// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/Logger ./graphics/Graphics3DLayerViewCore ./support/LayerViewUpdatingPercentage ../../layers/LayerView ../../../Graphic ../../../geometry/Point ../../../geometry/Polygon ../../../geometry/Polyline ../../../renderers/support/renderingInfoUtils ../../../core/Collection ../../../core/HandleRegistry ../../../core/promiseUtils ../lib/glMatrix ./i3s/I3SUtil ./i3s/I3SBinaryReader ./i3s/I3SQueryEngine ./i3s/FeatureChangeNotifier ../support/aaBoundingBox ../support/PreallocArray ../support/projectionUtils".split(" "),
function(g,ha,P,r,l,Q,R,S,T,K,U,V,W,X,Y,Z,A,aa,w,ba,ca,da,t,E,ea){function fa(e,b){e.xmin-=b;e.ymin-=b;e.xmax+=b;e.ymax+=b;e.hasZ&&(e.zmin-=b,e.zmax+=b);e.hasM&&(e.mmin-=b,e.mmax+=b);return e}var L=Q.getLogger("esri.layers.SceneService");g=function(e){function b(a){a=e.call(this)||this;a._queryEngine=null;a._isUpdating=!1;a._definitionExpressionErrors=0;a._maxDefinitionExpressionErrors=20;a._nodesAddedToStage={};a.loadedGraphics=new Y;a.supportsDraping=!0;a._overlayUpdating=null;a._controllerCreated=
!1;a._handles=new Z;return a}P(b,e);b.prototype.initialize=function(){var a=this;w.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode);this._handles.add([this.layer.watch("renderer",function(c,d){return a._rendererChange(c,d)}),this.layer.watch("objectIdFilter",function(){return a._objectIdFilterChange()}),this.layer.watch("_controller.parsedDefinitionExpression",function(){return a._definitionExpressionChange()})]);this._layerViewCore=new R({owner:this,layer:this.layer,
spatialIndexRequired:!1,labelingEnabled:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,verticalScaleEnabled:!0,highlightsEnabled:!0,updateSuspendResumeExtent:function(){return a._updateSuspendResumeExtent()},updateClippingExtent:function(c){return a._updateClippingExtent(c)},getGraphicsInExtent:function(c,d,q){return a._getGraphicsInExtent(c,d,q)}});this.addResolvingPromise(this._layerViewCore.initialize());this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);this._createController()};
b.prototype.destroy=function(){this._layerViewCore&&(this._layerViewCore.destroy(),this._layerViewCore=null);this._controller&&(this._controller.destroy(),this._controller=null);this._nodesAddedToStage=this._intersectingGraphicIds=this._elevationUpdateNodes=null;this._nodeDebugVisualizer&&(this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=null);this._handles&&(this._handles.destroy(),this._handles=null)};Object.defineProperty(b.prototype,"hasDraped",{get:function(){return this._layerViewCore.graphicsCore.hasDraped},
enumerable:!0,configurable:!0});b.prototype.whenGraphicAttributes=function(a,c){var d=this;return w.whenGraphicAttributes(this.layer,[a],this._getObjectIdField(),c,function(){var c=d._findGraphicNodeAndIndex(a);return{node:c.node,indices:[c.index]}}).then(function(a){return a[0]})};b.prototype.getGraphicsFromStageObject=function(a,c){if(!this.loadedGraphics)return A.reject();var d=a.getMetadata().graphicId;a=this.loadedGraphics.find(function(a){return a.uid===d});c=this._getObjectIdField();return a&&
a.attributes&&a.attributes[c]?A.resolve(a):A.reject()};b.prototype.whenGraphicBounds=function(a){return this._layerViewCore.graphicsCore.whenGraphicBounds(a)};b.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};b.prototype.isUpdating=function(){return this._isUpdating?!0:!(!this._controller||!this._controller.updating)};b.prototype.getRenderingInfo=function(a){if((a=X.getRenderingInfo(a,{renderer:this.layer.renderer}))&&a.color){var c=
a.color;c[0]/=255;c[1]/=255;c[2]/=255}return a};b.prototype.getSymbolUpdateType=function(){return this._layerViewCore.graphicsCore.getSymbolUpdateType()};b.prototype._findGraphicNodeAndIndex=function(a){a=a.attributes[this.layer.objectIdField];for(var c=0,d=Object.keys(this._nodesAddedToStage);c<d.length;c++)for(var q=d[c],b=this._nodesAddedToStage[q].bundles,f=0;f<b.length;f++){var k=this._findGraphicIndex(b[f],a);if(0<=k)return{node:this._controller.nodeIndex[q],nodeId:q,bundleNr:f,index:k}}return null};
b.prototype._forAllFeatures=function(a,c){for(var d=0,q=Object.keys(this._nodesAddedToStage);d<q.length;d++)for(var b=q[d],f=this._nodesAddedToStage[b].bundles,k=0;k<f.length;k++){for(var e=f[k],F=0;F<e.length;F++)for(var G=e[F].graphics,g=0;g<G.length;g++){var l=G[g],t=e[F].features[g].id;l.visible&&a(t,F,l)}null!=c&&c({nodeId:b,bundleNr:k})}};b.prototype._getGraphicIndices=function(a,c,d){a=this._nodesAddedToStage[a].bundles[c];c=this._getObjectIdField();for(var q=[],b=0;b<d.length;b++){var f=this._findGraphicIndex(a,
d[b].attributes[c]);0<=f&&q.push(f)}return q};b.prototype._findGraphicIndex=function(a,c){for(var d=0;d<a.length;d++)for(var b=0,h=a[d].features;b<h.length;b++)if(h[b].id===c)return d;return-1};b.prototype._getGraphicsInExtent=function(a,c,d){t[2]=-Infinity;t[3]=Infinity;var b=t.fromRect(ga,a);null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new E(10));a=this._elevationUpdateNodes;a.clear();this._controller&&this._controller.updateElevationChanged(b,c,a);c=a.length;this._intersectingGraphicIds||
(this._intersectingGraphicIds=new E(10));b=this._intersectingGraphicIds;b.clear();for(var h=0;h<c;h++){var f=this._nodesAddedToStage[a.data[h].id];if(null!=f)for(var f=f.bundles,k=0;k<f.length;k++)for(var e=f[k],g=0;g<e.length;g++)for(var G=e[g].graphics,l=0;l<G.length;l++)b.push(G[l].uid)}d(this._intersectingGraphicIds.data,this._intersectingGraphicIds.length)};b.prototype._evaluateUpdatingState=function(){var a;a=0+this._layerViewCore.elevationAlignment.numNodesUpdating();a+=this._layerViewCore.graphicsCore.numNodesUpdating();
var c;c=(c=(c=!this._controllerCreated)||this._overlayUpdating)||this._layerViewCore.graphicsCore.needsIdleUpdate();a=0<a||c;this._isUpdating!==a&&(this._isUpdating=a,this.notifyChange("updating"))};b.prototype._notifySuspendedChange=function(){};b.prototype._notifyDrapedDataChange=function(){this.notifyChange("hasDraped");this.emit("draped-data-change")};b.prototype.highlight=function(a,c){return this._layerViewCore.highlight(a,c,this.layer.objectIdField)};b.prototype._createController=function(){var a=
this,c={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:function(d,c){return a._isBundleAlreadyAddedToStage(d,c)},isOverMemory:function(){return a._isOverMemory()},removeNodeData:function(d){return a._removeNodeData(d)},removeFeatures:function(d,c){return a._removeFeatures(d,c)},getAddedFeatures:function(d){return a._getAddedFeatures(d)},getAddedNodeIDs:function(){return a._getAddedNodeIDs()},areAllBundlesLoaded:function(d){return a._areAllBundlesLoaded(d)},wholeNodeSwitchEnabled:!0};
this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:c,layerViewOptionalFunctions:{traversalOptions:{initDepthFirst:!1,neighborhood:!1,perLevelTraversal:!0,allowPartialOverlaps:!1,errorMetricPreference:["distanceRangeFromDefaultCamera","screenSpaceRelative"],elevationInfo:this.layer.elevationInfo},getAllAddedFeatures:function(){return a._getAllAddedFeatures()},_nodeDebugVisualizer:this._nodeDebugVisualizer,getLoadedAttributes:function(d){return a._getLoadedAttributes(d)},
setAttributeData:function(d,c,b){return a._setAttributeData(d,c,b)}}}).then(function(d){a._controller=d;a._featureChangeNotifier=new da.FeatureChangeNotifier(a,d);d.watch("rootNodeVisible",function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=!0;a.notifyChange("updating")})};b.prototype._getAllAddedFeatures=function(){var a={};this.loadedGraphics.forEach(function(c){a[c._nodeId]=c._features});return a};b.prototype._addBundle=function(a,c,d,b,h,f,k){f=this._controller.crsIndex;
var q=[],e=this._getObjectIdField();null==this._nodesAddedToStage[a.id]&&(this._nodesAddedToStage[a.id]={bundles:[],attributeData:d?d.attributeData:null,loadedAttributes:d?d.loadedAttributes:null});this._nodesAddedToStage[a.id].bundles[k]=q;if(null==c)null!=h&&h.done();else{var g;if(this.layer.objectIdFilter){var l=this.layer.objectIdFilter.ids,t="include"===this.layer.objectIdFilter.method;g=function(a){return 0<=l.indexOf(a)===t}}d=this.layer.fullExtent&&fa(this.layer.fullExtent.clone(),.5);for(var r=
[],w=0;w<c.length;w++)for(var D=c[w],A=D.featureDataPositions[0],H=0;H<D.geometries.length;H++){var B=[],n=D.features[H<D.features.length?H:0],x=n?{}:null;if(n&&null!=n.id){if(g&&!g(n.id))continue;x[e]=n.id}var u=D.geometries[H],v=u.params.type,p=n=void 0;if("ArrayBufferView"===u.type){p=u.params.vertexAttributes.position;if(null==p)continue;n=new ba.valueType2TypedArrayClassMap[p.valueType](b[a.geometryData[k].hrefConcat],p.byteOffset,p.count*p.valuesPerElement);p=p.valuesPerElement}else"Embedded"===
u.type&&(n=u.params.vertexAttributes.position,p=3);var y=void 0;if("lines"===v){for(var u=[],m=0;m<n.length;m+=p)u.push([n[m]+a.mbs[0],n[m+1]+a.mbs[1]]);v=new W(f);v.addPath(u);y=v;B.push(new K(y,null,x))}else if("points"===v)for(m=0;m<n.length;m+=p)y=new U({x:n[m]+A[0],y:n[m+1]+A[1],z:2<p?n[m+2]+A[2]:void 0,spatialReference:f}),d&&!d.contains(y)&&L.error("Service Error: Point coordinates outside of layer extent"),B.push(new K(y,null,x));else if("polygon"===v){y=v=new V(f);v._outlineSegments=[];for(var M=
0;M<u.params.rings.length;M++){for(var C=u.params.rings[M],I=C.start,E=[],N=[],z=[-1,-1],J=0;J<C.segments.length;J+=2){var m=C.segments[J+0],O=C.segments[J+1];0===m||1===m?(-1===z[0]&&(z[0]=I-C.start),z[1]=I+O-C.start):-1!==z[0]&&(N.push(z),z=[-1,-1]);for(m=I*p;m<(I+O)*p;m+=p)E.push([n[m]+a.mbs[0],n[m+1]+a.mbs[1]]);I+=O}-1!==z[0]&&N.push(z);y._outlineSegments.push(N);v.addRing(E);null!=C.inner&&console.warn("inner rings not yet supported")}B.push(new K(y,null,x))}for(x=0;x<B.length;x++)B[x].layer=
this.layer;r.push.apply(r,B);q.push({features:D.features,graphics:B})}this.loadedGraphics.addMany(r);this._featureChangeNotifier.notify(r.length,0);a=this._nodesAddedToStage[a.id];this._setBundleAttributes(a.bundles[k],a.loadedAttributes,a.attributeData);this._filterNode(a);h.done()}};b.prototype._areAllBundlesLoaded=function(a){var c=this._nodesAddedToStage[a.id];if(null==c)return!1;for(var d=0;d<a.featureData.length;d++)if(null==c.bundles[d])return!1;return!0};b.prototype._isBundleAlreadyAddedToStage=
function(a,c){return this._nodesAddedToStage[a.id]&&null!=this._nodesAddedToStage[a.id].bundles[c]};b.prototype._isOverMemory=function(){return!1};b.prototype._removeFeatures=function(a,c){var d=this._nodesAddedToStage[a.id];if(null!=d){var d=d.bundles,b=[],h;for(h in d)for(var f=0;f<d[h].length;f++){var k=d[h][f],e=!1;if(null!=k){for(var g in k.features)if(-1!==c.indexOf(k.features[g].id)){e=!0;break}e&&(b.push.apply(b,k.graphics),delete d[h][f])}}this.loadedGraphics.removeMany(b);this._featureChangeNotifier.notify(0,
b.length);for(h=0;h<d.length;h++)for(f=0;f<d[h].length;f++)if(k=d[h][f],null!=k&&0<k.graphics.length)return;this._removeNodeData(a)}};b.prototype._removeNodeData=function(a){var c=this._nodesAddedToStage[a.id];if(null!=c){var c=c.bundles,d=[],b;for(b in c)for(var h in c[b])d.push.apply(d,c[b][h].graphics);this.loadedGraphics.removeMany(d);this._featureChangeNotifier.notify(0,d.length);delete this._nodesAddedToStage[a.id]}};b.prototype._getAddedFeatures=function(a){a=this._nodesAddedToStage[a];if(null==
a)return null;a=a.bundles;var c=[],d;for(d in a)for(var b=0;b<a[d].length;b++)c=c.concat(a[d][b].features);return c};b.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)};b.prototype._getLoadedAttributes=function(a){if(a=this._nodesAddedToStage[a.id])return a.loadedAttributes};b.prototype._setAttributeData=function(a,c,d){if(a=this._nodesAddedToStage[a.id])a.loadedAttributes=c,a.attributeData=d,this._setNodeAttributes(a,c,d),this._filterNode(a),this._layerViewCore.labeling.layerLabelsEnabled()&&
this._layerViewCore.labeling.updateLabelingInfo()};b.prototype._setNodeAttributes=function(a,c,d){a=a.bundles;for(var b in a)this._setBundleAttributes(a[b],c,d)};b.prototype._setBundleAttributes=function(a,c,d){for(var b=0;b<a.length;b++)for(var h=0,f=a[b].graphics;h<f.length;h++){var k=f[h];k.attributes||(k.attributes={});if(c)for(var e=0,g=c;e<g.length;e++){var l=g[e].name;d[l]&&(k.attributes[l]=w.getCachedAttributeValue(d[l],b))}}};b.prototype._updateSuspendResumeExtent=function(){this.layer.fullExtent?
(this._suspendResumeExtent||(this._suspendResumeExtent=aa.vec4d.create()),ea.extentToBoundingRect(this.layer.fullExtent,this._suspendResumeExtent,this.view.spatialReference)||(this._suspendResumeExtent=null)):this._suspendResumeExtent=null;return this._suspendResumeExtent};b.prototype._updateClippingExtent=function(a){this._controller&&this._controller.updateClippingArea(a);return!1};b.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._rendererChange=
function(a,b){var d=this,c=a?a.requiredFields:[],h=b?b.requiredFields:[];c.length===h.length&&c.every(function(a,b){return c[b]===h[b]})||Object.keys(this._nodesAddedToStage).forEach(function(a){d._removeNodeData({id:a})})};b.prototype._objectIdFilterChange=function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(b){a._removeNodeData({id:b})});this._controller&&this._controller.restartNodeLoading()};b.prototype._definitionExpressionChange=function(){this._definitionExpressionErrors=
0};b.prototype._evaluateClause=function(a,b){try{return!!a.calculateValue(b)}catch(d){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&L.error("Error while evaluating definitionExpression: "+d),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&L.error("Further errors are ignored"),!1}};b.prototype._filterNode=function(a){var b=this._controller.parsedDefinitionExpression,d;for(d in a.bundles)for(var e=0,h=a.bundles[d];e<
h.length;e++)for(var f=0,k=h[e].graphics;f<k.length;f++){var g=k[f];g.visible=null!=b?this._evaluateClause(b,g):!0}};b.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};b.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};b.prototype.queryFeatures=function(a){var b=this;return this._ensureQueryEngine().queryFeatures(a).then(function(a){for(var d=0,c=a.features;d<c.length;d++)c[d].layer=b.layer;return a})};b.prototype.queryObjectIds=
function(a){return this._ensureQueryEngine().queryObjectIds(a)};b.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};b.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,graphic:null};return new ca({forAll:function(d,c){a._forAllFeatures(function(a,c,e){b.id=a;b.index=c;b.graphic=e;d(b)},c)},createGraphic:function(a){return a.graphic.clone()},requestFields:function(b,c,e){return w.whenGraphicAttributes(a.layer,
c,a._getObjectIdField(),e,function(){var d=a._getGraphicIndices(b.nodeId,b.bundleNr,c);return{node:a._controller.nodeIndex[b.nodeId],indices:d}})},createExtentBuilder:function(){var b=t.create(t.NEGATIVE_INFINITY),c=a.layer.spatialReference;return{add:function(a){return t.expand(b,a.graphic.geometry)},getExtent:function(){return t.toExtent(b,c)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};b.prototype.getStats=function(){var a=this.inherited(arguments)||{};a.nodecount=Object.keys(this._nodesAddedToStage).length;
a.featurecount=this.loadedGraphics.length;return a};return b}(l.declared(T,S));r([l.property()],g.prototype,"loadedGraphics",void 0);r([l.property()],g.prototype,"layer",void 0);r([l.property()],g.prototype,"view",void 0);r([l.property()],g.prototype,"hasDraped",null);r([l.property()],g.prototype,"_controller",void 0);r([l.property({dependsOn:["_controller.updating"]})],g.prototype,"updating",void 0);r([l.property({aliasOf:"_controller.updatingPercentage"})],g.prototype,"updatingPercentageValue",
void 0);g=r([l.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],g);var ga=t.create(t.POSITIVE_INFINITY);return g});