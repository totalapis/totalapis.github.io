// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define(["require","exports","./GoogPriorityQueue","../../support/PromiseLightweight","../../../../core/urlUtils"],function(u,v,n,p,l){return function(){function c(b,a,d,h,e,f,c,k,q,r,t,m){void 0===m&&(m={initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1});var g=this;this.baseURL=b;this.startNodeUrl=a;this.rootId=d;this.poi=h;this.nodeIndex=e;this.streamDataSupplier=f;this.viewportQueries=c;this.processNodeIndexDocument=k;this.finishedLevelCallback=q;this.debugVis=r;this.logger=t;this.traversalOptions=
m;this.queues=[];this.knownNodes=new Set;this.dataLoadingPerLevel=[];this.numIndicesLoading=this.currentLevel=0;this.cancelled=this.queueTraversalEnabled=!1;this.initQueryErrback=function(){g.initPromise.done()};this.initQueryCallback=function(a,b){if(g.cancelled)g.initPromise.done();else if(g.nodeTraversalState(b.id),g.enqueueConnected(a,b,0),g.isLeafNode(b))g.initPromise.done();else{for(var d=1E9,e=void 0,f=0;f<b.children.length;++f){var c=b.children[f];if(g.nodeIsVisible(c)&&(!g.viewportQueries.hasLOD(b)||
!g.viewportQueries.isTooHighLOD(b))){var h=g.viewportQueries.distToPOI(c,g.poi);h<d&&(d=h,e=c)}}e?(a=l.makeAbsolute(e.href,a),g.getNode(a,e.id,g.initQueryCallback,g.initQueryErrback)):g.initPromise.done()}}}c.prototype.start=function(){var b=this;this._nodeTraversalState={};this._nodeIsVisibleCached={};this.dataLoadingPerLevel=[];this.currentLevel=0;this.rootUrl=l.makeAbsolute(this.startNodeUrl,this.baseURL);this.traversalOptions.initDepthFirst?(this.initPromise=new p.Promise,this.getNode(this.rootUrl,
this.rootId,this.initQueryCallback,this.initQueryErrback),this.initPromise.then(function(){b.cancelled||(b.queueTraversalEnabled=!0)})):(this.enqueue(0,{id:this.rootId,hrefConcat:this.rootUrl},0),this.queueTraversalEnabled=!0)};c.prototype.continueTraversal=function(b){var a=this;if(this.queueTraversalEnabled){b=null==b?5:b;for(var d=0;d<this.queues.length;d++)if(!this.traversalOptions.perLevelTraversal||this.currentLevel===d){for(var c=this.queues[d];0<b--&&!c.isEmpty();)(function(b){var d=a.queues[b].dequeue();
a.dataLoadingPerLevel[b]++;var e=function(){a.dataLoadingPerLevel[b]--};a.getNode(d.hrefConcat,d.id,function(d,c){null==c.parentNode?(a.nodeTraversalState(c.id),a.enqueueConnected(d,c,b),a.processNodeIndexDocument(c,void 0).then(e,e)):a.getNode(a.concatHref(c.parentNode,d),c.parentNode.id,function(f,h){a.nodeTraversalState(c.id);a.enqueueConnected(d,c,b);a.processNodeIndexDocument(c,h).then(e,e)})},e)})(d);this.traversalOptions.perLevelTraversal&&c.isEmpty()&&0===this.dataLoadingPerLevel[d]&&(this.finishedLevelCallback.call(null,
this.currentLevel),this.currentLevel++)}}};c.prototype.isQueueTraversalEnabled=function(){return this.queueTraversalEnabled};c.prototype.getQueueSize=function(){for(var b=0,a=0;a<this.queues.length;a++)b+=this.queues[a].getCount();return b};c.prototype.cancel=function(){this.queueTraversalEnabled=!1;for(var b=0;b<this.queues.length;b++)this.queues[b].clear();this.cancelled=!0};c.prototype.isLoading=function(){return 0<this.numIndicesLoading||0<this.getQueueSize()};c.prototype.nodeIsVisible=function(b){if(null!=
this._nodeIsVisibleCached[b.id])return this._nodeIsVisibleCached[b.id];this._nodeIsVisibleCached[b.id]=this.viewportQueries.isNodeVisible(b);return this._nodeIsVisibleCached[b.id]};c.prototype.nodeTraversalState=function(b){if(null!=this._nodeTraversalState[b])return this._nodeTraversalState[b];var a=this.nodeIndex[b];if(null==a)return null;var d=null,c=!1;if(null!=a.parentNode){d=this.nodeIndex[a.parentNode.id];if(null==d)return null;var e=this._nodeTraversalState[d.id];null!=e&&(c=e.nodeIsTooHighLOD)}var e=
this.viewportQueries.hasLOD(a),f=this.viewportQueries.isTooHighLOD(a),d=this.viewportQueries.isChosenLOD(a,d,f,c);this._nodeTraversalState[a.id]={visited:!0,nodeHasLOD:e,nodeIsTooHighLOD:f,isChosenLOD:d};return this._nodeTraversalState[b]};c.prototype.getNode=function(b,a,c,h){var d=this;this.numIndicesLoading++;this.nodeIndex[a]?(c(b,this.nodeIndex[a]),this.numIndicesLoading--):this.streamDataSupplier.request(b,"json").then(function(a,b){d.nodeIndex[b.id]=b;b.baseUrl=a;c(a,b);d.numIndicesLoading--},
function(a){null!=h&&h(a);d.loadErrorCallback(b);d.numIndicesLoading--})};c.prototype.isLeafNode=function(b){return null==b.children};c.prototype.concatHref=function(b,a){return l.makeAbsolute(b.href,a)};c.prototype.enqueue=function(b,a,c){this.traversalOptions.perLevelTraversal||(c=0);for(this.knownNodes.add(a.id);this.queues.length<=c;)this.queues.push(new n.goog.structs.PriorityQueue),this.dataLoadingPerLevel.push(0);this.queues[c].enqueue(b,a)};c.prototype.enqueueConnected=function(b,a,c){if(!this.cancelled&&
null!=a){var d=this.nodeTraversalState(a.id);if(a.id===this.rootId||null==a.parentNode||this.knownNodes.has(a.parentNode.id))a.id===this.rootId&&!this.knownNodes.has(a.id)&&this.nodeIsVisible(a)&&this.enqueue(this.viewportQueries.distToPOI(a,this.poi),{id:a.id,hrefConcat:b},c);else{var e={id:a.parentNode.id,hrefConcat:this.concatHref(a.parentNode,b)};this.enqueue(this.viewportQueries.distToPOI(a.parentNode,this.poi),e,c-1)}if(a.children)for(var f=0,l=a.children;f<l.length;f++){var k=l[f],e=this.nodeIsVisible(k);
this.knownNodes.has(k.id)||d.nodeHasLOD&&d.nodeIsTooHighLOD||!e||(e={id:k.id,hrefConcat:this.concatHref(k,b)},this.enqueue(this.viewportQueries.distToPOI(k,this.poi),e,c+1))}if(this.traversalOptions.neighborhood&&a.neighbors)for(d=0,a=a.neighbors;d<a.length;d++)f=a[d],e=this.nodeIsVisible(f),!this.knownNodes.has(f.id)&&e&&(e={id:f.id,hrefConcat:this.concatHref(f,b)},this.enqueue(this.viewportQueries.distToPOI(f,this.poi),e,c))}};c.prototype.loadErrorCallback=function(b){this.logger.warn("Error loading node: "+
b)};return c}()});