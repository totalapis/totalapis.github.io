// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports dojo/_base/lang ../../webgl-engine/lib/Util ./I3SUtil ./I3SBinaryReader ../../support/PromiseLightweight ../../support/projectionUtils ../../lib/glMatrix ../../support/PromiseNativeOrShim ../../../../core/urlUtils".split(" "),function(K,L,D,E,B,C,F,G,H,m,z){var A=E.assert,I=H.vec4d,J={};return function(){function g(a,c,b,d,f,e,v,h,k,q,u,p,l,r,w){this.bundleLoadedCallback=c;this.queueFunctionCall=b;this.debugVis=d;this.renderCoordsHelper=f;this.indexSR=e;this.calcDesiredTextureLOD=
v;this.imageIsPartOfTextureBundle=h;this.matId2Meta=k;this.texId2Meta=q;this.useCompressedTextures=u;this.logger=p;this.defaultGeometrySchema=l;this.requiredAttributes=r;this.bypassFeatureData=w;this.texIdToPromises={};this._numLoadAttributes=0;this.loadShared=function(a){if(null==a.sharedResource)return m.resolve({});var e=z.makeAbsolute(a.sharedResource.href,a.baseUrl)+"/";a.sharedResource.hrefConcat=e;return this.loadJSON(e).then(function(a){g.fixTextureEncodings(a);g.addAbsoluteHrefTexture(a,
e);return a})};this.loader=a;this.cancelled=!1}Object.defineProperty(g.prototype,"isLoadingAttributes",{get:function(){return 0<this._numLoadAttributes},enumerable:!0,configurable:!0});g.prototype.waitForAnimationFrame=function(){var a=this;return new m(function(c,b){a.queueFunctionCall(c,null,[],b)})};g.prototype.cancel=function(){this.cancelled=!0};g.prototype.loadJSON=function(a){var c=this.loader.request(a,"json");return new m(function(b,d){c.then(function(a,e){b(e)},function(b){d(Error("Failed to load: "+
a))})})};g.prototype.loadBinary=function(a){var c=this.loader.request(a,"binary");return new m(function(b,d){c.then(function(a,e){b(e)},function(b){d(Error("Failed to load: "+a))})})};g.prototype.loadImage=function(a){var c=this.loader.request(a,"image");return new m(function(b,d){c.then(function(a,e){b(e)},function(b){d(Error("Failed to load: "+a))})})};g.prototype.loadAttribute=function(a,c,b){a=B.addTrailingSlash(z.makeAbsolute(b,a));return this.loadBinary(a).then(function(a){return C.readBinaryAttribute(c,
a)})};g.prototype.loadAttributes=function(a,c,b){var d=this,f=b.map(function(e){return null==a.attributeData||null==a.attributeData[e.index]?(d.logger.error("Missing attributeData for '"+e.name+"' on node '"+a.id+"'"),m.resolve(null)):d.loadAttribute(c,e.attributeStorageInfo,a.attributeData[e.index].href).catch(function(b){d.logger.error("Failed to load attributeData for '"+e.name+"' on node '"+a.id+"'");return null})});this._numLoadAttributes++;return m.all(f).then(function(a){d._numLoadAttributes--;
for(var e={},c=0;c<b.length;++c)a[c]&&(e[b[c].name]=a[c]);return e}).catch(function(a){d._numLoadAttributes--;throw a;})};g.prototype.prepareBinaryGeometryData=function(a,c,b,d){D.mixin(a.geometries[0].params,b);a.faceRanges[0][0]=0;a.faceRanges[0][1]=b.header.fields.vertexCount/3-1;d||null!=b.vertexAttributes.region||delete b.vertexAttributes.region;if(null!=b.featureAttributes){d=b.featureAttributes;if(d.faceRange){a.faceRanges=[];for(var f=C.createTypedView(c,d.faceRange),e=d.faceRange.valuesPerElement,
g=b.header.fields.featureCount,h=0;h<g;h++)a.faceRanges[h]=[f[h*e],f[h*e+1]];a.componentOffsets=B.convertFlatRangesToOffsets(f,g,e)}if(d.id)for(a.featureIds=[],f=1,h=C.valueType2TypedArrayClassMap[d.id.valueType],"UInt64"===d.id.valueType&&(h=Uint32Array,f=2),c=new h(c,d.id.byteOffset,d.id.count*d.id.valuesPerElement*f),h=0;h<b.header.fields.featureCount;h++)if(a.featureIds[h]=c[h*d.id.valuesPerElement*f],2===f){e=c[h*d.id.valuesPerElement*f+1];if(2097150<=e)throw Error("ID exceeded maximum range supported by javascript (max \x3d 53bit-1 \x3d 9007199254740991)");
a.featureIds[h]+=4294967296*e}}};g.prototype.loadNodeData=function(a,c,b,d,f){var e=this,v=null==a.features,h=a.baseUrl,k={},q=this.loadShared(a),u=q.then(function(a){return e.loadReferencedShared(a,h)}),p=null;null!=this.requiredAttributes&&(p=this.loadAttributes(a,h,this.requiredAttributes));var l=null;null!=a.geometryData&&(l=a.geometryData.map(function(a,b){if(-1===c.indexOf(b))return null;b=z.makeAbsolute(a.href,h);a.hrefConcat=b;return e.loadBinary(b)}));m.all([q,u]).then(function(b){var h=
b[0];b=b[1];e.handleCancelled();a.sharedResource&&(k[a.sharedResource.hrefConcat]=h,D.mixin(k,b));b=c.map(function(b){return e.loadFeatureData(a,b,h).then(function(c){e.handleCancelled();v&&g.buildNodeFeatures(a,b,c);var f=e.collectGeometries(a,b,c,h);c=null;c=null!=l&&null!=l[b]?l[b].then(function(c){k[a.geometryData[b].hrefConcat]=c;var d=Object.keys(h.materialDefinitions)[0],d=h.materialDefinitions[d].params.vertexRegions,g=C.createGeometryDataIndex(c,e.defaultGeometrySchema,d);e.prepareBinaryGeometryData(f[0],
c,g,d);return f}):m.resolve(f);var n=d?e.loadTextures(f,h,e.matId2Meta,e.texId2Meta).then(function(a){var b={};a.forEach(function(a){var c=a.i3sTexId;b[c]={i3sTexId:c,data:a.data,encoding:a.encoding,desiredLOD:a.desiredLOD,createdTextureForDomImage:function(){e.texIdToPromises[c]&&delete e.texIdToPromises[c]}}});return b}):null;return m.all([n,c,p])}).then(function(c){var d=c[0],h=c[1];c=c[2];e.handleCancelled();void 0!==e.debugVis&&e.debugVis.show(a,e.indexSR,"green");var g=null;c&&(g={attributeData:c,
loadedAttributes:e.requiredAttributes});return e.callbackWrapped(a,h,g,k,d,b,f)}).catch(function(c){e.handleCancelled();e.logger.error("Failed to load node '"+a.id+"' bundle "+b+": "+c);return e.callbackWrapped(a,null,null,k,null,b,f)})});return m.all(b)}).catch(function(b){if(!e.cancelled)return e.logger.error("Failed to shared data of node '"+a.id+"': "+b),b=c.map(function(b){return e.callbackWrapped(a,null,null,k,null,b,f)}),m.all(b)}).then(function(){b.done()})};g.prototype.callbackWrapped=function(a,
c,b,d,f,e,g){var h=this;return this.waitForAnimationFrame().then(function(){return new m(function(k,q){var v=new F.Promise,p=h.bundleLoadedCallback;p(a,c,b,d,v,f,e,g);v.then(k,q)})})};g.addAbsoluteHrefTexture=function(a,c){a=a.textureDefinitions;if(void 0!==a)for(var b in a)if(a.hasOwnProperty(b))for(var d=a[b],f=0;f<d.images.length;f++){var e=d.images[f];Array.isArray(d.encoding)?e.hrefConcat=e.href.map(function(a){return z.makeAbsolute(a,c)}):e.hrefConcat=z.makeAbsolute(e.href,c)}};g.fixTextureEncodings=
function(a){a=a.textureDefinitions;if(null!=a)for(var c in a){var b=a[c];if(Array.isArray(b.encoding))for(var d=0;d<b.encoding.length;d++){var f=b.encoding[d];"data:"===f.substring(0,5)&&(b.encoding[d]=f.substring(5))}else f=b.encoding,"data:"===f.substring(0,5)&&(b.encoding=f.substring(5))}};g.prototype.loadReferencedShared=function(a,c){var b=this;if(null==a||null==a.materialDefinitions)return m.resolve({});var d=Object.keys(a.materialDefinitions).filter(function(b){return a.materialDefinitions[b]&&
null!=a.materialDefinitions[b].href}).map(function(b){return z.makeAbsolute(a.materialDefinitions[b].href,c)+"/"});return m.all(d.map(function(a){return b.loadJSON(a).then(function(b){return[a,b]})})).then(function(a){for(var b={},c=0;c<a.length;c++){var d=a[c],f=d[0],d=d[1];g.fixTextureEncodings(d);g.addAbsoluteHrefTexture(d,f);b[f]=d}return b})};g.prototype.loadTexture=function(a,c,b,d,f,e){var g=this,h=-1<e?b.encoding[e]:b.encoding;b=h===B.DDS_ENCODING_STRING;var k=this.imageIsPartOfTextureBundle(d);
A(!(b&&k),"DDS in multi texture bundles not supported at the moment");return b?this.loadBinary(a).then(function(a){return g.cancelled?m.reject():{i3sTexId:c,data:a,encoding:h,desiredLOD:f}}):k?this.loadBinary(a).then(function(b){var k;try{var p=void 0,l;-1<e?(A(Array.isArray(d.byteOffset)&&Array.isArray(d.length),"texture encoding is array, but image byteOffset/length isn't"),p=d.byteOffset[e],l=d.length[e]):(p=d.byteOffset,l=d.length);var q=new Uint8Array(b,p,l),v=new Blob([q],{type:h});k=window.URL.createObjectURL(v)}catch(n){k=
"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII\x3d",g.logger.error("error loading texture "+a+": "+n)}var t=new Image;b=new m(function(a,b){var d=function(){window.URL.revokeObjectURL(k);t.onerror=void 0;t.onload=void 0};t.onerror=function(a){d();b(a)};t.onload=function(){d();g.cancelled?b():a({i3sTexId:c,data:t,encoding:h,desiredLOD:f})}});t.src=k;return b}):this.loadImage(a).then(function(a){return g.cancelled?
m.reject():{i3sTexId:c,data:a,encoding:h,desiredLOD:f}})};g.getAllEngineMBS=function(a){for(var c=[],b=0;b<a.length;b++)c.push(a[b].engineMBS);return c};g.prototype.loadTextures=function(a,c,b,d){for(var f=[],e=0;e<a.length;e++)for(var v=a[e].geometries,h=g.getAllEngineMBS(a[e].features),k=0;k<v.length;++k)for(var q=v[k],u=q.params.components.length,p=0;p<u;p++){var l=q.params.components[p],r=l.materialID,l=l.textureID||"none";if((!b[r]||null==b[r][l])&&null==d[l]&&"none"!==l)if(null!=this.texIdToPromises[l])f.push(this.texIdToPromises[l]);
else{null!=c.textureDefinitions&&null!=c.textureDefinitions[l]||this.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+l);r=c.textureDefinitions[l];A(void 0!==r,"geometry wants unknown texture "+l);var w=this.calcDesiredTextureLOD(h,r.images);if(0!==r.images.length){var t=r.images[w],n=B.getAppropriateTextureEncoding(r.encoding,this.useCompressedTextures()),r=this.loadTexture(-1<n?t.hrefConcat[n]:t.hrefConcat,l,r,t,w,n);f.push(r);this.texIdToPromises[l]=r}}}return m.all(f)};
g.getIdFromJsonPointer=function(a){a=a.split("/");return a[a.length-1]};g.buildNodeFeatures=function(a,c,b){null==a.features&&(a.features=[]);for(var d in b.featureData)a.features.push({id:b.featureData[d].id,mbs:a.mbs,block:c})};g.prototype.collectGeometries=function(a,c,b,d){var f=[],e=!1,m=0,h=a.features.length-1;null==a.featureData[c].featureRange?e=!0:(m=a.featureData[c].featureRange[0],h=a.featureData[c].featureRange[1]);for(;m<=h;++m){var k=a.features[m];if(!k.engineMBS){var q=I.create();G.mbsToMbs(k.mbs,
this.indexSR,q,this.renderCoordsHelper.spatialReference);q[3]=k.mbs[3];k.engineMBS=q}if(!e||k.block===c){for(var u=b.featureData,q=void 0,p=0;p<u.length;p++)if(u[p].id===k.id){q=u[p];break}A(null!=q,"I3S: unable to find feature data in specified block in node.id "+a.id+" feature.id "+k.id);var u=q.geometries,p=[],l=[];if(null!=u)for(var r=0;r<u.length;r++){var w=q.geometries[r];if("GeometryReference"===w.type){for(var t=g.getIdFromJsonPointer(w.params.$ref),n=void 0,x=0;x<b.geometryData.length;x++){var y=
b.geometryData[x];if(y.id+""===t){n=y;break}}A(null!=n,"I3S: Unable to find referenced geometry");null==n.params.material&&(this.logger.warn("material definition is missing in featureData, node: "+a.id),x=Object.keys(d.materialDefinitions)[0],n.params.material="/materialDefinitions/"+x);null==n.params.components&&(n.params.components=null!=n.params.texture?[{material:n.params.material,materialID:g.getIdFromJsonPointer(n.params.material),texture:n.params.texture,textureID:g.getIdFromJsonPointer(n.params.texture),
id:1}]:[{material:n.params.material,materialID:g.getIdFromJsonPointer(n.params.material),id:1}],null!=n.params.faces&&null!=n.params.faces.position&&(n.params.faces.position.componentIndices=[0]));y=void 0;y=null;for(x=0;x<f.length;x++)if(1===f[x].geometries.length&&f[x].geometries[0].id+""===t){y=f[x];break}null===y&&(y={features:[],featureDataPositions:[],faceRanges:[],geometries:[n]},f.push(y));y.features.push(k);y.featureDataPositions.push(q.position);y.faceRanges.push(w.params.faceRange)}else p.push(w),
null!=w.params.faceRange&&l.push(w.params.faceRange)}else null!=q.position&&p.push({id:k.id,type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}});0===l.length&&(l=null);0<p.length&&f.push({features:[k],featureDataPositions:[q.position],geometries:p,faceRanges:l})}}return f};g.prototype.idHash=function(a){var c=0,b=a.length;if(0===b)return c;for(var d=0;d<b;d++)var f=a.charCodeAt(d),c=(c<<5)-c+f,c=c|0;return c};g.prototype.loadFeatureData=function(a,c,b){if(this.bypassFeatureData&&
this.defaultGeometrySchema){a=this.idHash(a.id);var d=c=void 0;null!=b.materialDefinitions&&(c=Object.keys(b.materialDefinitions)[0]);null!=b.textureDefinitions&&(d=Object.keys(b.textureDefinitions)[0]);b=g.buildDefaultFeatureData(a,c,d,null);return m.resolve(b)}b=z.makeAbsolute(a.featureData[c].href,a.baseUrl);a.featureData[c].hrefConcat=b;return this.loadJSON(b)};g.buildDefaultFeatureData=function(a,c,b,d){return{featureData:[{id:a,position:[0,0,0],pivotOffset:[0,0,0],mbb:d,layer:"Default",geometries:[{id:1,
type:"GeometryReference",params:{$ref:"/geometryData/0",faceRange:[0,0]}}]}],geometryData:[{id:0,type:"ArrayBufferView",params:{type:"triangles",material:"/materialDefinitions/"+c,texture:null!=b?"/textureDefinitions/"+b:void 0}}]}};g.prototype.handleCancelled=function(){if(this.cancelled)throw J;};return g}()});