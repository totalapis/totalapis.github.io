// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/HandleRegistry ../../../core/watchUtils ../../../core/promiseUtils ../../../core/screenUtils ../../../request ../../layers/LayerView ../support/projectionUtils ../support/orientedBoundingBox ./support/LayerViewUpdatingPercentage ../lib/glMatrix ./i3s/I3SBinaryReader ./i3s/I3SUtil ./i3s/PointCloudRendererUtil ./i3s/PointRenderer ./i3s/PagedNodeIndex ./i3s/LoDUtil ./i3s/LEPCC dojo/Deferred dojo/promise/all dojo/errors/CancelError ../webgl-engine/lib/RenderSlot".split(" "),
function(d,M,A,h,e,B,k,r,t,u,C,v,D,E,p,w,x,m,F,G,q,H,I,y,J,K){function z(d){var c=[];d.forEach(function(a){return c.push(a)});return c}var L=p.vec4d.create();d=function(d){function c(){var a=null!==d&&d.apply(this,arguments)||this;a.maximumPointCount=4E6;a._renderer=null;a._rendererAdded=!1;a._renderedNodes=new Set;a._updateViewNeeded=!0;a._idleUpdatesEnabled=!0;a._lodFactor=1;a._handles=new B;a._indexQueue=[];a._workQueue=[];a._idleQueue=[];a._indexPagesLoading=new Map;a._loadingNodes=new Map;a._totalWork=
0;a._index=null;a._nodeIdArray=[];return a}A(c,d);Object.defineProperty(c.prototype,"pointScale",{get:function(){var a=m.getSplatSizeAlgorithm(this.layer.renderer);return a&&null!=a.scaleFactor?a.scaleFactor:1},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"pointMinSize",{get:function(){var a=m.getSplatSizeAlgorithm(this.layer.renderer);return a&&null!=a.minSize?a.minSize:4},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"useRealWorldSymbolSizes",{get:function(){var a=
m.getFixedSizeAlgorithm(this.layer.renderer);return a&&null!=a.useRealWorldSymbolSizes?a.useRealWorldSymbolSizes:!1},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"pointSize",{get:function(){var a=m.getFixedSizeAlgorithm(this.layer.renderer);return a&&null!=a.size?a.size:0},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"inverseDensity",{get:function(){return this.layer.renderer?96/this.layer.renderer.pointsPerInch:5},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"_clippingBox",{get:function(){var a=[];return v.extentToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?a:null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_elevationOffset",{get:function(){var a=this.layer.elevationInfo;return a&&"absolute-height"===a.mode?a.offset||0:0},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;x.checkPointCloudLayerValid(this.layer);x.checkPointCloudLayerCompatibleWithView(this.layer,this.view);this._initRenderer();
var b=this._initNodePages(),f={idleBegin:function(){return a._idleBegin()},idleEnd:function(){return a._idleEnd()},needsUpdate:function(){return!0},idleFrame:function(b){return a._idleFrame(b)}};b.then(function(){a._handles.add(k.init(a,"suspended",function(b){b?a.view.resourceController.deregisterIdleFrameWorker(a):a.view.resourceController.registerIdleFrameWorker(a,f)}))});this._handles.add(k.init(this,"_clippingBox",function(){return a._updateViewNeeded=!0}));this._handles.add(k.init(this,"_elevationOffset",
function(){return a._elevationOffsetChanged()}));this._handles.add(k.init(this.layer,"renderer",function(){return a._rendererChanged()}));this.addResolvingPromise(b)};c.prototype.destroy=function(){this.view.resourceController.deregisterIdleFrameWorker(this);this._handles.destroy();this._destroyRenderer()};c.prototype._initRenderer=function(){var a=this;this._renderer=new F;this._handles.add(k.init(this.layer,"id",function(b){a._renderer.layerId=b}));this._handles.add(k.init(this,"_clippingBox",function(b){a._renderer.clippingBox=
b}));this._handles.add(k.init(this,"_clippingBox",function(b){a._renderer.clippingBox=b}));this._handles.add(k.init(this,"suspended",function(b){a._setPointsVisible(!b)}));this._handles.add(k.init(this,"pointScale",function(b){a._renderer.scaleFactor=b}));this._handles.add(k.init(this,"pointMinSize",function(b){b=t.pt2px(b);a._renderer.minSizePx=b}));this._handles.add(k.init(this,"useRealWorldSymbolSizes",function(b){a._renderer.useRealWorldSymbolSizes=b}));this._handles.add(k.init(this,"pointSize",
function(b){var f=t.pt2px(b);a._renderer.size=b;a._renderer.sizePx=f}));this._handles.add(k.init(this,["inverseDensity","maximumPointCount"],function(){a._updateViewNeeded=!0}));this._handles.add(k.init(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",function(b){a._lodFactor=b;a._updateViewNeeded=!0}))};c.prototype._destroyRenderer=function(){this._setPointsVisible(!1)};c.prototype._setPointsVisible=function(a){a&&!this._rendererAdded?(this.view._stage.addExternalRenderer([K.OPAQUE_EXTERNAL],
this._renderer),this._rendererAdded=!0):!a&&this._rendererAdded&&(this.view._stage.removeExternalRenderer(this._renderer),this._rendererAdded=!1)};c.prototype._rendererChanged=function(){this._clearNodeState();this._renderer.useFixedSizes=m.rendererUsesFixedSizes(this.layer.renderer);this._updateViewNeeded=!0};c.prototype._elevationOffsetChanged=function(){var a=this;this._clearNodeState();this._initNodePages().then(function(){a._updateViewNeeded=!0})};c.prototype.displayNodes=function(a){this._cancelNodeLoading();
this._workQueue=q.nodeDiff(z(this._renderedNodes),a,this._index);q.sortFrontToBack(this._workQueue,this.view._stage.getCamera().viewForward,this._index);this._totalWork=this._computeWork();this._updateLoading()};c.prototype.cancelLoading=function(){this._cancelNodeLoading();this._cancelIndexLoading()};c.prototype._cancelNodeLoading=function(){var a=[];this._loadingNodes.forEach(function(b){return a.push(b)});this._loadingNodes.clear();for(var b=0;b<a.length;b++){var f=a[b];f.cancel()}this._workQueue=
[];for(var b=0,c=this._idleQueue;b<c.length;b++)f=c[b],f.cancel();this._idleQueue=[];this._totalWork=this._computeWork();this._updateLoading()};c.prototype._cancelIndexLoading=function(){this._indexQueue=[];this._indexPagesLoading.forEach(function(a){return a.cancel()});this._indexPagesLoading.clear();this._totalWork=this._computeWork();this._updateLoading()};c.prototype._clearNodeState=function(){var a=this;this._renderedNodes.forEach(function(b){return a._removeFromRenderer(b)});this._cancelNodeLoading()};
c.prototype._idleBegin=function(){this._idleUpdatesEnabled&&(this._updateViewNeeded=!1,this.updateViewWhenIdle())};c.prototype._idleEnd=function(){this.cancelLoading()};c.prototype._idleFrame=function(a){if(this._idleUpdatesEnabled){this._updateViewNeeded&&!a.done()&&(this._updateViewNeeded=!1,this.updateViewWhenIdle());for(;0<this._indexQueue.length&&!a.done();)this._processIndexQueue();for(;0<this._workQueue.length&&this._canSchedule(this._workQueue[0])&&!a.done();)this._processWorkQueue();for(;0<
this._idleQueue.length&&!a.done();)this._idleQueue.shift().resolve()}};c.prototype._schedule=function(){var a=new I;this._idleQueue.push(a);return a.promise};c.prototype._processIndexQueue=function(){var a=this,b=this._indexQueue.shift();this._indexPagesLoading.set(b,this._loadNodePage(b));this._indexPagesLoading.get(b).then(function(f){a._index.addPage(b,f,a._elevationOffset);a._updateViewNeeded=!0}).always(function(){a._indexPagesLoading.delete(b)})};c.prototype._canSchedule=function(a){if(8<=this._loadingNodes.size)return!1;
for(var b=0;b<a.remove.length;b++)if(!this._renderedNodes.has(a.remove[b]))return!1;return!0};c.prototype._processWorkQueue=function(){var a=this,b=this._workQueue.shift();if(0===b.load.length)for(var f=0;f<b.remove.length;f++)this._removeFromRenderer(b.remove[f]);else{if(8<b.load.length&&1===b.remove.length)for(var c=q.splitWorkEntry(b,this._index),b=c[0],f=1;f<c.length;f++)this._workQueue.push(c[f]);y(b.load.map(function(b){a._loadingNodes.has(b)||a._loadingNodes.set(b,a.loadNode(b));return a._loadingNodes.get(b)})).then(function(f){for(var c=
0;c<b.load.length;c++)a._addToRenderer(b.load[c],f[c]);for(c=0;c<b.remove.length;c++)a._removeFromRenderer(b.remove[c])}).always(function(){for(var c=0;c<b.load.length;c++)a._loadingNodes.delete(b.load[c]);a._updateLoading()});this._updateLoading()}};c.prototype._computeWork=function(){for(var a=0,b=0;b<this._workQueue.length;b++)a+=this._workQueue[b].load.length;a+=this._loadingNodes.size;a+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize;return a+=this._updateViewNeeded?
100:0};Object.defineProperty(c.prototype,"updating",{get:function(){return 0<this._computeWork()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"updatingPercentageValue",{get:function(){var a=this._computeWork();return 100*Math.max(0,this._totalWork-a)/this._totalWork},enumerable:!0,configurable:!0});c.prototype._updateLoading=function(){this.notifyChange("updating");this.notifyChange("updatingPercentageValue")};c.prototype._initNodePages=function(){var a=this;this._index=new G(this.layer.spatialReference,
this.view.renderCoordsHelper.spatialReference,this.layer.store.index.nodePerIndexBlock);this._cancelIndexLoading();this._traverseVisible=this._index.createVisibilityTraverse();return this._loadNodePage(0).then(function(b){a._index.addPage(0,b,a._elevationOffset)})};c.prototype._loadNodePage=function(a){return this._requestJSON(this.baseUrl+"/nodepages/"+a*this._index.pageSize).then(function(a){return a.data.nodes})};c.prototype.updateViewWhenIdle=function(){for(var a=this.inverseDensity/this._lodFactor,
b=this.maximumPointCount*this._lodFactor,c=this._computeNodesForMinimumDensity(a),g=this._computePointCount(c),l=Math.sqrt(g/(.75*b));g>b;)a*=l,c=this._computeNodesForMinimumDensity(a),g=this._computePointCount(c),l=Math.sqrt(2);this.displayNodes(c)};c.prototype._computePointCount=function(a){for(var b=0,c=0;c<a.length;c++){var g=this._index.getNode(a[c]);g&&(b+=g.pointCount)}return b};c.prototype._computeNodesForMinimumDensity=function(a){var b=this,c=this.view._stage.getCamera(),g=c.frustumPlanes,
l=this._clippingBox,n=c.viewForward,d=p.vec3d.dot(n,c.eye),e=p.vec4d.set4(n[0],n[1],n[2],-d,L),h=c.perPixelRatio,k=a*a,m=this._nodeIdArray;m.length=0;this._traverseVisible({frustumPlanes:g,clippingBox:l},{predicate:function(a,c,f){if(!f)return!1;if(0===c.childCount)return m.push(a),!1;f=b._index.getRenderObb(a);return b._computeAveragePixelArea(f,c.effectiveArea,c.pointCount,e,h)<=k?(m.push(a),!1):!0},pageMiss:function(a,c){m.push(a);0>b._indexQueue.indexOf(c)&&b._indexQueue.push(c)}});return m};
c.prototype._computeAveragePixelArea=function(a,b,c,g,l){a=Math.max(1E-7,D.minimumDistancePlane(a,g));return b/(a*a)/(4*l*l)/c};c.prototype.loadNode=function(a){var b=this,c=this._index.getNode(a),g=m.getRendererInfo(this.layer),l=[];return this._schedule().then(function(){var f=null!=c.resourceId?c.resourceId:a,d=b.loadGeometry(f),e=b.loadAttribute(f,g.primaryAttribute),f=b.loadAttribute(f,g.modulationAttribute);l=[d,e,f];return y(l)}).then(function(a){var f=a[1],d=a[2],l=b.readGeometry(b.layer.store.defaultGeometrySchema,
a[0]),n=m.evaluateRenderer(g,f,d,l,c.pointCount);return b._schedule().then(function(){return{positions:l,rgb:n}})}).then(function(c){var f=c.positions;c=c.rgb;var g=p.vec3.create(b._index.getRenderCenter(a));b._applyElevationOffsetInPlace(f,b._elevationOffset);f=b._transformCoordinates(f,g);return{origin:f.origin,points:f.points,rgb:c}}).otherwise(function(a){if(a instanceof J)for(var b=0,c=l;b<c.length;b++)c[b].cancel();return r.reject(a)})};c.prototype.readGeometry=function(a,b){if(null==a.encoding||
""===a.encoding){a=w.createGeometryDataIndex(b,a,!1);b=w.createTypedView(b,a.vertexAttributes.position);var c=a.header.fields;a=[c.offsetX,c.offsetY,c.offsetZ];for(var c=[c.scaleX,c.scaleY,c.scaleZ],g=b.length/3,d=new Float64Array(3*g),e=0;e<g;e++)d[3*e]=b[3*e]*c[0]+a[0],d[3*e+1]=b[3*e+1]*c[1]+a[1],d[3*e+2]=b[3*e+2]*c[2]+a[2];return d}if("lepcc-xyz"===a.encoding)return H.decodeXYZ(b).result};c.prototype.loadGeometry=function(a){return this._requestBinary(this.baseUrl+"/nodes/"+a+"/geometries/0").then(function(a){return a.data})};
c.prototype.loadAttribute=function(a,b){return b&&b.storageInfo?this._requestBinary(this.baseUrl+"/nodes/"+a+"/attributes/"+b.storageInfo.key).then(function(a){return a.data}):r.resolve(null)};c.prototype._requestJSON=function(a){return u(a,{query:{f:"json",token:this.layer.token},responseType:"json"})};c.prototype._requestBinary=function(a){return u(a,{query:{token:this.layer.token},responseType:"array-buffer"})};c.prototype._removeFromRenderer=function(a){this._renderedNodes.has(a)&&(this._renderer.removeNode(""+
a),this._renderedNodes.delete(a))};c.prototype._addToRenderer=function(a,b){if(!this._renderedNodes.has(a)){this._renderedNodes.add(a);var c=this._index.getNode(a),d=this._index.getRenderObb(a);this._renderer.addNode({id:""+a,coordinates:b.points,origin:b.origin,rgb:b.rgb,splatSize:Math.sqrt(c.effectiveArea/c.pointCount),obb:d})}};c.prototype._transformCoordinates=function(a,b){var c=a.length/3;if(!v.bufferToBuffer(a,this.layer.spatialReference,0,a,this.view.renderCoordsHelper.spatialReference,0,
c))throw Error("Can't reproject");for(var d=new Float32Array(3*c),e=0;e<c;e++)d[3*e]=a[3*e]-b[0],d[3*e+1]=a[3*e+1]-b[1],d[3*e+2]=a[3*e+2]-b[2];return{points:d,origin:b}};c.prototype._applyElevationOffsetInPlace=function(a,b){var c=a.length/3;if(0!==b)for(var d=0;d<c;d++)a[3*d+2]+=b};c.prototype.getStats=function(){var a=this;return{"Rendered Nodes":this._renderedNodes.size,"Rendered Points":z(this._renderedNodes).reduce(function(b,c){return b+a._index.getNode(c).pointCount},0),"Loading Nodes":this._loadingNodes.size,
"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length}};return c}(e.declared(C,E));h([e.property()],d.prototype,"view",void 0);h([e.property()],d.prototype,"layer",void 0);h([e.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],d.prototype,"baseUrl",void 0);h([e.property({readOnly:!0,dependsOn:["layer.renderer"]})],d.prototype,"pointScale",null);h([e.property({readOnly:!0,dependsOn:["layer.renderer"]})],d.prototype,"pointMinSize",null);h([e.property({readOnly:!0,dependsOn:["layer.renderer"]})],
d.prototype,"useRealWorldSymbolSizes",null);h([e.property({readOnly:!0,dependsOn:["layer.renderer"]})],d.prototype,"pointSize",null);h([e.property({readOnly:!0,dependsOn:["layer.renderer"]})],d.prototype,"inverseDensity",null);h([e.property()],d.prototype,"maximumPointCount",void 0);h([e.property({readOnly:!0,dependsOn:["view.clippingArea"]})],d.prototype,"_clippingBox",null);h([e.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],d.prototype,"_elevationOffset",null);h([e.property()],d.prototype,
"updating",null);h([e.property()],d.prototype,"updatingPercentageValue",null);return d=h([e.subclass("esri.views.3d.layers.PointCloudLayerView3D")],d)});