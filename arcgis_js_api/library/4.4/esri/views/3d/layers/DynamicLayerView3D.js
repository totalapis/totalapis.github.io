// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("../../layers/LayerView ../../../geometry/Extent ../../../core/HandleRegistry ../../../layers/support/ExportImageParameters ./support/overlayImageUtils ./support/projectExtentUtils ../lib/glMatrix ../webgl-engine/Stage ../webgl-engine/lib/Texture ../webgl-engine/lib/RenderGeometry ../webgl-engine/materials/Material ../webgl-engine/lib/Util".split(" "),function(n,p,q,r,h,t,k,f,u,v,w,l){var x=l.assert,y=k.mat4d,m=k.vec4d;return n.createSubclass({declaredClass:"esri.views.3d.layers.DynamicLayerView3D",
supportsDraping:!0,hasDraped:!0,drawingOrder:0,_updatingOverlay:!1,_handles:null,_exportImageParameters:null,_imageVersion:null,constructor:function(){this._extents=[];this._images=[];this.fullExtentInViewSpatialReference=null;this._handles=new q},initialize:function(){this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);this._handles.add(this.watch("suspended",function(a){if(a)this.clear(),this.emit("draped-data-change");else{a=this._extents.length;for(var b=0;b<a;b++)this.fetch(b)}}.bind(this)));
this._exportImageParameters=new r({layer:this.layer});var a=this.notifyChange.bind(this,"suspended");this._handles.add([this.watch("fullOpacity",this._opacityChangeHandler.bind(this)),this.layer.watch("minScale",a),this.layer.watch("maxScale",a),this._exportImageParameters.watch("version",function(a){this._imageVersion!==a&&(this._imageVersion=a,this._refetch())}.bind(this))],"layer");this.view.resourceController.registerIdleFrameWorker(this,{idleBegin:function(){this._hasScaleRange()&&this.notifyChange("suspended")}});
(a=t.toView(this).then(function(a){this.fullExtentInViewSpatialReference=a}.bind(this)))&&this.addResolvingPromise(a)},destroy:function(){this.clear();this._handles.destroy();this.view.resourceController.deregisterIdleFrameWorker(this);this._exportImageParameters&&(this._exportImageParameters.layer=null,this._exportImageParameters.destroy(),this._exportImageParameters=null)},getPopupData:function(a){var b=this.view.scale;return this.layer.allSublayers.filter(function(a){var d=0===a.minScale||b<=a.minScale,
c=0===a.maxScale||b>=a.maxScale;return a.popupTemplate&&a.visible&&d&&c}).map(function(b){var d=b.createQuery();d.geometry=a;d.outFields=this.getTemplateOutFields(b.popupTemplate);return b.queryFeatures(d).then(function(a){return a.features})},this)},getTemplateOutFields:function(a){if(!a||!a.fieldInfos)return["*"];var b=[];a.fieldInfos.forEach(function(a){var d=a.fieldName&&a.fieldName.toLowerCase();d&&"shape"!==d&&0!==d.indexOf("relationships/")&&b.push(a.fieldName)});return b},setDrapingExtent:function(a,
b,e,d){var c=(b[2]-b[0])/(b[3]-b[1]);d=1.0001<c?[d,d/c]:.9999>c?[d*c,d]:[d,d];var c=this.layer.imageMaxWidth,g=this.layer.imageMaxHeight;d[0]>c&&(d[1]=Math.floor(d[1]*c/d[0]),d[0]=c);d[1]>g&&(d[0]=Math.floor(d[0]*g/d[1]),d[1]=g);this._extents[a]={extent:b,spatialReference:e,imageSize:d};this.suspended||this.fetch(a)},fetch:function(a){if(!this.suspended){var b=this._extents[a],e=b.extent,d=new p(e[0],e[1],e[2],e[3],b.spatialReference);this._exportImageParameters.scale!==this.view.scale&&(this._exportImageParameters.scale=
this.view.scale);this._imageVersion=this._exportImageParameters.version;this._images[a]||(this._images[a]={texture:null,material:null,rendergeometry:null,loadingPromise:null,image:null,worldExtent:m.create(e)});var c=this._images[a];c.loadingPromise&&c.loadingPromise.cancel();c.loadingPromise=this.layer.fetchImage(d,b.imageSize[0],b.imageSize[1],{allowImageDataAccess:!0});c.loadingPromise.then(function(b){c.loadingPromise=null;c.image=b;m.set(e,c.worldExtent);this._createStageObjects(a,b);0===a&&
this._images[1]&&this._images[1].rendergeometry&&this._createStageObjects(1,null);this._evaluateUpdatingState();this.emit("draped-data-change")}.bind(this)).otherwise(function(a){a&&"CancelError"===a.name||(c.loadingPromise=null,this._evaluateUpdatingState())}.bind(this));this._evaluateUpdatingState()}},clear:function(){for(var a in this._images)this.clearImage(a)},clearImage:function(a){if(a=this._images[a])a.rendergeometry&&(this.view._stage.getTextureGraphicsRenderer().removeRenderGeometries([a.rendergeometry]),
a.rendergeometry=null),a.texture&&(this.view._stage.remove(f.ModelContentType.TEXTURE,a.texture.getId()),a.texture=null),a.material&&(this.view._stage.remove(f.ModelContentType.MATERIAL,a.material.getId()),a.material=null),a.loadingPromise&&(a.loadingPromise.cancel(),a.loadingPromise=null),a.image=null},canResume:function(){if(!this.inherited(arguments))return!1;var a=this.layer.minScale,b=this.layer.maxScale;if(0<a||0<b){var e=this.view.scale;if(e<b||0<a&&e>a)return!1}return!0},_refetch:function(){for(var a=
0;a<this._extents.length;a++)this._extents[a]&&this.fetch(a)},_drawingOrderSetter:function(a){if(a!==this._get("drawingOrder")){this._set("drawingOrder",a);var b={};this._images.forEach(function(e){e&&e.material&&(e.material.setRenderPriority(a),b[e.material.getId()]=!0)});l.objectEmpty(b)||(this.view._stage.getTextureGraphicsRenderer().updateRenderOrder(b),this.emit("draped-data-change"))}},_hasScaleRange:function(){return 0<this.get("layer.minScale")||0<this.get("layer.maxScale")},_opacityChangeHandler:function(a){this._images.forEach(function(b){b&&
b.material&&b.material.setParameterValues({opacity:a})}.bind(this));this.emit("draped-data-change")},_evaluateUpdatingState:function(){this.notifyChange("updating")},isUpdating:function(){if(this._updatingOverlay)return!0;for(var a in this._images)if(this._images[a].loadingPromise)return!0;return!1},_createStageObjects:function(a,b){var e=this.view._stage,d=e.getTextureGraphicsRenderer(),c=this._images[a];b?(c.texture&&e.remove(f.ModelContentType.TEXTURE,c.texture.getId()),c.texture=new u(b,"dynamicMapLayer",
{width:b.width,height:b.height,wrapClamp:!0}),e.add(f.ModelContentType.TEXTURE,c.texture)):x(c.texture);c.material?b&&c.material.setParameterValues({textureId:c.texture.getId()}):(c.material=new w({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.fullOpacity,textureId:c.texture.getId(),receiveSSAO:!1},"dynamicMapLayer"),c.material.setRenderPriority(this.drawingOrder),e.add(f.ModelContentType.MATERIAL,c.material));if(0===a)a=h.createGeometryForExtent(c.worldExtent,-1);else if(1===a){a=this._images[0].worldExtent;
if(!a)return;a=h.createOuterImageGeometry(a,c.worldExtent,-1)}else{console.error("DynamicLayerView3D._createStageObjects: Invalid extent idx");return}b=new v(a);b.material=c.material;b.origin={vec3:[0,0,0],id:"0_0"};b.transformation=y.identity();b.name="dynamicMapLayer";b.uniqueName="dynamicMapLayer#"+a.id;d.addRenderGeometries([b]);c.rendergeometry&&d.removeRenderGeometries([c.rendergeometry]);c.rendergeometry=b}})});