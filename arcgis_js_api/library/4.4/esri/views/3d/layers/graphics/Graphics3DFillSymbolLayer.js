// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/screenUtils ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DDrapedGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./lineUtils ./graphicUtils ../../../../geometry/Polygon ../../../../Color ../../lib/glMatrix ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/lib/Util ./earcut/earcut".split(" "),
function(x,P,D,E,r,F,G,H,l,t,I,J,K,y,u,v,L,z,M,A,N,O,B){var w=O.VertexAttrConstants;x=y.vec3d;var q=y.mat4d;r=function(r){function m(){var a=null!==r&&r.apply(this,arguments)||this;a._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};return a}D(m,r);m.prototype._prepareResources=function(){this._prepareFillResources();this._prepareOutlineResources();this.resolve()};m.prototype._prepareFillResources=function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),b=
{color:b,transparent:1>b[3]||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0};this._material=new N(b,a+"_colormat");this._context.stage.add(v.ModelContentType.MATERIAL,this._material)};m.prototype._prepareOutlineResources=function(){var a=this.symbol.outline;if(this._hasOutline=!!(a&&a.size&&0<a.size&&a.color))a={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:E.pt2px(a.size)},2<a.width?(this._outlineMaterial=t.createRibbonMaterial(a),this._isOutlineNativeLineMaterial=
!1):(this._outlineMaterial=t.createNativeMaterial(a),this._isOutlineNativeLineMaterial=!0),this._context.stage.add(v.ModelContentType.MATERIAL,this._outlineMaterial)};m.prototype.destroy=function(){this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(v.ModelContentType.MATERIAL,this._material.getId()),this._material=null);this._outlineMaterial&&(this._context.stage.remove(v.ModelContentType.MATERIAL,this._outlineMaterial.getId()),this._outlineMaterial=null)};m.prototype.createGraphics3DGraphic=
function(a,b){var h=a.geometry;if("polyline"!==h.type&&"polygon"!==h.type&&"extent"!==h.type)return this._logWarning("unsupported geometry type for fill symbol: "+h.type),null;h="graphic"+a.uid;b=this._getVertexOpacityAndColor(b,Uint8Array,255);var g=this.getGraphicElevationInfo(a);return"on-the-ground"===g.mode?this._createAsOverlay(a,b,g,h):this._createAs3DShape(a,b,g,h,a.uid)};m.prototype.layerPropertyChanged=function(a,b,h){if("opacity"===a)return b=this._material.getColor(),b[3]=this._getMaterialOpacity(),
this._material.setColor(b),this._material.setTransparent(1>b[3]),this._outlineMaterial&&(this._isOutlineNativeLineMaterial?(b=this._outlineMaterial.getColor(),b[3]=this._getOutlineOpacity(),this._outlineMaterial.setColor(b)):(b=this._outlineMaterial.getParameterValues(),b.color[3]=this._getOutlineOpacity(),this._outlineMaterial.setParameterValues({color:b.color}))),!0;if("elevationInfo"===a){a=this._elevationInfo.mode;this._updateElevationInfo();var g=this._elevationInfo.mode;if(null==a||null==g)return!1;
if("on-the-ground"===a&&"on-the-ground"===g)return!0;if(a!==g&&("on-the-ground"===a||"on-the-ground"===g))return!1;a=l.needsElevationUpdates2D(g);for(var k in b){var e=b[k];(g=h(e))&&!g.isDraped()&&(e=e.graphic,g.needsElevationUpdates=a,g.elevationInfo.set(this.getGraphicElevationInfo(e)))}return!0}return!1};m.prototype.setDrawOrder=function(a,b,h){this._material&&(this._material.setRenderPriority(a+b/2),h[this._material.getId()]=!0);this._outlineMaterial&&(this._outlineMaterial.setRenderPriority(a),
h[this._outlineMaterial.getId()]=!0)};m.prototype._createAs3DShape=function(a,b,h,g,k){a=this._getPolyGeometry(a);var e=a.hasZ,c=this._getOutlineGeometry(a,a.rings);a=l.getGeometryVertexData3D(c,e,a.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,h);f.idHint=g;f.color=b;f.isRings=!0;f.data=a;var d;this._hasOutline&&(d=new a.vertexData.constructor(a.vertexData));f.outNum=0;f.outGeometries=[];f.outTransforms=[];f.outMaterials=[];this._createAs3DShapeFill(f);f.data.vertexData=
d;this._createAs3DShapeOutline(f);if(0===f.outNum)return null;b=new L({geometries:f.outGeometries,materials:f.outMaterials,transformations:f.outTransforms,castShadow:!1,metadata:{layerId:this._context.layer.id,graphicId:k},idHint:g});b=new F(this,b,f.outGeometries,null,null,H.perVertexElevationAligner,h);b.alignedTerrainElevation=a.terrainElevation;b.needsElevationUpdates=l.needsElevationUpdates2D(h.mode);return b};m.prototype._createAs3DShapeFill=function(a){for(var b=a.data.geometryData.polygons,
h=a.data.eleVertexData,g=a.data.vertexData,k=function(d){var c=b[d];d=c.count;var k=c.index;if(e._context.clippingExtent&&(l.computeBoundingBox(h,k,d,n),l.boundingBoxClipped(n,e._context.clippingExtent)))return"continue";var f=new Float64Array(h.buffer,3*k*h.BYTES_PER_ELEMENT,3*d),m=new Float64Array(g.buffer,3*k*g.BYTES_PER_ELEMENT,3*d),c=c.holeIndices.map(function(a){return a-k}),c=B(f,c,3);if(0===c.length)return"continue";l.chooseOrigin(g,k,d,p);l.subtractCoordinates(g,k,d,p);d=e._createFillGeometry(c,
0,m,f,a.color);d=new z(d,a.idHint);d.singleUse=!0;f=q.identity();q.translate(f,p,f);a.outGeometries.push(d);a.outMaterials.push([e._material]);a.outTransforms.push(f);a.outNum++},e=this,c=0;c<b.length;++c)k(c)};m.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,f=a.data.eleVertexData,g=a.data.vertexData,k=0;k<b.length;++k){var e=b[k],c=e.index,d=e.count;if(this._context.clippingExtent&&(l.computeBoundingBox(f,c,d,n),l.boundingBoxClipped(n,this._context.clippingExtent)))continue;
l.chooseOrigin(g,c,d,p);l.subtractCoordinates(g,c,d,p);e=new Float64Array(f.buffer,3*c*f.BYTES_PER_ELEMENT,3*d);c=new Float64Array(g.buffer,3*c*g.BYTES_PER_ELEMENT,3*d);c=t.createPolylineGeometry(c,e,a.isRings,C,0);c=new z(c,a.idHint+"outline"+k);c.singleUse=!0;e=q.identity();q.translate(e,p,e);a.outGeometries.push(c);a.outMaterials.push([this._outlineMaterial]);a.outTransforms.push(e);a.outNum++}};m.prototype._createAsOverlay=function(a,b,h,g){a=this._getPolyGeometry(a);var k=this._getOutlineGeometry(a,
a.rings);if(0===k.length)return null;this._material.setRenderPriority(this._symbolLayerOrder+this._symbolLayerOrderDelta/2);this._hasOutline&&this._outlineMaterial.setRenderPriority(this._symbolLayerOrder);a=l.getGeometryVertexDataDraped(k,a.spatialReference,this._context.overlaySR);f.idHint=g;f.color=b;f.isRings=!0;f.data=a;var e;this._hasOutline&&(e=new a.vertexData.constructor(a.vertexData));f.outNum=0;f.outGeometries=[];f.outBoundingBox=u.create(u.NEGATIVE_INFINITY);this._createAsOverlayFill(f);
f.data.vertexData=e;this._createAsOverlayOutline(f);return 0<f.outNum?new G(this,f.outGeometries,null,null,f.outBoundingBox,h):null};m.prototype._createAsOverlayFill=function(a){for(var b=a.data.vertexData,f=a.data.geometryData.polygons,g=function(c){var d=f[c];c=d.count;var e=d.index,g=new Float64Array(b.buffer,3*e*b.BYTES_PER_ELEMENT,3*c),d=d.holeIndices.map(function(a){return a-e}),g=B(g,d,3);if(0===g.length)return"continue";l.computeBoundingBox(b,e,c,n);if(l.boundingBoxClipped(n,k._context.clippingExtent))return"continue";
u.expand(a.outBoundingBox,n);l.chooseOrigin(b,e,c,p);l.subtractCoordinates(b,e,c,p);l.setZ(b,e,c,k._getDrapedZ());c=q.identity();q.translate(c,p,c);g=k._createFillGeometry(g,e,b,null,a.color);d=new A(g);d.material=k._material;var h=n;d.center=[.5*(h[0]+h[3]),.5*(h[1]+h[4]),0];d.bsRadius=.5*Math.sqrt((h[3]-h[0])*(h[3]-h[0])+(h[4]-h[1])*(h[4]-h[1]));d.transformation=c;d.name=a.idHint;d.uniqueName=a.idHint+"#"+g.id;a.outGeometries.push(d);a.outNum++},k=this,e=0;e<f.length;++e)g(e)};m.prototype._createAsOverlayOutline=
function(a){if(this._hasOutline)for(var b=a.data.vertexData,f=a.data.geometryData.outlines,g=0;g<f.length;++g){var k=f[g],e=k.index,k=k.count;l.computeBoundingBox(b,e,k,n);if(!l.boundingBoxClipped(n,this._context.clippingExtent)){u.expand(a.outBoundingBox,n);l.chooseOrigin(b,e,k,p);l.subtractCoordinates(b,e,k,p);l.setZ(b,e,k,this._getDrapedZ());k=new Float64Array(b.buffer,3*e*b.BYTES_PER_ELEMENT,3*k);e=q.identity();q.translate(e,p,e);var k=t.createPolylineGeometry(k,null,a.isRings,C,0),c=new A(k);
c.material=this._outlineMaterial;var d=n;c.center=[.5*(d[0]+d[3]),.5*(d[1]+d[4]),0];c.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]));c.transformation=e;c.name=a.idHint+"outline";c.uniqueName=a.idHint+"outline#"+k.id;a.outGeometries.push(c);a.outNum++}}};m.prototype._getOutlineGeometry=function(a,b){return a._outlineSegments?t.createOutlineGeometryFromSegments(b,a._outlineSegments):b};m.prototype._getOutlineOpacity=function(){return this._getLayerOpacity()*this.symbol.outline.color.a};
m.prototype._getOutlineColor=function(){var a=this.symbol.outline.color,b=this._getOutlineOpacity();return I.mixinColorAndOpacity(K.toUnitRGB(a),b)};m.prototype._getPolyGeometry=function(a){a=a.geometry;return"extent"===a.type?J.fromExtent(a):a};m.prototype._createFillGeometry=function(a,b,f,g,k){for(var e=a.length,c=new Uint32Array(e),d=new Uint32Array(e),h=0;h<e;h++)c[h]=a[h]+b,d[h]=0;a={};b={};a[w.POSITION]=c;a[w.COLOR]=d;b[w.POSITION]={size:3,data:f};b[w.COLOR]={size:4,data:k};g&&(b.mapPos={size:3,
data:g},a.mapPos=c);return new M(b,a)};return m}(r);var n=u.create(),p=x.create(),C=new Float32Array([255,255,255,255]),f={idHint:null,color:null,isRings:!1,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return r});