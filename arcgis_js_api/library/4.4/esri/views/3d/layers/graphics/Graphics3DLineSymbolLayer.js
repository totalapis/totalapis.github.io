// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DDrapedGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./lineUtils ../../../../core/screenUtils ../../../../geometry/Polygon ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/RenderGeometry ./graphicUtils".split(" "),function(P,Q,E,F,G,H,I,m,t,A,J,B,C,K,L,M,N){var D=B.vec3d,w=B.mat4d;
return function(q){function e(){return null!==q&&q.apply(this,arguments)||this}E(e,q);e.prototype._prepareResources=function(){var a=this.symbol,b=this._isPropertyDriven("size")||this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),a={idHint:this._getStageIdHint(),width:this._getWidth(a),color:this._getMaterialOpacityAndColor()};if(!this._isPropertyDriven("size")){var c=N.validateSymbolLayerSize(a.width);if(c){this._logWarning(c);this.reject();return}}if(b||1.5<=a.width)this._isPropertyDriven("size")&&
(a.width=0),this._isNativeLineMaterial=!1,this._material=t.createRibbonMaterial(a);else if(0<a.width)this._isNativeLineMaterial=!0,this._material=t.createNativeMaterial(a);else{this.reject();return}this._context.stage.add(C.ModelContentType.MATERIAL,this._material);this.resolve()};e.prototype._getWidth=function(a){return null!=a.size?A.pt2px(a.size):1};e.prototype.destroy=function(){this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(C.ModelContentType.MATERIAL,this._material.getId()),
this._material=null)};e.prototype.createGraphics3DGraphic=function(a,b){var c=a.geometry;if("polyline"!==c.type&&"polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for line symbol: "+c.type),null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",d="graphic"+a.uid,e=this._getVertexOpacityAndColor(b,Float32Array,255),h=0;b.size&&this._isPropertyDriven("size")&&(h=m.getSingleSizeDriver(b.size),h=A.pt2px(h));b=this.getGraphicElevationInfo(a);return"on-the-ground"===
b.mode?this._createAsOverlay(a,c,e,h,b,d):this._createAs3DShape(a,c,e,h,b,d,a.uid)};e.prototype.layerPropertyChanged=function(a,b,c){if("opacity"===a)return this._isNativeLineMaterial?(b=this._material.getColor(),b[3]=this._getMaterialOpacity(),this._material.setColor(b)):(b=this._material.getParameterValues(),b.color[3]=this._getMaterialOpacity(),this._material.setParameterValues({color:b.color})),!0;if("elevationInfo"===a){a=this._elevationInfo.mode;this._updateElevationInfo();var d=this._elevationInfo.mode;
if(null==a||null==d)return!1;if("on-the-ground"===a&&"on-the-ground"===d)return!0;if(a!==d&&("on-the-ground"===a||"on-the-ground"===d))return!1;a=m.needsElevationUpdates2D(d);for(var e in b){var h=b[e];(d=c(h))&&!d.isDraped()&&(h=h.graphic,d.needsElevationUpdates=a,d.elevationInfo.set(this.getGraphicElevationInfo(h)))}return!0}return!1};e.prototype._getOutlineGeometry=function(a,b){return a._outlineSegments?t.createOutlineGeometryFromSegments(b,a._outlineSegments):b};e.prototype._getGeometry=function(a){a=
a.geometry;"extent"===a.type&&(a=J.fromExtent(a));return a};e.prototype._createAs3DShape=function(a,b,c,e,u,h,O){var g=this._getGeometry(a),f=g.hasZ,d=this._getOutlineGeometry(g,g[b]);if(0<d.length){a=[];for(var r=[],k=[],n=D.create(),p=Array(6),g=m.getGeometryVertexData3D(d,f,g.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,u),f=g.geometryData.outlines,d=g.eleVertexData,x=g.vertexData,y=0;y<f.length;++y){var z=f[y],l=z.index,v=z.count;if(this._context.clippingExtent&&
(m.computeBoundingBox(d,l,v,p),m.boundingBoxClipped(p,this._context.clippingExtent)))continue;m.chooseOrigin(x,l,v,n);m.subtractCoordinates(x,l,v,n);z=new Float64Array(d.buffer,3*l*d.BYTES_PER_ELEMENT,3*v);l=new Float64Array(x.buffer,3*l*x.BYTES_PER_ELEMENT,3*v);l=t.createPolylineGeometry(l,z,"rings"===b,c,e);l=new L(l,h+"path"+y);l.singleUse=!0;a.push(l);r.push([this._material]);l=w.identity();w.translate(l,n,l);k.push(l)}if(0<a.length)return b=new K({geometries:a,materials:r,transformations:k,castShadow:!1,
metadata:{layerId:this._context.layer.id,graphicId:O},idHint:h}),b=new G(this,b,a,null,null,I.perVertexElevationAligner,u),b.alignedTerrainElevation=g.terrainElevation,b.needsElevationUpdates=m.needsElevationUpdates2D(u.mode),b}return null};e.prototype._createAsOverlay=function(a,b,e,d,u,h){var c=this._getGeometry(a);this._material.setRenderPriority(this._symbolLayerOrder);var g=this._getOutlineGeometry(c,c[b]);if(0<g.length){a=[];for(var f=Array(6),q=D.create(),g=m.getGeometryVertexDataDraped(g,
c.spatialReference,this._context.overlaySR),c=g.vertexData,g=g.geometryData.outlines,r=0;r<g.length;++r){var k=g[r],n=k.index,k=k.count;m.computeBoundingBox(c,n,k,f);if(!m.boundingBoxClipped(f,this._context.clippingExtent)){m.chooseOrigin(c,n,k,q);m.subtractCoordinates(c,n,k,q);m.setZ(c,n,k,this._getDrapedZ());k=new Float64Array(c.buffer,3*n*c.BYTES_PER_ELEMENT,3*k);n=w.identity();w.translate(n,q,n);var k=t.createPolylineGeometry(k,null,"rings"===b,e,d),p=new M(k);p.material=this._material;p.center=
[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0];p.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]));p.transformation=n;p.name=h;p.uniqueName=h+"#"+k.id;a.push(p)}}return new H(this,a,null,null,f,u)}return null};return e}(F)});