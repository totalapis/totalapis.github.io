// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/watchUtils ../../../../core/HandleRegistry ../../../../core/Logger ../../support/aaBoundingRect ../../support/PreallocArray ./deconflictorDebug ../../lib/glMatrix ../../webgl-engine/lib/Util ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/materials/internal/MaterialUtil ../../webgl-engine/materials/HUDMaterial".split(" "),function(z,ba,ca,J,P,D,v,E,B,K,L,Q,C,R){function F(c){return!!c&&"selection"===
c.type}var x=K.vec2d;z=K.vec4d;var M=L.VertexAttrConstants,S=D.getLogger("esri.views.3d.graphics.Deconflictor"),T=z.create(),U=z.create(),V=z.create(),W=z.create(),G=x.create(),X=v.create(),Y=v.create(),H=new Set,N=L.lerp,A=new E(100),y=new E(100),Z=function(){function c(a,b){this.creator=a;this.disposer=b;this.list=[];this.currentIndex=0}c.prototype.alloc=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];this.currentIndex>=this.list.length&&this.list.push(new this.creator(a));
return this.list[this.currentIndex++]};c.prototype.freeAll=function(){for(var a=this.currentIndex,b=this.disposer,w=this.list;0<=--a;)b(w[a]);this.currentIndex=0};return c}(),O=function(){function c(){this.graphics3DGraphic=null;this.positions=[x.create(),x.create(),x.create(),x.create()];this.posView=this.yMax=this.yMin=this.xMax=this.xMin=0;this.graphicsOwner=null;this.graphicId=this.id=0}c.release=function(a){a.graphics3DGraphic=null;a.graphicsOwner=null};return c}();D=function(){function c(a){var b=
this;this.graphicsOwners=[];this.deconflictTimeoutId=0;this.handles=new P;this.graphicInfoPool=new Z(O,O.release);this.nextGraphicInfoId=0;this.accBinsNumX=15;this.accBinsNumY=20;this.accBinsSizeY=this.accBinsSizeX=0;this.accBins=null;this.accNumTests=0;this.iconMarginFactor=-.1;this.view=a;this.stage=a._stage;this.handles.add([J.on(a,"navigation","targetViewChanged",function(){return b.scheduleRun()}),J.whenNot(a,"ready",function(){return b.clearDeconflictTimeout()})])}c.prototype.destroy=function(){this.handles.destroy();
this.handles=null;this.clearDeconflictTimeout();this.graphicInfoPool.freeAll();this.stage=this.view=this.graphicInfoPool=null};c.prototype.clearDeconflictTimeout=function(){this.deconflictTimeoutId&&(clearTimeout(this.deconflictTimeoutId),this.deconflictTimeoutId=0)};c.prototype.addGraphicsOwner=function(a){var b=this;this.graphicsOwners.push(a);this.setDirty();a.layer&&"function"===typeof a.layer.watch&&a.layer.watch("featureReduction",function(w,d){F(w)?b.setDirty():F(d)&&(b._removeIconVisibilityFlags(a),
b.setDirty())})};c.prototype.removeGraphicsOwner=function(a){a=this.graphicsOwners.indexOf(a);0<=a&&this.graphicsOwners.splice(a,1);this.setDirty()};c.prototype.setDirty=function(){this.scheduleRun(10)};c.prototype.initializeLabelVisibility=function(a){a.setVisibilityFlag(2,!1,1)};c.prototype.doesIntersectExistingPoly=function(a){var b=a.graphicId,w=a.positions;H.clear();for(var d=Math.floor(a.xMin/this.accBinsSizeX);d<=Math.floor(a.xMax/this.accBinsSizeX);d++)if(!(0>d||d>=this.accBinsNumX))for(var c=
Math.floor(a.yMin/this.accBinsSizeY);c<=Math.floor(a.yMax/this.accBinsSizeY);c++)if(!(0>c||c>=this.accBinsNumY)){var h=this.accBins[d][c],n=0;a:for(;n<h.length;n++){var t=h.data[n];if(t.graphicId!==b&&!H.has(t.id)){H.add(t.id);t=t.positions;this.accNumTests++;for(var r=0;2>r;r++){var m=0===r?w:t,f=0===r?t:w,q=0;b:for(;4>q;q++){var k=m[q],g=m[(q+1)%4],p=m[(q+2)%4];G[0]=g[0]-k[0];G[1]=g[1]-k[1];g=x.normalize(G);e=[-g[1],g[0]];g[0]=e[0];g[1]=e[1];k=g[0]*k[0]+g[1]*k[1];p=g[0]*p[0]+g[1]*p[1]<k;for(e=0;4>
e;e++){var u=f[e],u=g[0]*u[0]+g[1]*u[1];if(p&&u<k||!p&&u>k)continue b}continue a}}return!0}}}return!1;var e};c.prototype.initBins=function(a,b){if(null==this.accBins){this.accBins=[];for(var c=0;c<this.accBinsNumX;c++){this.accBins.push([]);for(var d=this.accBins[this.accBins.length-1],l=0;l<this.accBinsNumY;l++)d.push(new E(10))}}for(c=0;c<this.accBinsNumX;c++)for(l=0;l<this.accBinsNumY;l++)this.accBins[c][l].clear();this.accBinsSizeX=a/this.accBinsNumX;this.accBinsSizeY=b/this.accBinsNumY;this.accNumTests=
0};c.prototype.addToBins=function(a){for(var b=Math.floor(a.xMin/this.accBinsSizeX);b<=Math.floor(a.xMax/this.accBinsSizeX);b++)if(!(0>b||b>=this.accBinsNumX))for(var c=Math.floor(a.yMin/this.accBinsSizeY);c<=Math.floor(a.yMax/this.accBinsSizeY);c++)0>c||c>=this.accBinsNumY||this.accBins[b][c].push(a)};c.prototype.scheduleRun=function(a){var b=this;void 0===a&&(a=200);0===this.deconflictTimeoutId&&(this.deconflictTimeoutId=setTimeout(function(){return b.run()},a))};c.prototype.run=function(){var a=
this.view;if(a.ready){var b=a.navigation.targetCamera;this.clearDeconflictTimeout();this.graphicInfoPool.freeAll();this.nextGraphicInfoId=0;var c=b.fullWidth,d=b.fullHeight;B.prepare(a);A.clear();y.clear();for(var a=!1,l=0;l<this.graphicsOwners.length;l++){var h=this.graphicsOwners[l];if(null!=h.getGraphics3DGraphics&&null!=h.getGraphics3DGraphicsKeys){var n=null!=h.labelsEnabled&&h.labelsEnabled(),t=F(h.layer?h.layer.featureReduction:null);if(n||t){a||(this.initBins(c,d),a=!0);for(var r=h.getGraphics3DGraphics(),
m=h.getGraphics3DGraphicsKeys(),f=0;f<m.length;f++){var q=r[m[f]];q.areVisibilityFlagsSet(void 0,2)&&(t&&this._collectGraphics(q,!1,h,b,A,this.iconMarginFactor),n&&this._collectGraphics(q,!0,h,b,y))}}}}A.sort(function(a,b){return b.posView-a.posView});y.sort(function(a,b){return b.posView-a.posView});this._deconflictVisibleObjects(A,!1);y.length&&this._deconflictVisibleObjects(y,!0);B.drawAccelerationStruct(this,A);B.drawAccelerationStruct(this,y)}else this.setDirty()};c.prototype._collectGraphics=
function(a,b,c,d,l,h){void 0===h&&(h=0);var n=b?a._labelGraphics:a._graphics,w=b?1:0;if(n.length){b=v.set(X,v.NEGATIVE_INFINITY);for(var r,m,f,q=0;q<n.length;q++){var k=n[q];if(!k.isDraped()){var g=k.stageObject,p=g?g.getNumGeometryRecords():0;if(!(1>p)){var u=g.getGeometryRecord(0),e=u.materials[0];if(e instanceof R)if(1<p)S.warn("Graphic objects with more than 1 geometry record are not supported");else{p=u.geometry.getData().getVertexAttr();if(!m){m=g.getCenter();f=u.origin.vec3;m=C.transformToWorld(m,
f,T);m=C.transformToView(m,f,d.viewMatrix,U);e.applyVerticalOffsetTransformation(m,p[M.NORMAL].data,g.objectTransformation,d,I);g=p[M.AUXPOS1].data;p="screen"!==e.getParams().centerOffsetUnits;f=C.transformToProjection(m,d.projectionMatrix,p?g:[0,0,0],V);f=C.transformToNDC(f,W);p||(f[0]+=g[0]/d.fullWidth*2,f[1]+=g[1]/d.fullHeight*2);if(-1>f[0]||-1>f[1]||-1>f[2]||1<=f[0]||1<=f[1])break;r=m[2];a.areVisibilityFlagsSet(2,void 0,w)&&(r*=.7)}k=k.getScreenSize(aa);Q.applyPrecomputedScaleFactorVec2(k,I.factor,
k);e=v.offset(e.calculateRelativeScreenBounds(k,I.scaleAlignment,Y),N(0,d.fullWidth,.5+.5*f[0]),N(0,d.fullHeight,.5+.5*f[1]));0!==h&&(k=h*Math.min(v.width(e),v.height(e)),e[0]-=k,e[1]-=k,e[2]+=k,e[3]+=k);v.expand(b,e)}}}}null!=r&&(d=this.graphicInfoPool.alloc(),d.id=this.nextGraphicInfoId++,d.graphicId=a.graphic.uid,d.xMin=b[0],d.yMin=b[1],d.xMax=b[2],d.yMax=b[3],d.positions[0][0]=b[0],d.positions[0][1]=b[1],d.positions[1][0]=b[0],d.positions[1][1]=b[3],d.positions[2][0]=b[2],d.positions[2][1]=b[3],
d.positions[3][0]=b[2],d.positions[3][1]=b[1],d.graphics3DGraphic=a,d.posView=r,d.graphicsOwner=c,l.push(d))}};c.prototype._deconflictVisibleObjects=function(a,b){for(var c=b?1:0,d=0;d<a.length;d++){var l=a.data[d],h=l.graphics3DGraphic,n=!(b&&!1===h.areVisibilityFlagsSet(2,void 0))&&!this.doesIntersectExistingPoly(l);n&&this.addToBins(l);h.setVisibilityFlag(2,n,c);B.drawPoly(l.positions,n?"green":"red")}};c.prototype._removeIconVisibilityFlags=function(a){if(null!=a.getGraphics3DGraphics&&null!=
a.getGraphics3DGraphicsKeys){var b=a.getGraphics3DGraphics(),c=0;for(a=a.getGraphics3DGraphicsKeys();c<a.length;c++)b[a[c]].setVisibilityFlag(2,void 0)}};return c}();var I={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},scaleAlignment:0,minPixelSizeAlignment:0},aa=x.create();return D});