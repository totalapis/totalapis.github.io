// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/_base/lang dojo/Deferred ../../../../request ../../../../core/Version ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Util ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/materials/Material ../../webgl-engine/lib/Texture ../../support/aaBoundingBox".split(" "),function(S,n,T,J,C,K,H,L,D,M,N,O,P,Q,y){function u(b,c){var r=[],p=[],m=[],g=[],I=[],q=H.Version.parse(b.version||
"1.0","wosr");R.validate(q);var q="meshsymbol_"+b.model.name,d=b.textureDefinitions,n={},w;for(w in d){var t=d[w],e=t.images[0].data;E(e,"symbol resources must have embedded texture data (at the moment)");var h="/textureDefinitions/"+w,e=new Q(t.encoding+";base64,"+e,q,{noUnpackFlip:!0});I.push(e);n[h]={engineTexObj:e,transparent:"rgba"===t.channels}}w=b.model.geometries;d=b.materialDefinitions;for(t=0;t<w.length;t++){var k=w[t];k.params.components||(h=k,e=h.params,E(e.material),e.components=[{id:1,
material:h.params.material,texture:h.params.texture,region:h.params.texture}],e.faces&&(e.faces.componentIndices=[e.faces.position.count]));var h=k.params.components,v=h.length,e=k.params.faces,z=k.params.vertexAttributes,f=k.params.topology||"Indexed",k={},u;for(u in z){var x=z[u],l=x.values;E(x.values,"symbol resources with external geometry bin not yet supported");k[u]={data:l,size:x.valuesPerElement}}z=void 0;x=Array(v);if("Indexed"===f){var z=e.componentIndices,C;for(C in e);}else"PerAttributeArray"!==
f?console.warn("I3S symbol loader: unsupported topology type "+f):1!==v&&console.warn("I3S symbol loader: if topology is not Indexed, only single component geometries are supported");m.push([]);for(v=0;v<h.length;v++){f=h[v];l={type:"triangle",positionKey:"position",indices:{}};if(z)for(var G in e){if("componentIndices"!==G){var a=e[G];E(a.values,"symbol resources with external geometry bin not yet supported");l.indices[G]=new Uint32Array(a.values)}}else{for(var a=k.position.data.length/k.position.size,
y=new Uint32Array(a),F=0;F<a;F++)y[F]=F;var a=y,B;for(B in k)l.indices[B]=a}x[v]=l;l=void 0;f.texture&&(l=n[f.texture].engineTexObj.getId());a=g[f.material]?g[f.material][f.texture]:null;a||(a=f.material.substring(f.material.lastIndexOf("/")+1),a=d[a].params,1===a.transparency&&(a.transparency=0),l={ambient:a.diffuse,diffuse:a.diffuse,specular:[0,0,0],shininess:0,opacity:1-a.transparency,transparent:0<a.transparency,textureId:l,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:a.externalColorMixMode||
"tint"},c.materialParamsMixin&&J.mixin(l,c.materialParamsMixin),a=new P(l,q),g[f.material]||(g[f.material]={}),g[f.material][f.texture]=a,p.push(a));m[t].push(a)}h=new N(new O(x,k),q);r.push(h)}return{stageResources:(A={},A[D.ModelContentType.TEXTURE]=I,A[D.ModelContentType.MATERIAL]=p,A[D.ModelContentType.GEOMETRY]=r,A),materialsByComponent:m,pivotOffset:b.model.pivotOffset};var A}Object.defineProperty(n,"__esModule",{value:!0});var B=L.vec3d,E=M.assert,R=new H.Version(1,1,"wosr");n.fetch=function(b,
c){c=c||{};if(c.streamDataSupplier){var r=c.streamDataSupplier.request(b,"json"),p=new C(function(){return c.streamDataSupplier.cancelRequest(r)});r.then(function(b,g){b=u(g,c);p.resolve(b)},function(){p.reject()});return p.promise}var m=K(b),g=new C(function(){return m.cancel()});m.then(function(b){b=u(b.data,c);g.resolve(b)},function(){g.reject()});return g.promise};n.computeBoundingBox=function(b){b=b.stageResources[D.ModelContentType.GEOMETRY];for(var c=y.create(y.NEGATIVE_INFINITY),r=[0,0,0],
p=[0,0,0],m=0;m<b.length;m++)for(var g=b[m],n=g.getNumGroups(),q=0;q<n;++q){var d=g.getBoundingInfo(q);B.set(d.getBBMin(),r);B.set(d.getBBMax(),p);for(d=0;3>d;++d)c[d]=Math.min(c[d],r[d]),c[d+3]=Math.max(c[d+3],p[d])}return c};n.createStageResources=u});