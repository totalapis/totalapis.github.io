// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DSymbolCommonCode ./ElevationAligners ../../../../core/screenUtils ../../../../Color ../../../../geometry/Polygon ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Util ../../webgl-engine/lib/GeometryData ../../webgl-engine/materials/LineCalloutMaterial".split(" "),function(n,E,u,v,w,h,x,p,q,y,r,z,A,t,l){var f=A.VertexAttrConstants;n=function(d){function b(a,
c){a=d.call(this,a,null,c,!0)||this;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1};return a}u(b,d);b.prototype.destroy=function(){this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(r.ModelContentType.MATERIAL,this._material.getId()),this._material=null)};b.prototype._prepareResources=function(){var a=this._getStageIdHint();this._createMaterialsAndAddToStage(this._context.stage,a);this.resolve()};b.prototype.perInstanceMaterialParameters=function(a){var c=
this.materialParameters;c.screenOffset=a.screenOffset||[0,0];c.centerOffsetUnits=a.centerOffsetUnits||"world";return c};Object.defineProperty(b.prototype,"materialParameters",{get:function(){var a=this.symbolContainer,c=a.callout,k=q.toUnitRGBA(c.color);k[3]*=this._getLayerOpacity();var B=p.pt2px(c.size||0),e=null;if(a.verticalOffset)var e=a.verticalOffset,b=e.minWorldLength,d=e.maxWorldLength,e={screenLength:p.pt2px(e.screenLength),minWorldLength:b||0,maxWorldLength:null!=d?d:Infinity};c=c.border&&
c.border.color?q.toUnitRGBA(c.border.color):null;b="object"===a.symbolLayers.getItemAt(0).type;return{color:k,size:B,verticalOffset:e,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:c,occlusionTest:!b,shaderPolygonOffset:b?0:void 0,depthHUDAlignStart:"label-symbol-3d"===a.type}},enumerable:!0,configurable:!0});b.prototype._createMaterialsAndAddToStage=function(a,
c){this._material=new l(this.materialParameters,c+"_lineCallout_common");a.add(r.ModelContentType.MATERIAL,this._material)};b.prototype._defaultElevationInfoNoZ=function(){return C};b.prototype._getGeometry=function(a){a=a.geometry;if("extent"===a.type)return h.placePointOnPolygon(y.fromExtent(a));if("polyline"===a.type)return h.placePointOnPolyline(a);if("polygon"===a.type)return h.placePointOnPolygon(a);if("point"===a.type)return a;this._logWarning("unsupported geometry type for point symbol: "+
a.type);return null};b.prototype.createGraphics3DGraphic=function(a,c){null!=c.needsOffsetAdjustment&&(this._elevationOptions.needsOffsetAdjustment=c.needsOffsetAdjustment);var k=this.getGraphicElevationInfo(a,c.elevationOffset||0),b=c.symbol,e="on-the-ground"===this._elevationInfo.mode&&!b.symbolLayers.some(function(a){return"object"===a.type||"text"===a.type});if("label-symbol-3d"!==b.type&&e)return null;b=this._getGeometry(a);return null===b?null:this._createAs3DShape(a,b,k,c,"graphic"+a.uid,a.uid)};
b.prototype.layerPropertyChanged=function(a,c,b){switch(a){case "opacity":return this.layerOpacityChanged(c,b);case "elevationInfo":return this.layerElevationInfoChanged(c,b)}return!1};b.prototype.layerOpacityChanged=function(a,c){this._material.setParameterValues(this.materialParameters);return!0};b.prototype.layerElevationInfoChanged=function(a,c){var b=this._elevationInfo.mode;this._updateElevationInfo();var d=this._elevationInfo.mode;if(b!==d&&("on-the-ground"===b||"on-the-ground"===d))return!1;
for(var e in a)b=a[e],(d=c(b))&&this.updateGraphicElevationInfo(b.graphic,d);return!0};b.prototype.getGraphicElevationInfo=function(a,c){void 0===c&&(c=0);a=d.prototype.getGraphicElevationInfo.call(this,a);c&&(a.offset+=c);return a};b.prototype.updateGraphicElevationInfo=function(a,c){a=this.getGraphicElevationInfo(a,c.metadata.elevationOffset);c.elevationInfo.set(a);c.needsElevationUpdates=h.needsElevationUpdates2D(a.mode)};b.prototype.createVertexData=function(a){var c=a.translation;a=a.centerOffset;
if(!c&&!a)return m;c=c?{size:3,data:[c[0],c[1],c[2]]}:m[f.POSITION];a=a?{size:4,data:[a[0],a[1],a[2],a[3]]}:m[f.AUXPOS1];return b={},b[f.POSITION]=c,b[f.NORMAL]=m[f.NORMAL],b[f.AUXPOS1]=a,b;var b};b.prototype.getOrCreateMaterial=function(a,c){var b=this.perInstanceMaterialParameters(a),d=l.uniqueMaterialIdentifier(b);if(d===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(a.materialCollection){var e=a.materialCollection.getMaterial(d);e||(e=new l(b,c+"_lineCallout_shared"),
a.materialCollection.addMaterial(d,e));return{material:e,isUnique:!1}}e=new l(b,c+"_lineCallout_unique");return{material:e,isUnique:!0}};b.prototype._createAs3DShape=function(a,c,b,d,e,f){a=new t(this.createVertexData(d),D,t.DefaultOffsets,"point");a=[new z(a,e)];var k=this._context.layer.id,g=this.getOrCreateMaterial(d,e);e=h.createStageObjectForPoint.call(this,c,a,[[g.material]],null,null,b,e,k,f,!0);if(null===e)return null;f=new w(this,e.object,a,g.isUnique?[g.material]:null,null,x.perObjectElevationAligner,
b);f.metadata={elevationOffset:d.elevationOffset||0};f.alignedTerrainElevation=e.terrainElevation;f.needsElevationUpdates=h.needsElevationUpdates2D(b.mode);h.extendPointGraphicElevationInfo(f,c,this._context.elevationProvider);return f};return b}(v);var m=(d={},d[f.POSITION]={size:3,data:[0,0,0]},d[f.NORMAL]={size:3,data:[0,0,1]},d[f.AUXPOS1]={size:4,data:[0,0,0,1]},d),d=new Uint32Array([0]),D=(g={},g[f.POSITION]=d,g[f.NORMAL]=d,g[f.AUXPOS1]=d,g),C={mode:"relative-to-ground",offset:0},d,g;return n});