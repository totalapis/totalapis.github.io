// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/_base/lang ../../../../Color ../../../../core/screenUtils ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./graphicUtils ../support/FastSymbolUpdates ./objectResourceUtils ../../lib/glMatrix ../../../../symbols/ObjectSymbol3DLayer ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/materials/Material".split(" "),
function(h,m,J,z,A,B,u,C,K,q,r,v,D,E,L,n,l,M,f,N){var y=E.mat4d,F=E.vec3d,w=[1,1,1],x=[1,1,1,1],G=[0,0,0];h=[-.5,-.5,-.5,.5,.5,.5];m=[-.5,-.5,0,.5,.5,1];var H={sphere:h,cube:h,cylinder:m,cone:m,"inverted-cone":m,tetrahedron:[-.5,-.5,0,.5,.5,.5],diamond:h},I=[l.ModelContentType.MATERIAL,l.ModelContentType.TEXTURE,l.ModelContentType.GEOMETRY];u=function(h){function c(){return null!==h&&h.apply(this,arguments)||this}J(c,h);c.prototype._prepareResources=function(){var a=this.symbol,d=this._getStageIdHint();
if(!this._isPropertyDriven("size")){var b=r.validateSymbolLayerSize(this.symbol);if(b){this._logWarning(b);this.reject();return}}a.resource&&a.resource.href?this._prepareModelResources(a.resource.href,d):this._preparePrimitiveResources(a.resource?a.resource.primitive:"sphere",d)};c.prototype._preparePrimitiveResources=function(a,d){var b=this.symbol;if("sphere"===a)this._geometryData=f.createPolySphereGeometry(.5,2,!0);else if("cube"===a)this._geometryData=f.createBoxGeometry(1);else if("cylinder"===
a)this._geometryData=f.createCylinderGeometry(1,.5,32,[0,0,1],[0,0,.5]);else if("cone"===a)this._geometryData=f.createConeGeometry(1,.5,15,!1),f.cgToGIS(this._geometryData);else if("inverted-cone"===a)this._geometryData=f.createConeGeometry(1,.5,15,!0),f.cgToGIS(this._geometryData);else if("tetrahedron"===a)this._geometryData=f.createTetrahedronGeometry(1),f.cgToGIS(this._geometryData);else if("diamond"===a)this._geometryData=f.createDiamondGeometry(1),f.cgToGIS(this._geometryData);else{this._logWarning("Unknown object symbol primitive: "+
a);this.reject();return}this._geometry=new M(this._geometryData,d);this._context.stage.add(l.ModelContentType.GEOMETRY,this._geometry);this._resourceBoundingBox=H[a];this._resourceSize=n.size(this._resourceBoundingBox);this._symbolSize=r.computeSizeWithResourceSize(this._resourceSize,b);a=this._getMaterialOpacity();a={specular:[0,0,0],shininess:3,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:w,diffuse:w};var e=this.symbolContainer;if("point-symbol-3d"===
e.type&&e.verticalOffset){var e=e.verticalOffset,p=e.minWorldLength,c=e.maxWorldLength;a.verticalOffset={screenLength:B.pt2px(e.screenLength),minWorldLength:p||0,maxWorldLength:null!=c?c:Infinity};a.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._isPropertyDriven("color")?a.externalColor=x:(e=b.material?A.toUnitRGBA(b.material.color):x,a.externalColor=e);b.material&&b.material.colorMixMode&&(a.colorMixMode=
b.material.colorMixMode);this._fastUpdates=v.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(z.mixin(a,this._fastUpdates.materialParameters),a.instanced.push("featureAttribute")):this._hasPerInstanceColor()&&a.instanced.push("color");this._material=new N(a,d+"_objectmat");this._context.stage.add(l.ModelContentType.MATERIAL,this._material);this.resolve()};c.prototype._prepareModelResources=
function(a,d){var b=this,e=["transformation"];d={materialParamsMixin:{instanced:e},idHint:d,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=v.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(z.mixin(d.materialParamsMixin,this._fastUpdates.materialParameters),e.push("featureAttribute")):this._hasPerInstanceColor()&&e.push("color");e=this.symbolContainer;if("point-symbol-3d"===
e.type&&e.verticalOffset){var e=e.verticalOffset,c=e.minWorldLength,g=e.maxWorldLength;d.materialParamsMixin.verticalOffset={screenLength:B.pt2px(e.screenLength),minWorldLength:c||0,maxWorldLength:null!=g?g:Infinity};d.materialParamsMixin.castShadows=!1}this._symbolLoaderPromise=D.fetch(a,d);this._symbolLoaderPromise.then(function(a){b._symbolLoaderPromise=null;if(!b.isRejected()){var d=b._context,e=a.stageResources,c=d.stage,p=b._getExternalColorParameters(b.symbol.material),g=b._getMaterialOpacity(),
f=b._isPropertyDriven("opacity"),h=e[l.ModelContentType.MATERIAL];a.originalMaterialOpacities=Array(h.length);h.forEach(function(b,e){var c=b.getParameterValues();b.setParameterValues(p);a.originalMaterialOpacities[e]=c.opacity;c.opacity*=g;c.transparent=1>c.opacity;b.setParameterValues({opacity:c.opacity,transparent:c.transparent||f});d.screenSizePerspectiveEnabled&&(c.screenSizePerspective=d.sharedResources.screenSizePerspectiveSettings,b.setParameterValues({screenSizePerspective:c.screenSizePerspective}))});
I.forEach(function(a){for(var b=e[a],d=0;b&&d<b.length;d++)c.add(a,b[d])});b._resourceBoundingBox=D.computeBoundingBox(a);b._resourceSize=n.size(b._resourceBoundingBox);b._pivotOffset=a.pivotOffset;b._symbolSize=r.computeSizeWithResourceSize(b._resourceSize,b.symbol);b._i3sModel=a;v.updateFastSymbolUpdatesState(b._fastUpdates,b._context.renderer,b._fastVisualVariableConvertOptions())&&h.forEach(function(a){return a.setParameterValues(b._fastUpdates.materialParameters)});b.resolve()}},function(){b._symbolLoaderPromise=
null;b.isFulfilled()||b.reject()})};c.prototype._forEachMaterial=function(a){this._i3sModel?this._i3sModel.stageResources[l.ModelContentType.MATERIAL].forEach(a):a(this._material)};c.prototype._getExternalColorParameters=function(a){var d={};a&&a.colorMixMode&&(d.colorMixMode=a.colorMixMode);this._isPropertyDriven("color")?d.externalColor=x:a&&a.color?d.externalColor=A.toUnitRGBA(a.color):(d.externalColor=x,d.colorMixMode="ignore");return d};c.prototype.destroy=function(){this.isFulfilled()||this.reject();
this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var a=this._context.stage;if(this._i3sModel){var d=this._i3sModel.stageResources;I.forEach(function(b){for(var e=d[b],c=0;e&&c<e.length;c++)a.remove(b,e[c].getId())})}else this._material&&a.remove(l.ModelContentType.MATERIAL,this._material.getId()),this._geometry&&a.remove(l.ModelContentType.GEOMETRY,this._geometry.getId())};c.prototype._getGeometry=function(a){a=a.geometry;return"polyline"===a.type?q.placePointOnPolyline(a):"polygon"===
a.type?q.placePointOnPolygon(a):"extent"===a.type?a.center:"point"!==a.type?(this._logWarning("unsupported geometry type for object symbol: "+a.type),null):a};c.prototype.createGraphics3DGraphic=function(a,d){var b=this._getGeometry(a);if(null===b)return null;var e="graphic"+a.uid,c=this.getGraphicElevationInfo(a);return this._createAs3DShape(a,b,d,c,e,a.uid)};c.prototype.layerPropertyChanged=function(a,d,b){var c=this;if("opacity"===a){var p=this._isPropertyDriven("opacity");if(this._i3sModel){var g=
this._getMaterialOpacity();this._i3sModel.stageResources[l.ModelContentType.MATERIAL].forEach(function(a,b){b=c._i3sModel.originalMaterialOpacities[b]*g;a.setParameterValues({opacity:b,transparent:1>b||p})})}else d=this._getMaterialOpacity(),this._material.setParameterValues({opacity:d,transparent:1>d||p});return!0}if("elevationInfo"===a){this._updateElevationInfo();for(var f in d){var k=d[f];if(a=b(k))k=this.getGraphicElevationInfo(k.graphic),a.needsElevationUpdates=q.needsElevationUpdates3D(k.mode),
a.elevationInfo.set(k)}return!0}return!1};c.prototype.applyRendererDiff=function(a,d,b,c){var e=this,g;for(g in a.diff)switch(g){case "visualVariables":if(v.updateFastSymbolUpdatesState(this._fastUpdates,d,this._fastVisualVariableConvertOptions()))this._forEachMaterial(function(a){return a.setParameterValues(e._fastUpdates.materialParameters)});else return!1;break;default:return!1}return!0};c.prototype._createAs3DShape=function(a,d,b,c,f,g){var e=this,k=null,h=null;if(a=this._getFastUpdateAttrValues(a))k=
k||{},k.featureAttribute=a,h=function(a){return v.evaluateModelTransform(e._fastUpdates.materialParameters,k.featureAttribute,a)};!this._fastUpdates.enabled&&this._hasPerInstanceColor()&&(k=k||{},k.color=r.mixinColorAndOpacity(b.color,b.opacity));a=this._context.layer.id;var t=y.identity();this._applyObjectRotation(b,t);this._applyObjectRotation(this.symbol,t);this._applyObjectScale(b,t);this._applyAnchor(t);if(this._i3sModel){b=this._i3sModel.stageResources[l.ModelContentType.GEOMETRY];for(var p=
this._i3sModel.materialsByComponent,n=Array(b.length),m=0;m<t.length;m++)n[m]=t;f=q.createStageObjectForPoint.call(this,d,b,p,n,k,c,f,a,g,null,h)}else f=q.createStageObjectForPoint.call(this,d,[this._geometry],[[this._material]],[t],k,c,f,a,g,null,h);if(null===f)return null;if(this._fastUpdates.enabled){var u=v.getMaterialParams(this._fastUpdates.visualVariables,this._fastVisualVariableConvertOptions());this._forEachMaterial(function(a){return a.setParameterValues(u)})}f.object.setCastShadow(!0);
g=new C(this,f.object,null,null,null,K.perObjectElevationAligner,c,C.VisibilityModes.REMOVE_OBJECT);g.alignedTerrainElevation=f.terrainElevation;g.needsElevationUpdates=q.needsElevationUpdates3D(c.mode);q.extendPointGraphicElevationInfo(g,d,this._context.elevationProvider);return g};c.prototype._applyObjectScale=function(a,d){this._fastUpdates.enabled&&this._fastUpdates.customTransformation||(a=this._isPropertyDriven("size")&&a.size?a.size:this._symbolSize,a=r.computeObjectScale(a,this._symbolSize,
this._resourceSize,this._context.renderCoordsHelper.unitInMeters),1===a[0]&&1===a[1]&&1===a[2]||y.scale(d,a))};c.prototype._applyObjectRotation=function(a,d){if(!(this._fastUpdates.enabled&&this._fastUpdates.customTransformation&&a instanceof L))return r.computeObjectRotation(a.heading,a.tilt,a.roll,d)};c.prototype._computeAnchor=function(){switch(this.symbol.anchor){case "center":return F.scale(n.center(this._resourceBoundingBox),-1);case "bottom":var a=n.center(this._resourceBoundingBox);return[-a[0],
-a[1],-this._resourceBoundingBox[2]];default:return this._pivotOffset?F.scale(this._pivotOffset,-1,Array(3)):G}};c.prototype._applyAnchor=function(a){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var d=this._computeAnchor();d&&y.translate(a,d)}};c.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};c.prototype._supportsShaderVisualVariables=function(){return this._context.stage.has("angleInstancedArrays")?!0:
!1};c.prototype._fastVisualVariableConvertOptions=function(){var a=this._resourceBoundingBox?n.size(this._resourceBoundingBox):w,d=this._resourceBoundingBox?this._computeAnchor():G,b=this._context.renderCoordsHelper.unitInMeters,c=r.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,b);return{modelSize:a,symbolSize:this._symbolSize||w,unitInMeters:b,transformation:{anchor:d,scale:c,rotation:[this.symbol.tilt||0,this.symbol.roll||0,this.symbol.heading||0]}}};return c}(u);u.PRIMITIVE_BOUNDING_BOX=
H;return u});