// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports dojo/promise/all ../../../../core/HandleRegistry ../../../../core/watchUtils ../../../../layers/support/LabelClass ../../../../symbols/callouts/calloutUtils ../../webgl-engine/lib/TextTextureAtlas ../../webgl-engine/lib/MaterialCollection ./Graphics3DWebStyleSymbol ./Graphics3DCalloutSymbolLayerFactory ./labelPlacement ../../support/debugFlags".split(" "),function(z,A,p,q,r,l,t,u,m,v,w,x,y){return function(){function b(){this.calloutMaterialCollection=this.hudMaterialCollection=
this.textTextureAtlas=null;this.labelVisibilityDirty=!1;this.labelClasses=[];this.eventHandles=new q;this.graphicsCore=this.layer=this.layerView=null}b.prototype.initialize=function(c,a,b,g){var f=this;this.layerView=c;this.layer=a;this.graphicsCore=b;this.scaleVisibility=g;this.eventHandles.add(r.whenNot(this.layerView,"suspended",function(){return f.resume()}))};b.prototype.destroy=function(){this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&
(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelClasses=null;this.eventHandles.destroy();this.graphicsCore=this.layer=this.layerView=this.eventHandles=null};b.prototype.clear=function(){this.layerView.view.deconflictor.setDirty();this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),
this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null)};b.prototype.updateLabelingInfo=function(){var c=this;this.removeLabels();return this.layer.then(function(){c.scaleVisibility&&c.scaleVisibility.updateScaleRangeActive();var a=c.layer.labelingInfo&&c.layer.labelingInfo.filter(function(a){return!!a.symbol});if(a&&0<a.length){var b=Array(a.length),a=a.map(function(a,f){var e=a.symbol,d;d=c.graphicsCore.getOrCreateGraphics3DSymbol(e);
d=d instanceof v?d.graphics3DSymbol:d;var g=null;t.isCalloutSupport(e)&&e.hasVisibleCallout()&&(g=w.make(e,c.graphicsCore.symbolCreationContext));b[f]={labelClass:a,graphics3DSymbol:d,graphics3DCalloutSymbolLayer:g,options:a.getOptions()};return d});return p(a).then(function(){return b})}return null}).then(function(a){c.labelClasses=a;c.labelVisibilityChanged()})};b.prototype.createLabelsForGraphic=function(c,a){var b=!1;if(this.labelClasses&&0!==this.labelClasses.length&&a._graphics[0]){for(var g=
this.layerLabelsEnabled(),f=0;f<this.labelClasses.length;f++){var e=this.labelClasses[f],d=e.labelClass;if(l.evaluateWhere(d.where,c.attributes)&&(d=d.getLabelExpression(),d.expression)){var n=l.buildLabelText(d.expression,c,this.layer.fields,e.options);if(n){d=null;e.graphics3DSymbol&&e.graphics3DSymbol.symbol&&"label-symbol-3d"===e.graphics3DSymbol.symbol.type&&(d=e.graphics3DSymbol.symbol);var k=e.graphics3DSymbol.childGraphics3DSymbols[0],h=x.get({graphic:c,graphics3DGraphic:a,labelSymbol:d,labelClass:e.labelClass});
if(h.isValid){null==this.textTextureAtlas&&(this.textTextureAtlas=new u(this.layer.id,this.layerView.view._stage));null==this.hudMaterialCollection&&(this.hudMaterialCollection=new m(this.layerView.view._stage));f={text:n,centerOffset:h.centerOffset,translation:h.translation,elevationOffset:h.elevationOffset,screenOffset:h.screenOffset,anchor:h.anchor,needsOffsetAdjustment:h.needsOffsetAdjustment,centerOffsetUnits:h.centerOffsetUnits,verticalOffset:h.verticalOffset,debugDrawBorder:y.LABELS_SHOW_BORDER};
if(k=k.createGraphics3DGraphic(c,f,this.hudMaterialCollection,this.textTextureAtlas))k._labelClass=e.labelClass,a.addLabelGraphic(k,this.graphicsCore.labelStageLayer,this.graphicsCore.stage),a.setVisibilityFlag(0,g,1),a.setVisibilityFlag(1,void 0,1),this.layerView.view.deconflictor.initializeLabelVisibility(a),b=!0,e.graphics3DCalloutSymbolLayer&&h.hasLabelVerticalOffset&&(null==this.calloutMaterialCollection&&(this.calloutMaterialCollection=new m(this.layerView.view._stage)),(g=e.graphics3DCalloutSymbolLayer.createGraphics3DGraphic(c,
{symbol:d,needsOffsetAdjustment:h.needsOffsetAdjustment,translation:f.translation,elevationOffset:f.elevationOffset,screenOffset:f.screenOffset,centerOffset:f.centerOffset,centerOffsetUnits:f.centerOffsetUnits,materialCollection:this.calloutMaterialCollection}))&&a.addLabelGraphic(g,this.graphicsCore.labelStageLayer,this.graphicsCore.stage));break}}}}b&&this.scaleVisibility&&this.scaleVisibility.updateGraphicLabelScaleVisibility(c,a)}};b.prototype.layerLabelsEnabled=function(){return this.layer.labelsVisible};
b.prototype.getGraphics3DGraphics=function(){return this.graphicsCore.getGraphics3DGraphics()};b.prototype.getGraphics3DGraphicsKeys=function(){return this.graphicsCore.getGraphics3DGraphicsKeys()};b.prototype.labelVisibilityChanged=function(){var c=this;if(this.layerView.suspended)this.labelVisibilityDirty=!0;else if(this.layerView.loadedGraphics){var a=this.layerLabelsEnabled();this.layerView.loadedGraphics.forEach(function(b){var g=c.graphicsCore.getGraphics3DGraphicById(b.uid);g&&(a&&0===g._labelGraphics.length&&
c.createLabelsForGraphic(b,g),g.setVisibilityFlag(0,a,1))});this.layerView.view.deconflictor.setDirty();this.labelVisibilityDirty=!1}};b.prototype.elevationInfoChange=function(){this.labelClasses&&this.labelClasses.forEach(function(b){b.graphics3DSymbol.layerPropertyChanged("elevationInfo",{})})};b.prototype.resume=function(){this.labelVisibilityDirty&&this.labelVisibilityChanged()};b.prototype.removeLabels=function(){var b=this;this.layerView.loadedGraphics&&(this.layerView.loadedGraphics.forEach(function(a){if(a=
b.graphicsCore.getGraphics3DGraphicById(a.uid))a._labelGraphics&&a._labelGraphics.forEach(function(a){return a._labelClass=null}),a.clearLabelGraphics()}),this.labelClasses=null,this.layerView.view.deconflictor.setDirty())};return b}()});