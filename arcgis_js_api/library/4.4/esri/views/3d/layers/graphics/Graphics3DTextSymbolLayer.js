// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/screenUtils ../../../../symbols/callouts/calloutUtils ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./graphicUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextTexture ../../webgl-engine/materials/HUDMaterial".split(" "),function(O,P,x,C,y,F,z,G,H,g,A,I,J,K,D){var E=[1,1,1,1],L=[0,0,1],B={mode:"relative-to-ground",
offset:0},M=[0,0,0,1];return function(n){function c(){var a=null!==n&&n.apply(this,arguments)||this;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1};return a}x(c,n);c.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var a=A.validateSymbolLayerSize(this._getTextSize());if(a){this._logWarning(a);this.reject();return}}this._anchor="center";this.resolve()};c.prototype.destroy=function(){this.isFulfilled()||this.reject()};c.prototype.createGraphics3DGraphic=
function(a,b,c,p){var e="polyline"===a.geometry.type,g=this._getGeometry(a);if(!g)return this._logWarning("unsupported geometry type for text symbol: "+a.geometry.type),null;var k=this._context.layer.id+"_label_"+a.uid,d=b.text||this.symbol.text;if(!d||1>d.length)return null;b&&null!=b.needsOffsetAdjustment&&(this._elevationOptions.needsOffsetAdjustment=b.needsOffsetAdjustment);var r=this.getGraphicElevationInfo(a,b.elevationOffset||0);return this._createAs3DShape(this.symbol,g,d,r,k,a.uid,b,c,p,
e)};c.prototype.getGraphicElevationInfo=function(a,b){void 0===b&&(b=0);a=n.prototype.getGraphicElevationInfo.call(this,a);b&&(a.offset+=b);return a};c.prototype._getGeometry=function(a){a=a.geometry;return"polyline"===a.type?g.placePointOnPolyline(a):"polygon"===a.type?g.placePointOnPolygon(a):"extent"===a.type?a.center:"point"!==a.type?null:a};c.prototype.layerPropertyChanged=function(a,b,c){if("opacity"===a)this._logWarning("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");
else if("elevationInfo"===a){this._updateElevationInfo();if(b)for(var g in b){a=b[g];var e=c(a);e&&this.updateGraphicElevationInfo(a.graphic,e)}return!0}return!1};c.prototype.updateGraphicElevationInfo=function(a,b){a=this.getGraphicElevationInfo(a,b.metadata.elevationOffset);b.elevationInfo.set(a);b.needsElevationUpdates=g.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode};c.prototype._defaultElevationInfoNoZ=function(){return B};c.prototype._createAs3DShape=function(a,b,c,p,e,n,k,d,r,
h){var q=k.centerOffset||M,m=k.screenOffset||[0,0],t=k.debugDrawBorder||!1,x=k.translation||[0,0,0],u=k.anchor||this._anchor||"center";this._anchor=u;var v=a.material?C.toUnitRGBA(a.material.color):E,l=a.halo&&a.halo.color&&0<a.halo.size,z=l?C.toUnitRGBA(a.halo.color):E,w=l?y.pt2px(a.halo.size):0,A=this._getTextSize(a),l=null!=r;a=new K(c,{size:A,color:v,font:{family:a.font&&a.font.family?a.font.family:"Arial",weight:a.font&&a.font.weight?a.font.weight:"normal",style:a.font&&a.font.style?a.font.style:
"normal"},halo:{size:w,color:z},usedInAtlas:l},e);var v=l?r.addTextTexture(a):null,f;d?f=k:F.isCalloutSupport(this.symbolContainer)&&this.symbolContainer.hasVisibleVerticalOffset()&&(f=this.symbolContainer);m={textureId:l?v.texture.getId():a.getId(),texCoordScale:a.getTexcoordScale(),occlusionTest:!0,screenOffset:m,anchorPos:u,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:k.centerOffsetUnits,debugDrawBorder:t,drawInSecondSlot:!0};f&&f.verticalOffset&&(f=f.verticalOffset,t=f.minWorldLength,u=
f.maxWorldLength,m.verticalOffset={screenLength:y.pt2px(f.screenLength),minWorldLength:t||0,maxWorldLength:null!=u?u:Infinity});this._context.screenSizePerspectiveEnabled&&(f=this._context.sharedResources,t=f.screenSizePerspectiveSettings,m.screenSizePerspective=f.screenSizePerspectiveSettingsLabels.overridePadding(w),m.screenSizePerspectiveAlignment=t);h&&(m.shaderPolygonOffset=1E-4);h=null;w=JSON.stringify(m);null!=d?(h=d.getMaterial(w),null==h?(h=new D(m,e),d.addMaterial(w,h)):l&&h.setTextureDirty()):
h=new D(m,e);l=[h];h=[a.getTextWidth(),a.getTextHeight()];q=J.createPointGeometry(L,x,void 0,h,q,v?v.uvMinMax:null);q=[new I(q,e)];e=g.createStageObjectForPoint.call(this,b,q,[l],null,null,p,e,this._context.layer.id,n,!0);d=new G(this,e.object,q,null==d?l:null,null==r?[a]:null,H.perObjectElevationAligner,p);d.alignedTerrainElevation=e.terrainElevation;d.needsElevationUpdates=g.needsElevationUpdates2D(p.mode)||"absolute-height"===p.mode;var B=a.getWidth(),N=a.getHeight();d.getScreenSize=function(a){void 0===
a&&(a=Array(2));a[0]=B;a[1]=N;return a};d.metadata={labelText:c,elevationOffset:k.elevationOffset||0};g.extendPointGraphicElevationInfo(d,b,this._context.elevationProvider);return d};c.prototype._getTextSize=function(a){return y.pt2px((a||this.symbol).size)||12};return c}(z)});