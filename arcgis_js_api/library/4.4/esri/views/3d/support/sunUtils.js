// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define(["./mathUtils","../lib/glMatrix","../lib/SunCalc"],function(w,v,u){var q=v.vec3d,n=v.mat4d,I=w.lerp,M=n.identity(),d={azimuth:0,altitude:0},J={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8E5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1E4,globalAltitude:1E6,globalAngles:{azimuth:Math.PI/3,altitude:Math.PI/3}}},m={ambient:{color:q.create(),intensity:0},diffuse:{color:q.create(),intensity:0,
direction:q.create()}},x={settings:J,computeDirection:function(g,e,h,a){a||(a=q.create());var l=n.identity(M);if("global"===h)u.getPosition(g,0,0,d),q.set3(0,0,-1,a),n.rotateX(l,-d.azimuth),n.rotateY(l,-d.altitude);else{var c=x.settings.planarDirection;h=c.globalAngles;c=(e.z-c.localAltitude)/(c.globalAltitude-c.localAltitude);c=w.clamp(c,0,1);1>c?(u.getPosition(g,e.y,e.x,d),d.azimuth=(1-c)*d.azimuth+c*h.azimuth,d.altitude=(1-c)*d.altitude+c*h.altitude):(d.azimuth=h.azimuth,d.altitude=h.altitude);
q.set3(0,-1,0,a);n.rotateZ(l,-d.azimuth);n.rotateX(l,-d.altitude)}n.multiplyVec3(l,a);return a},computeShadowsEnabled:function(g,e){return"global"===e?!0:g.z<x.settings.planarDirection.localAltitude},computeColorAndIntensity:function(g,e){var h,a,l,c=e.z;a=x.settings;q.set3(1,1,1,m.ambient.color);m.ambient.intensity=a.global.ambient;q.set3(1,1,1,m.diffuse.color);m.diffuse.intensity=a.global.diffuse;c=(c-a.local.altitude)/(a.global.altitude-a.local.altitude);c=w.clamp(c,0,1);m.globalFactor=c;e=u.getTimes(g,
e.y,e.x);if(1>c){a=g.valueOf();var p,f;e.polarException===u.POLAR_EXCEPTION.MIDNIGHT_SUN?(p=a-36E5*(g.getHours()+48)-6E4*g.getMinutes(),f=p+432E6):e.polarException===u.POLAR_EXCEPTION.POLAR_NIGHT?(p=a-2,f=a-1):(p=e.sunrise.valueOf(),f=e.sunset.valueOf());var d=f-p;l=p+d/2;var r=d/4;h=l-r;var r=l+r,b=.06*d,d=p-b/2;p+=b/2;var n=f-b/2,E=f+b/2;f=J.local;var F=[.01,f.ambientAtNight],G=[.8,.8,1],H=[.01,.01,.01],y=[f.diffuseAtTwilight,f.ambientAtTwilight],z=[1,.75,.75],A=[.8,.8,1],B=[.9*f.diffuseAtNoon,
f.ambientAtNoon],C=[1,.98,.98],D=[.98,.98,1],v=[f.diffuseAtNoon,f.ambientAtNoon],K=[1,1,1],L=[1,1,1];f=[0,0];var t=[0,0],b=[0,0];a<d||a>E?(f=F,t=H,b=G):a<p?(b=p-d,f=k(a-d,b,F,y),t=k(a-d,b,H,z),b=k(a-d,b,G,A)):a<h?(b=h-p,f=k(a-p,b,y,B),t=k(a-p,b,z,C),b=k(a-p,b,A,D)):a<l?(b=l-h,f=k(a-h,b,B,v),t=k(a-h,b,C,K),b=k(a-h,b,D,L)):a<r?(b=r-l,f=k(a-l,b,v,B),t=k(a-l,b,K,C),b=k(a-l,b,L,D)):a<n?(b=n-r,f=k(a-r,b,B,y),t=k(a-r,b,C,z),b=k(a-r,b,D,A)):a<E&&(b=E-n,f=k(a-n,b,y,F),t=k(a-n,b,z,H),b=k(a-n,b,A,G));a=f[0];
l=t;h=f[1];q.lerp(b,m.ambient.color,c,m.ambient.color);m.ambient.intensity=I(h,m.ambient.intensity,c);q.lerp(l,m.diffuse.color,c,m.diffuse.color);m.diffuse.intensity=I(a,m.diffuse.intensity,c)}c=g.valueOf();e.polarException===u.POLAR_EXCEPTION.MIDNIGHT_SUN?(g=c-36E5*(g.getHours()+48)-6E4*g.getMinutes(),e=g+432E6):e.polarException===u.POLAR_EXCEPTION.POLAR_NIGHT?(g=c-2,e=c-1):(g=e.sunrise.valueOf(),e=e.sunset.valueOf());g=1-w.clamp(Math.abs(c-(g+(e-g)/2))/432E5,0,1);m.noonFactor=g;return m}},k=function(d,
e,h,a){for(var g=[],c=0;c<h.length;c++)g[c]=(a[c]-h[c])*d/e+h[c];return g};return x});