// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ./Evented ../../../core/HandleRegistry ../../../core/throttle ../lib/glMatrix ../webgl-engine/lib/Selector ./earthUtils".split(" "),function(d,e,m,n,p,g,q,k){Object.defineProperty(e,"__esModule",{value:!0});d=function(){function a(b){this.view=b;this.handles=new n;this.throttledMeasureSurfaceAltitude=p.default(this.measureSurfaceAltitude,this.updateDistanceToSurface,r,this);this.latestSurfaceAltitude=this.currentSurfaceAltitude=0;this.events=new m.Evented;this.fovY=this.distanceToSurface=
0;this.selector=new q(b.viewingMode);this.selector.enableBackfacesTerrain=!1;this.selector.enableInvisibleTerrain=!1;this.handles.add([this.view.navigation.on("currentViewChanged",this.throttledMeasureSurfaceAltitude),this.throttledMeasureSurfaceAltitude]);this.measureSurfaceAltitude()}a.prototype.destroy=function(){this.handles.destroy()};a.prototype.forceUpdate=function(){this.throttledMeasureSurfaceAltitude.forceUpdate();this.updateDistanceToSurface()};a.prototype.updateLatestSurfaceAltitude=function(){var b=
this.view.navigation.currentCamera;this.view.basemapTerrain&&(this.selector.init(null,b.eye,b.center,null,b,null,!1),this.view.basemapTerrain.intersect(this.selector,b.eye,b.center),this.selector.minResult.getIntersectionPoint(f)&&(this.latestSurfaceAltitude=this.view.renderCoordsHelper.getAltitude(f)))};a.prototype.measureSurfaceAltitude=function(){this.updateLatestSurfaceAltitude();this.updateDistanceToSurface()};a.prototype.updateDistanceToSurface=function(){var b=this.fovY!==this.view.navigation.currentCamera.fovY;
this.fovY=this.view.navigation.currentCamera.fovY;var c=this.calculateDistanceToSurface(),h=0<=c,a=this.currentSurfaceAltitude!==this.latestSurfaceAltitude;!h&&a&&(c=this.calculateDistanceToSurface(this.latestSurfaceAltitude),h=0<=c)&&(this.currentSurfaceAltitude=this.latestSurfaceAltitude);a=this.latestSurfaceAltitudeChangesDistanceSignificantly(c);0<=a&&(c=a,h=!0,this.currentSurfaceAltitude=this.latestSurfaceAltitude);h&&this.distanceToSurface!==c?(this.distanceToSurface=c,this.emitDistanceToSurfaceChanged()):
b&&this.emitDistanceToSurfaceChanged()};a.prototype.emitDistanceToSurfaceChanged=function(){l.distanceToSurface=this.distanceToSurface;this.events.emit("distanceToSurfaceChanged",l)};a.prototype.calculateDistanceToSurface=function(b){void 0===b&&(b=this.currentSurfaceAltitude);var c=this.view.navigation,a=c.currentCamera;if(c.intersectManifold(a.eye,a.viewForward,b,f)){var d=g.vec3d.dist(a.eye,f);if("global"===this.view.viewingMode){var e=k.earthRadius+b;if(g.vec3d.length2(a.eye)<e*e&&d>k.earthRadius/
4)return c.intersectManifold(a.eye,a.viewUp,b,f)?g.vec3d.dist(a.eye,f):-1}return d}return-1};a.prototype.latestSurfaceAltitudeChangesDistanceSignificantly=function(a){if(this.latestSurfaceAltitude===this.currentSurfaceAltitude||0>a)return-1;var b=this.calculateDistanceToSurface(this.latestSurfaceAltitude);return 0<b&&Math.abs(b-a)/a>t?b:-1};return a}();e.FocusTracker=d;var f=g.vec3d.create(),l={distanceToSurface:0},t=.05,r=3E3;e.default=d});