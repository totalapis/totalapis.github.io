// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require ../core/promiseUtils dojo/_base/array dojo/on dojo/Deferred dojo/promise/all ../layers/support/layerUtils ../geometry/support/scaleUtils ../geometry/Extent ../tasks/support/Query ../layers/GroupLayer ../core/Accessor".split(" "),function(H,x,k,D,z,I,E,F,J,K,G,L){var A;return L.createSubclass({declaredClass:"esri.views.PopupManager",properties:{map:{dependsOn:["view.map"],readOnly:!0}},constructor:function(){this._featureLayersCache={}},destroy:function(){this._featureLayersCache={};
this.view=null},_clickHandle:null,_featureLayersCache:null,enabled:!1,_enabledSetter:function(b){this._clickHandle&&(b?this._clickHandle.resume():this._clickHandle.pause());this._set("enabled",b)},_mapGetter:function(){return this.get("view.map")||null},view:null,_viewSetter:function(b){this._clickHandle&&(this._clickHandle.remove(),this._clickHandle=null);b&&(this._clickHandle=D.pausable(b,"click",this._clickHandler.bind(this)),this.enabled||this._clickHandle.pause());this._set("view",b)},getMapLayer:function(b){var a;
if(b&&(a=b.findLayerById())&&(b=a.id,this._featureLayersCache[b])){var e=b.lastIndexOf("_");-1<e&&(b=b.substring(0,e),a=this.map.findLayerById(b))}return a},_closePopup:function(){var b=this.get("view.popup");b&&(b.clear(),b.close())},_showPopup:function(b,a){function e(a){return h.allLayerViews.find(function(y){return y.layer===a})}function c(a){if(null==a)return!1;var b=e(a);return null==b?!1:a.loaded&&!b.suspended&&(a.popupEnabled&&a.popupTemplate||"graphics"===a.type||b.getPopupData)}function B(a){return(a=
e(a))&&a.hasDraped}var h=this.view,w=h.popup,t=this,f=[],d="3d"===h.type;k.forEach(this.map.layers.toArray(),function(a){a.isInstanceOf(G)?k.forEach(a.layers.toArray(),function(a){!c(a)||d&&!B(a)||f.push(a)}):!c(a)||d&&!B(a)||f.push(a)});0<h.graphics.length&&f.push(h.graphics);!a||a.popupTemplate||c(a.layer)||(a=null);if(f.length||a){var n=[],q=!!a,u=t._calculateClickTolerance(f),m=b.mapPoint;if(m){var v=1;h.state&&(v=h.state.resolution);var l=h.basemapTerrain;l&&l.overlayManager&&(v=l.overlayManager.overlayPixelSizeInMapUnits(m));
u*=v;l&&!l.spatialReference.equals(h.spatialReference)&&(u*=F.getUnitValueForSR(l.spatialReference)/F.getUnitValueForSR(h.spatialReference));var l=m.clone().offset(-u,-u),m=m.clone().offset(u,u),p=new J(Math.min(l.x,m.x),Math.min(l.y,m.y),Math.max(l.x,m.x),Math.max(l.y,m.y),h.spatialReference),m=function(c){var g;if("imagery"===c.type){g=new K;g.geometry=b.mapPoint;var f=e(c),d={rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0};d.layerView=f;g=c.queryVisibleRasters(g,d).then(function(a){q=
q||0<a.length;return a})}else if("csv"===c.type||!t._featureLayersCache[c.id]&&"function"!==typeof c.queryFeatures){if("map-image"===c.type)return f=e(c),f.getPopupData(p);var d=[],h;"esri.core.Collection\x3cesri.Graphic\x3e"===c.declaredClass?(f=c,h=!0):"graphics"===c.type?(f=c.graphics,h=!0):(f=(f=e(c))&&f.loadedGraphics,h=!1);f&&(d=f.filter(function(a){return a&&(!h||a.popupTemplate)&&a.visible&&p.intersects(a.geometry)}).toArray());0<d.length&&(q=!0,g="scene"===c.type?t._fetchSceneAttributes(c,
d):x.resolve(d))}else f=c.createQuery(),f.geometry=p,g=c.queryFeatures(f).then(function(b){b=b.features;if(a&&a.layer===c&&c.objectIdField){var e=c.objectIdField,f=a.attributes[e];b=b.filter(function(a){return a.attributes[e]!==f})}q=q||0<b.length;return b});return g};if(d&&!a||!d)var n=f.map(m).filter(function(a){return!!a}),r=function(a){return a.reduce(function(a,b){return a.concat(b.items?r(b.items):b)},[])},n=r(n);a&&(a.layer&&"scene"===a.layer.type?n.unshift(this._fetchSceneAttributes(a.layer,
[a])):a.getEffectivePopupTemplate()&&(m=new z,n.unshift(m.resolve([a]))));k.some(n,function(a){return!a.isFulfilled()})||q?n.length&&w.open({promises:n,location:b.mapPoint}):t._closePopup()}else t._closePopup()}else t._closePopup()},_fetchSceneAttributes:function(b,a){return this.view.whenLayerView(b).then(function(e){var c=this._getOutFields(b.popupTemplate),k=a.map(function(a){return e.whenGraphicAttributes(a,c).otherwise(function(){return a})});return x.eachAlways(k)}.bind(this)).then(function(a){return a.map(function(a){return a.value})})},
_getSubLayerFeatureLayers:function(b,a){var e=a||new z,c=[];a=b.length;var B=Math.floor(this.view.extent.width/this.view.width),h=this.view.scale,w=!1,t=this,f=0;a:for(;f<a;f++){var d=b[f],n=d.dynamicLayerInfos||d.layerInfos;if(n){var q=null;d._params&&(d._params.layers||d._params.dynamicLayers)&&(q=d.visibleLayers);for(var q=E._getVisibleLayers(n,q),u=E._getLayersForScale(h,n),m=n.length,v=0;v<m;v++){var l=n[v],p=l.id,r=d.popupTemplates[p];if(!l.subLayerIds&&r&&r.popupTemplate&&-1<k.indexOf(q,p)&&
-1<k.indexOf(u,p)){if(!A){w=!0;break a}var y=d.id+"_"+p,g=this._featureLayersCache[y];g&&g.loadError||(g||((g=r.layerUrl)||(g=l.source?this._getLayerUrl(d.url,"/dynamicLayer"):this._getLayerUrl(d.url,p)),g=new A(g,{id:y,drawMode:!1,mode:A.MODE_SELECTION,outFields:this._getOutFields(r.popupTemplate),resourceInfo:r.resourceInfo,source:l.source}),this._featureLayersCache[y]=g),g.setDefinitionExpression(d.layerDefinitions&&d.layerDefinitions[p]),g.setGDBVersion(d.gdbVersion),g.popupTemplate=r.popupTemplate,
g.setMaxAllowableOffset(B),g.setUseMapTime(!!d.useMapTime),d.layerDrawingOptions&&d.layerDrawingOptions[p]&&d.layerDrawingOptions[p].renderer&&g.setRenderer(d.layerDrawingOptions[p].renderer),c.push(g))}}}}if(w){var x=new z;H(["../layers/FeatureLayer"],function(a){A=a;x.resolve()});x.then(function(){t._getSubLayerFeatureLayers(b,e)})}else{var C=[];k.forEach(c,function(a){if(!a.loaded){var b=new z;D.once(a,"load, error",function(){b.resolve()});C.push(b.promise)}});C.length?I(C).then(function(){c=
k.filter(c,function(a){return!a.loadError&&a.isVisibleAtScale(h)});e.resolve(c)}):(c=k.filter(c,function(a){return a.isVisibleAtScale(h)}),e.resolve(c))}return e.promise},_getLayerUrl:function(b,a){var e=b.indexOf("?");return-1===e?b+"/"+a:b.substring(0,e)+"/"+a+b.substring(e)},_getOutFields:function(b){var a;"esri.PopupTemplate"===b.declaredClass&&b.fieldInfos?(a=[],k.forEach(b.fieldInfos,function(b){var c=b.fieldName&&b.fieldName.toLowerCase();c&&"shape"!==c&&0!==c.indexOf("relationships/")&&a.push(b.fieldName)})):
a=["*"];return a},_calculateClickTolerance:function(b){var a=6;k.forEach(b,function(b){if(b=b.renderer)"simple"===b.type?((b=b.symbol)&&b.xoffset&&(a=Math.max(a,Math.abs(b.xoffset))),b&&b.yoffset&&(a=Math.max(a,Math.abs(b.yoffset)))):"uniqueValue"!==b.type&&"classBreaks"!==b.type||k.forEach(b.uniqueValueInfos||b.classBreakInfos,function(b){(b=b.symbol)&&b.xoffset&&(a=Math.max(a,Math.abs(b.xoffset)));b&&b.yoffset&&(a=Math.max(a,Math.abs(b.yoffset)))})});return a},_clickHandler:function(b){function a(a){return e.allLayerViews.find(function(b){return b.layer===
a})}var e=this.view,c=b.screenPoint,k=this;if(0===b.button&&e.popup&&e.ready){var h="3d"===e.type,w=e.map.allLayers.some(function(b){if(b.isInstanceOf(G))return!1;var c;null==b?c=!1:(c=a(b),c=null==c?!1:b.loaded&&!c.suspended&&(b.popupEnabled&&b.popupTemplate||"graphics"===b.type||c.getPopupData));c&&!(c=!h)&&(c=(b=a(b))&&b.hasDraped);return c?!0:!1});null!=c?this.view.hitTest(c.x,c.y).then(function(a){w||0<a.results.length?k._showPopup(b,0<a.results.length?a.results[0].graphic:null):k._closePopup()}):
k._showPopup(b)}}})});