// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper dojo/_base/lang ../core/accessorSupport/decorators ../core/HandleRegistry ../core/Logger ../core/promiseUtils ../Viewpoint ../geometry/Point ../geometry/ScreenPoint ../geometry/Extent ../geometry/SpatialReference ../geometry/support/scaleUtils ../geometry/support/webMercatorUtils ./View ./ViewAnimation ./2d/FrameTask ./2d/PaddedViewState ./2d/MapViewConstraints ./2d/AnimationManager ./2d/viewpointUtils".split(" "),
function(f,H,w,h,r,g,x,y,z,t,n,A,u,B,C,p,D,q,E,F,v,G,k){var l=y.getLogger("esri.views.MapView");f=function(f){function e(a){var b=f.call(this,a)||this;b._frameTask=new E(b);b._mapViewBaseHandles=new x;b._setup=!1;b.fullOpacity=1;b.interacting=!1;b.initialExtent=null;b.resizeAlign="center";b.type="2d";b.constraints=new v;b.padding={top:0,right:0,bottom:0,left:0};var c=function(){this._set("updating",this.layerViewManager.factory.working||this.allLayerViews.some(function(a){return!0===a.updating}))}.bind(b),
d=b._mapViewBaseHandles;d.add([b.watch("viewpoint",function(a){return b._flipStationary()},!0),b.on("resize",function(a){return b._resizeHandler(a)}),b.watch("animationManager.animation",function(a){b.animation=a}),b.allLayerViews.on("change",function(){c();d.remove("layerViewsUpdating");d.add(b.allLayerViews.map(function(a){return a.watch("updating",c)}).toArray(),"layerViewsUpdating")})]);b.watch("ready",function(a){a?b._startup():b._tearDown()});return b}w(e,f);e.prototype.destroy=function(){this.destroyed||
(this._set("ready",!1),this._mapViewBaseHandles.removeAll(),this.layerViewManager.empty(),this._frameTask.destroy(),this._tearDown(),this._gotoTask=this._mapViewBaseHandles=this._frameTask=null)};Object.defineProperty(e.prototype,"animation",{set:function(a){var b=this,c=this._get("animation");a!==c&&(c&&c.stop(),!a||a.isFulfilled()?this._set("animation",null):(this._set("animation",a),c=function(){a===b._get("animation")&&(b._set("animation",null),b._frameTask.requestFrame())},a.then(c,c,function(a){b.state&&
(b.state.viewpoint=a)})))},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"center",{get:function(){if(!this.ready)return this._get("center");var a=this.content.center;return new n({x:a[0],y:a[1],spatialReference:this.content.spatialReference})},set:function(a){if(null!=a)if(this._normalizeInput(a))if(this.ready){var b=this.viewpoint;k.centerAt(b,b,a);this.viewpoint=b}else this._set("center",a),this.notifyChange("initialExtentRequired");else l.error("#center","incompatible spatialReference "+
JSON.stringify(a.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference))},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"constraints",{set:function(a){var b=this,c=this._get("constraints");c&&(this._mapViewBaseHandles.remove("constraints"),c.destroy());this._set("constraints",a);a&&(this.ready&&(a.view=this,this.state.viewpoint=a.fit(this.content.viewpoint)),this._mapViewBaseHandles.add(a.on("update",function(){b.ready&&b.state&&(b.state.viewpoint=
a.fit(b.content.viewpoint))}),"constraints"))},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"extent",{get:function(){return this.ready?this.content.extent.clone():this._get("extent")},set:function(a){if(null!=a){var b=this._normalizeInput(a);b?b.width&&b.height?this.ready?(a=this.viewpoint,k.setExtent(a,a,b,this.size,{constraints:this.constraints}),this.viewpoint=a):(this._set("extent",b),this._set("center",null),this._set("viewpoint",null),this._set("scale",0),this._set("zoom",
-1),this.notifyChange("initialExtentRequired")):l.error("#extent","invalid extent size"):l.error("#center","incompatible spatialReference "+JSON.stringify(a.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference))}},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"initialExtentRequired",{get:function(){var a=this.extent,b=this.center,c=this.scale,d=this.viewpoint,e=this.zoom;return this.get("map.initialViewProperties.viewpoint")||a||b&&(0!==c||-1!==
e)||d?!1:!0},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"padding",{get:function(){return this.ready?this.state.padding:this._get("padding")},set:function(a){this.ready?(this.state.padding=a,this._set("padding",this.state.padding)):this._set("padding",a)},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"rotation",{get:function(){return this.ready?this.content.rotation:this._get("rotation")},set:function(a){if(!isNaN(a))if(this.ready){var b=this.viewpoint;k.rotateTo(b,
b,a);this.viewpoint=b}else this._set("rotation",a)},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"scale",{get:function(){return this.ready?this.content.scale:this._get("scale")},set:function(a){if(a&&!isNaN(a))if(this.ready){var b=this.viewpoint;k.scaleTo(b,b,a);this.viewpoint=b}else{this._set("scale",a);this._set("zoom",-1);if(a=this._get("extent"))this._set("extent",null),this._set("center",a.center);this.notifyChange("initialExtentRequired")}},enumerable:!0,configurable:!0});
Object.defineProperty(e.prototype,"stationary",{get:function(){return!this.animation&&!this.interacting&&!this._get("resizing")&&!this._stationaryTimer},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"viewpoint",{get:function(){return this.ready?this.content.viewpoint.clone():this._get("viewpoint")},set:function(a){if(null!=a){var b=this._normalizeInput(a);b?this.ready?(a=k.create(),k.copy(a,b),this.constraints.constrain(a,this.content.viewpoint),this.state.viewpoint=a,this._frameTask.requestFrame(),
this._set("viewpoint",a)):(this._set("viewpoint",b),this._set("extent",null),this._set("center",null),this._set("zoom",-1),this._set("scale",0),this.notifyChange("initialExtentRequired")):!a.scale||isNaN(a.scale)?l.error("#viewpoint","invalid scale value of "+a.scale):a.targetGeometry?l.error("#viewpoint","incompatible spatialReference "+JSON.stringify(a.targetGeometry.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference)):l.error("#viewpoint","geometry not defined")}},
enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"zoom",{get:function(){return this.ready?this.constraints.scaleToZoom(this.scale):this._get("zoom")},set:function(a){if(null!=a){if(!this.ready){this.notifyChange("initialExtentRequired");this._set("zoom",a);this._set("scale",0);var b=this._get("extent");b&&(this._set("extent",null),this._set("center",b.center))}this.constraints.effectiveLODs&&(b=this.viewpoint,k.scaleTo(b,b,this.constraints.zoomToScale(a)),this.viewpoint=b,this._set("zoom",
this.constraints.scaleToZoom(this.scale)))}},enumerable:!0,configurable:!0});e.prototype.goTo=function(a,b){if(this.ready)return b=r.mixin({animate:!0},b),a=k.createAsync(a,this),this._gotoTask={},b.animate?this._gotoAnimated(a,b):this._gotoImmediate(a,b);l.error("#goTo()","MapView cannot be used before it is ready")};e.prototype.hitTest=function(a,b){return z.reject("Should be implemented by subclasses")};e.prototype.toMap=function(a,b,c){if(!this.ready)return null;a&&null!=a.x&&(c=b,b=a.y,a=a.x);
var d=[0,0];this.state.toMap(d,[a,b]);c=c||new n;c.x=d[0];c.y=d[1];c.spatialReference=this.spatialReference;return c};e.prototype.isTileInfoRequired=function(){return!0};e.prototype.toScreen=function(a,b,c,d){if(!this.ready)return null;a&&null!=a.x&&(d=b,b=a.y,a=a.x);d=c||d||new A;a=[a,b];this.state.toScreen(a,a);d.x=a[0];d.y=a[1];return d};e.prototype.pixelSizeAt=function(a,b){if(!this.ready)return NaN;a&&null!=a.x&&(b=a.y,a=a.x);return this.content.pixelSizeAt([a,b])};e.prototype.requestLayerViewUpdate=
function(a){this.ready&&this._frameTask.requestLayerViewUpdate(a)};e.prototype.getDefaultSpatialReference=function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||null};e.prototype.isSpatialReferenceSupported=function(a,b){if(b||this._get("ready"))return!0;b=this._normalizeInput(this._get("center"),a);var c=this._normalizeInput(this._get("extent"),a),d=this._normalizeInput(this._get("viewpoint"),a),e=this._userSpatialReference,f=null,
g=null;(d=d&&d.targetGeometry)&&("extent"===d.type?f=d:"point"===d.type&&(g=d));d=this._normalizeInput(this.get("map.initialViewProperties.viewpoint.targetGeometry.extent"),a);a=this._normalizeInput(this.initialExtent,a);a=c||f||d||a;return b||g||a&&a.center?!0:(e&&l.error("The view could not be initialized with the spatialReference "+e.wkid+".","Try specifying an extent or a center and scale"),!1)};e.prototype._gotoImmediate=function(a,b){var c=this,d=this._gotoTask;!this.animation||"running"!==
this.animation.state&&"waiting-for-target"!==this.animation.state?this.animation=new q({target:a}):this.animation.target=a;a.then(function(a){d===c._gotoTask&&(c.viewpoint=c.animation.target=a,c.animation.finish())});return this.animation};e.prototype._gotoAnimated=function(a,b){var c=this;!this.animation||"running"!==this.animation.state&&"waiting-for-target"!==this.animation.state?this.animation=new q({target:a}):this.animation.target=a;var d=this.animation;d.state="waiting-for-target";a.then(function(e){d.target===
a&&c.animation===d&&(d.target=e,d.state="running",c.animationManager.animate(d,c.viewpoint,b),d.state===q.State.STOPPED&&d.stop())}).otherwise(function(){d.target===a&&c.animation===d&&(c.animation=null,d.finish())});return d};e.prototype._resizeHandler=function(a){var b=this.state;if(b){var c=this.content.viewpoint,d=this.content.size.concat();b.size=[a.width,a.height];k.resize(c,c,d,this.content.size,this.resizeAlign);c=this.constraints.constrain(c,null);this.state.viewpoint=c}};e.prototype._startup=
function(){if(!this._setup){this._setup=!0;var a=this.constraints,b=this._get("zoom"),c=this._get("scale"),d=this._normalizeInput(this._get("center")),e=this._normalizeInput(this._get("extent")),f=this._get("rotation"),g=this._normalizeInput(this._get("viewpoint"));a.view=this;a.effectiveLODs?-1!==b&&(c=a.zoomToScale(b)):b=-1;var h=null,k=null,l=0,b=g&&g.rotation,m=g&&g.targetGeometry;m&&("extent"===m.type?h=m:"point"===m.type&&(k=m,l=g.scale));g=this._normalizeInput(this.get("map.initialViewProperties.viewpoint.targetGeometry.extent"));
m=this._normalizeInput(this.initialExtent);e=e||h||g||m;d=d||k||e&&e.center;c=c||l||e&&C.getScale({width:this.size[0]},e);f=new t({targetGeometry:d,scale:c,rotation:f||b||0});a.fit(f);this._set("animationManager",new G);this._set("state",new F({padding:this._get("padding"),size:this.size,viewpoint:f}));this._set("content",this.state.content)}};e.prototype._tearDown=function(){this._setup&&(this._setup=!1,this._stationaryTimer&&(clearTimeout(this._stationaryTimer),this._stationaryTimer=null,this.notifyChange("stationary")),
this.constraints.view=null,this.animationManager.destroy(),this._set("animationManager",null),this._set("state",null),this._set("content",null),this.animation=null)};e.prototype._flipStationary=function(){var a=this;this._stationaryTimer&&clearTimeout(this._stationaryTimer);this._stationaryTimer=setTimeout(function(){a._stationaryTimer=null;a.notifyChange("stationary")},160);this.notifyChange("stationary")};e.prototype._normalizeInput=function(a,b){void 0===b&&(b=this.spatialReference);var c=a&&a.targetGeometry||
a;return b?c?b.equals(c.spatialReference)?a:p.canProject(c,b)?a&&"esri.Viewpoint"===a.declaredClass?(a.targetGeometry=p.project(c,b),a):p.project(c,b):null:null:a};return e}(g.declared(D));h([g.property()],f.prototype,"animation",null);h([g.property({readOnly:!0})],f.prototype,"animationManager",void 0);h([g.property({value:null,type:n,dependsOn:["content.center"]})],f.prototype,"center",null);h([g.property({type:v})],f.prototype,"constraints",null);h([g.property({readOnly:!0})],f.prototype,"content",
void 0);h([g.property({value:null,type:u,dependsOn:["content.extent"]})],f.prototype,"extent",null);h([g.property()],f.prototype,"fullOpacity",void 0);h([g.property({readOnly:!0})],f.prototype,"interacting",void 0);h([g.property({type:u})],f.prototype,"initialExtent",void 0);h([g.property({dependsOn:["map.initialViewProperties.viewpoint"]})],f.prototype,"initialExtentRequired",null);h([g.property({value:{top:0,right:0,bottom:0,left:0},cast:function(f){return r.mixin({top:0,right:0,bottom:0,left:0},
f)}})],f.prototype,"padding",null);h([g.property()],f.prototype,"resizeAlign",void 0);h([g.property({value:0,type:Number,dependsOn:["content.rotation"]})],f.prototype,"rotation",null);h([g.property({value:0,type:Number,dependsOn:["content.scale"]})],f.prototype,"scale",null);h([g.property({type:B,dependsOn:["map.initialViewProperties.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],f.prototype,"spatialReference",void 0);h([g.property({readOnly:!0})],f.prototype,"state",void 0);h([g.property()],
f.prototype,"stationary",null);h([g.property({readOnly:!0})],f.prototype,"type",void 0);h([g.property({value:null,type:t,dependsOn:["content.viewpoint"]})],f.prototype,"viewpoint",null);h([g.property({value:-1,dependsOn:["content.scale"]})],f.prototype,"zoom",null);return f=h([g.subclass("esri.views.MapViewBase")],f)});