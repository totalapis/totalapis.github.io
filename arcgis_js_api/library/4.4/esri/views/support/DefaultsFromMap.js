// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/accessorSupport/decorators dojo/_base/lang ../../core/lang ../../core/watchUtils ../../core/Accessor ../../core/HandleRegistry ../../geometry/HeightModelInfo".split(" "),function(c,w,m,g,f,n,p,q,r,t,u){function l(c){switch(c.type){case "elevation":case "integrated-mesh":case "point-cloud":case "scene":return!0;default:return void 0!==c.hasZ}}c=k=function(c){function d(a){a=c.call(this)||
this;a.isSpatialReferenceDone=!1;a.isHeightModelInfoDone=!1;a.isTileInfoDone=!1;a.spatialReference=null;a.extent=null;a.heightModelInfo=null;a.mapCollectionPaths=k.DefaultMapCollectionPaths.slice();a.tileInfo=null;a._handles=new t;a._waitTask=null;a._isStarted=!1;return a}m(d,c);d.prototype.normalizeCtorArgs=function(a){a=n.mixin({},a);this._set("view",a.view);delete a.view;return a};d.prototype.initialize=function(){var a=this;this.watch("mapCollectionPaths",function(){a._isStarted&&(a.reset(),a.start())})};
d.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null,this._isStarted=!1);this._cancelLoading()};d.prototype.reset=function(){this._handles.removeAll();this._isStarted=!1;this._set("isSpatialReferenceDone",!1);this._set("isHeightModelInfoDone",!1);this._set("isTileInfoDone",!1);this._set("spatialReference",null);this._set("extent",null);this._set("heightModelInfo",null);this._set("tileInfo",null)};d.prototype.start=function(){this._handles.removeAll();this._isStarted=
!0;for(var a=this._updateLayerChange.bind(this),b=0,h=this.mapCollectionPaths;b<h.length;b++)this._handles.add(q.on(this.view,"map."+h[b],"change",a,a,a))};d.prototype.supportedSpatialReferenceForLayer=function(a){if(a.spatialReference&&this.view.isSpatialReferenceSupported(a.spatialReference,a))return a.spatialReference};d.prototype._ownerNameFromCollectionName=function(a){var b=a.lastIndexOf(".");return-1===b?"view":"view."+a.slice(0,b)};d.prototype._ensureLoadedOwnersFromCollectionName=function(a){a=
this._ownerNameFromCollectionName(a).split(".");for(var b,h=0;h<a.length;h++){b=this.get(a.slice(0,h+1).join("."));if(!b)break;if(b.load&&!b.isFulfilled())return{owner:null,loading:b.load()}}return{owner:b}};d.prototype._cancelLoading=function(){this._waitTask=null};d.prototype._updateWhen=function(a){var b=this,h=!0,c=!1,e=a.always(function(){h?c=!0:e===b._waitTask&&b._update()}),h=!1;c||(this._waitTask=e);return c};d.prototype._updateLayerChange=function(){this.isSpatialReferenceDone&&!this.spatialReference&&
this._set("isSpatialReferenceDone",!1);this._update()};d.prototype._update=function(){var a=this;this._cancelLoading();if(!this.isSpatialReferenceDone){var b=this._processMapCollections(function(b){return a._processSpatialReferenceSource(b)});b||this._set("isSpatialReferenceDone",!0);this.isSpatialReferenceDone&&!this.spatialReference&&this.defaultSpatialReference&&this._set("spatialReference",this.defaultSpatialReference)}null==this.heightModelInfo&&(b=!1,this.view.isHeightModelInfoRequired()&&(b=
this._processMapCollections(function(b){return a._processHeightModelInfoSource(b)},function(a){return null!=a.layers||l(a)||void 0!==a.heightModelInfo})),b||this._set("isHeightModelInfoDone",!0));null==this.tileInfo&&(b=!1,this.view.isTileInfoRequired()&&(b=this._deriveTileInfo()),b||this._set("isTileInfoDone",!0))};d.prototype._processMapCollections=function(a,b){for(var c=0,d=this.mapCollectionPaths;c<d.length;c++){var e="map."+d[c],f=this._ensureLoadedOwnersFromCollectionName(e);if(f.loading&&
!this._updateWhen(f.loading))return!0;f=f.owner;if(!(!f||f.isRejected&&f.isRejected())&&(e=this.view.get(e))&&this._processMapCollection(e,a,b))return!0}return!1};d.prototype._processMapCollection=function(a,b,c){for(var d=0;d<a.length;d++){var e=a.getItemAt(d),f=null!=c&&!c(e);if(!f&&e.load&&!e.isFulfilled()&&!this._updateWhen(e.load())||!f&&(!e.load||e.isResolved())&&(b(e)||e.layers&&this._processMapCollection(e.layers,b)))return!0}return!1};d.prototype._processSpatialReferenceSource=function(a){var b=
a.fullExtent;a=this.supportedSpatialReferenceForLayer(a);!a&&this.extent||!b||this._set("extent",b);return a?(this._set("spatialReference",a),this._set("isSpatialReferenceDone",!0),!0):!1};d.prototype._processHeightModelInfoSource=function(a){a=a.heightModelInfo?a.heightModelInfo:(null!=a.hasZ?a.hasZ:l(a))?p.clone(v):null;return a?(this._set("heightModelInfo",a),this._set("isHeightModelInfoDone",!0),!0):!1};d.prototype._deriveTileInfo=function(){if(!this.isSpatialReferenceDone)return!0;var a=this.get("view.map");
if(!a)return!0;var b=a.basemap,c=b&&b.get("baseLayers.0"),a=a.get("layers.0"),d=!1,e=null;b?b.loaded?c?c.loaded?e=c.tileInfo:(this._updateWhen(c.load()),d=!0):a?a.loaded?e=a.tileInfo:(this._updateWhen(a.load()),d=!0):d=!0:(this._updateWhen(b.load()),d=!0):a&&(a.loaded?e=a.tileInfo:(this._updateWhen(a.load()),d=!0));e&&!e.spatialReference.equals(this.spatialReference)&&(e=null);d||this._set("tileInfo",e);return d};return d}(f.declared(r));c.DefaultMapCollectionPaths=["basemap.baseLayers","layers",
"ground.layers","basemap.referenceLayers"];g([f.property({readOnly:!0})],c.prototype,"isSpatialReferenceDone",void 0);g([f.property({readOnly:!0})],c.prototype,"isHeightModelInfoDone",void 0);g([f.property({readOnly:!0})],c.prototype,"isTileInfoDone",void 0);g([f.property({readOnly:!0})],c.prototype,"view",void 0);g([f.property({readOnly:!0})],c.prototype,"spatialReference",void 0);g([f.property({readOnly:!0})],c.prototype,"extent",void 0);g([f.property({readOnly:!0})],c.prototype,"heightModelInfo",
void 0);g([f.property()],c.prototype,"mapCollectionPaths",void 0);g([f.property()],c.prototype,"defaultSpatialReference",void 0);g([f.property({readOnly:!0})],c.prototype,"tileInfo",void 0);c=k=g([f.subclass("esri.views.support.DefaultsFromMap")],c);var v=new u({heightModel:"gravity-related-height"}),k;return c});