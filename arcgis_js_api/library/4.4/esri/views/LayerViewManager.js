// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.4/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/accessorSupport/decorators ../core/Accessor ../core/Error ../core/HandleRegistry ../core/Scheduler ../core/promiseUtils ../core/watchUtils ./LayerViewFactory".split(" "),function(f,v,n,k,g,p,l,q,r,m,t,u){f=function(f){function c(){var a=f.call(this)||this;a._promisesMap=new Map;a._layerViewsMap=new Map;a._handles=new q;a.factory=new u;a.ready=!1;a.layersToLayerViews=function(){var a=new Map;a.set("view.map.basemap.baseLayers",
"view.basemapView.baseLayerViews");a.set("view.map.ground.layers","view.groundView.layerViews");a.set("view.map.layers","view.layerViews");a.set("view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews");return a}();a._doWork=a._doWork.bind(a);a.refresh=a.refresh.bind(a);a._handles.add(t.init(a,"view.ready",function(b){return a.ready=b}));a._handles.add(a.watch(["view.map.basemap","view.map.ground","view.map.layers","ready"],a.refresh),"watcher");return a}n(c,f);c.prototype.destroy=
function(){this._handles&&(this.empty(),this.view=null,this.factory.destroy(),this.factory=null,this._handles.destroy(),this._map=this._layerViewsMap=this._promisesMap=this._handles=null)};c.prototype.empty=function(){this._layerViewsMap.forEach(this._disposeLayerView,this);this._promisesMap.forEach(function(a){return a.cancel()});this._layerViewsMap.clear();this._promisesMap.clear();this._refreshCollections()};c.prototype.refresh=function(){var a=this._handles;a.remove("refresh");a.add(r.schedule(this._doWork),
"refresh")};c.prototype.whenLayerView=function(a){this.refresh();this._doWork();return this._promisesMap.has(a)?this._promisesMap.get(a):m.reject(new l("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:a}))};c.prototype._doWork=function(){var a=this,b=this._handles,d=this.get("view.map");this._map!==d&&(this.empty(),this._map=d);if(b.has("refresh")){b.remove("refresh");b.remove("collection-change");this.factory.paused=!this.ready;var e=this._map&&this._map.allLayers;
e&&(e.forEach(this._createLayerView,this),this._refreshCollections(),this._promisesMap.forEach(function(b,d){e.includes(d)||a._disposeLayerView(a._layerViewsMap.get(d),d)}),b.add(e.on("change",this.refresh),"collection-change"))}};c.prototype._refreshCollections=function(){var a=this;this.layersToLayerViews.forEach(function(b,d){a._populateLayerViewsOwners(a.get(d),a.get(b),a.view)})};c.prototype._populateLayerViewsOwners=function(a,b,d){var e=this;if(a&&b){var c=0;a.forEach(function(a){var h=e._layerViewsMap.get(a);
h&&(h.layer=a,h.parent=d,b.getItemAt(c)!==h&&b.splice(c,0,h),a.layers&&e._populateLayerViewsOwners(a.layers,h.layerViews,h),c+=1)});c<b.length&&b.splice(c,b.length)}else b&&b.removeAll()};c.prototype._createLayerView=function(a){var b=this,c=this.view,e=this.factory,f=this._layerViewsMap,g=this._promisesMap;f.has(a)?a.load():g.has(a)||(e=e.create(c,a).then(function(d){if(!b._map||!b._map.allLayers.some(function(b){return a===b}))throw new l("view:no-layerview-for-layer","The layer has been removed from the map",
{layer:a});f.set(a,d);b._refreshCollections();a.emit("layerview-create",{view:c,layerView:d});c.emit("layerview-create",{layer:a,layerView:d});return m.resolve(d)}),g.set(a,e),e.always(this.refresh))};c.prototype._disposeLayerView=function(a,b){if(this._promisesMap.has(b)&&(this._promisesMap.get(b).cancel(),this._promisesMap.delete(b),a)){b=a.layer;var c=a.view;this.factory.dispose(a);a.layer=a.parent=a.view=null;this._layerViewsMap.delete(b);b.emit("layerview-destroy",{view:c,layerView:a});c.emit("layerview-destroy",
{layer:b,layerView:a})}};return c}(g.declared(p));k([g.property()],f.prototype,"ready",void 0);k([g.property()],f.prototype,"view",void 0);return f=k([g.subclass("esri.views.LayerViewManager")],f)});